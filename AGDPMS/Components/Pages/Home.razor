@page "/"
@implements IDisposable

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using AGDPMS.Services

@attribute [Authorize]
@inject QrScanService QrScanService
@inject NavigationManager Nav
@inject CustomAuthenticationStateProvider AuthStateProvider

<PageTitle>Home</PageTitle>
<div class="container vh-100 d-flex flex-column justify-content-center align-items-center gap-4">
    <button class="btn btn-primary btn-lg px-5 py-4 fs-4" @onclick="OpenScanner">Quét QR để bắt đầu</button>
    @if (!string.IsNullOrWhiteSpace(scanResult))
    {
        <div class="mt-3 text-center">
            <h5>Kết quả quét QR:</h5>
            <p>@scanResult</p>
        </div>
    }
    <button class="btn btn-danger mt-4" @onclick="Logout">Logout</button>
</div>

@code {
    private string? scanResult;
    protected override void OnInitialized()
    {
        QrScanService.QrCodeScanned += OnQrCodeScanned;
    }

    private void OnQrCodeScanned(string value)
    {
        if (value.StartsWith("//") || !Uri.IsWellFormedUriString(value, UriKind.Relative)) return;
        scanResult = value;
        InvokeAsync(() => Nav.NavigateTo(value));
    }

    private async Task OpenScanner()
    {
        await Shell.Current.GoToAsync("//scanner");
    }

    private void Logout()
    {
        AuthStateProvider.Logout();
        Nav.NavigateTo("/login", replace: true);
    }

    public void Dispose()
    {
        QrScanService.QrCodeScanned -= OnQrCodeScanned;
    }
}