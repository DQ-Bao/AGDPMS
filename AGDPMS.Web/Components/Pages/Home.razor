@page "/"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using AGDPMS.Shared.Models
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="container-fluid py-3">
    <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
        <div>
            <label class="form-label">Từ ngày</label>
            <input type="date"
                   class="form-control"
                   value="@fromDateInput"
                   @onchange="OnFromDateChanged" />
        </div>
        <div>
            <label class="form-label">Đến ngày</label>
            <input type="date"
                   class="form-control"
                   value="@toDateInput"
                   @onchange="OnToDateChanged" />
        </div>
        <div style="min-width: 240px;">
            <label class="form-label">Dự án</label>
            <select class="form-select" @bind="selectedProjectId" @bind:after="OnFilterChanged">
                <option value="">Tất cả dự án</option>
                @foreach (var p in projectOptions)
                {
                    <option value="@p.Id">@p.Name</option>
                }
            </select>
        </div>
        <button class="btn btn-outline-secondary" @onclick="ResetFilters">Đặt lại</button>
    </div>

    @if (loading)
    {
        <div>Đang tải dashboard...</div>
    }
    else if (summary is null)
    {
        @* Show nothing for unauthorized users - completely empty page *@
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        <div class="row g-3 mb-3">
            <div class="col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="small text-muted">Tổng lệnh (loại trừ từ chối)</div>
                        <div class="fs-4 fw-bold">@summary.TotalOrders</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="small text-muted">Đang sản xuất</div>
                        <div class="fs-4 fw-bold text-primary">@summary.InProduction</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="small text-muted">Hoàn thành (trong kỳ)</div>
                        <div class="fs-4 fw-bold text-success">@summary.Finished</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="small text-muted">Thời gian chu kỳ TB (ngày)</div>
                        <div class="fs-4 fw-bold">@FormatNumber(summary.AvgCycleDays)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-lg-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-semibold">Phân bố trạng thái</div>
                    <div class="card-body">
                        <canvas id="statusChart" height="220"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-semibold">Đúng hạn vs Trễ</div>
                    <div class="card-body">
                        <canvas id="onTimeChart" height="220"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-semibold">Khối lượng QA</div>
                    <div class="card-body">
                        <canvas id="qaChart" height="143"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-semibold">Xu hướng bắt đầu / hoàn thành (theo tuần)</div>
                    <div class="card-body">
                        <canvas id="timelineChart" height="60"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-semibold">Lệnh gần đây</div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 320px;">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã</th>
                                        <th>Dự án</th>
                                        <th>Trạng thái</th>
                                        <th>Kế hoạch KT</th>
                                        <th>Bắt đầu</th>
                                        <th>Kết thúc</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (summary.RecentOrders == null || !summary.RecentOrders.Any())
                                    {
                                        <tr><td colspan="6" class="text-center text-muted py-3">Không có dữ liệu</td></tr>
                                    }
                                    else
                                    {
                                        @foreach (var o in summary.RecentOrders)
                                        {
                                            var lateClass = o.IsLate == true ? "text-danger" : "";
                                            <tr style="cursor:pointer;" @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))'>
                                                <td class="fw-semibold">@o.Code</td>
                                                <td>@(o.ProjectName ?? $"Dự án {o.ProjectId}")</td>
                                                <td>@o.Status</td>
                                                <td class="@lateClass">@FormatDate(o.PlannedFinishDate)</td>
                                                <td>@FormatDate(o.StartedAt)</td>
                                                <td>@FormatDate(o.FinishedAt)</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-semibold text-danger">Chú ý (trễ / gần hạn)</div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 320px;">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã</th>
                                        <th>Dự án</th>
                                        <th>Trạng thái</th>
                                        <th>Kế hoạch KT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (summary.RecentOrders == null || !summary.RecentOrders.Any())
                                    {
                                        <tr><td colspan="4" class="text-center text-muted py-3">Không có dữ liệu</td></tr>
                                    }
                                    else
                                    {
                                        @foreach (var o in summary.RecentOrders.Where(r => r.IsLate == true))
                                        {
                                            <tr style="cursor:pointer;" @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))'>
                                                <td class="fw-semibold text-danger">@o.Code</td>
                                                <td>@(o.ProjectName ?? $"Dự án {o.ProjectId}")</td>
                                                <td>@o.Status</td>
                                                <td class="text-danger">@FormatDate(o.PlannedFinishDate)</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.renderProductionDashboard = (cfg) => {
        const ensureDestroy = (id) => {
            const ctx = document.getElementById(id);
            if (!ctx) return null;
            if (ctx._chart) {
                ctx._chart.destroy();
            }
            return ctx;
        };

        // Status chart
        const statusCtx = ensureDestroy('statusChart');
        if (statusCtx && cfg.status) {
            statusCtx._chart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: cfg.status.labels,
                    datasets: [{
                        data: cfg.status.values,
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#0dcaf0', '#6c757d', '#6610f2']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        // On-time vs late
        const onTimeCtx = ensureDestroy('onTimeChart');
        if (onTimeCtx && cfg.onTime) {
            onTimeCtx._chart = new Chart(onTimeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Đúng hạn', 'Trễ'],
                    datasets: [{
                        data: [cfg.onTime.onTime, cfg.onTime.late],
                        backgroundColor: ['#198754', '#dc3545']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Timeline
        const tlCtx = ensureDestroy('timelineChart');
        if (tlCtx && cfg.timeline) {
            tlCtx._chart = new Chart(tlCtx, {
                type: 'line',
                data: {
                    labels: cfg.timeline.labels,
                    datasets: [
                        { label: 'Bắt đầu', data: cfg.timeline.started, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.2)', tension: 0.3 },
                        { label: 'Hoàn thành', data: cfg.timeline.finished, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.2)', tension: 0.3 }
                    ]
                },
                options: {
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, precision: 0 } }
                }
            });
        }

        // QA workload
        const qaCtx = ensureDestroy('qaChart');
        if (qaCtx && cfg.qa) {
            qaCtx._chart = new Chart(qaCtx, {
                type: 'bar',
                data: {
                    labels: cfg.qa.labels,
                    datasets: [
                        { label: 'KT máy', data: cfg.qa.machines, backgroundColor: '#0d6efd' },
                        { label: 'KT vật tư', data: cfg.qa.materials, backgroundColor: '#ffc107' },
                        { label: 'KT công đoạn', data: cfg.qa.stages, backgroundColor: '#198754' }
                    ]
                },
                options: {
                    plugins: { legend: { position: 'bottom' } },
                    responsive: true,
                    scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } }
                }
            });
        }
    };
</script>

@code {
    private DashboardSummary? summary;
    private bool loading = true;
    private string? errorMessage;

    private DateTime fromDate = DateTime.UtcNow.Date.AddDays(-29);
    private DateTime toDate = DateTime.UtcNow.Date;
    private string fromDateInput = string.Empty;
    private string toDateInput = string.Empty;
    private string? selectedProjectId;

    private List<ProjectOption> projectOptions = new();
    private List<QaWorkload> qaWorkloads = new();

    protected override async Task OnInitializedAsync()
    {
        fromDateInput = fromDate.ToString("yyyy-MM-dd");
        toDateInput = toDate.ToString("yyyy-MM-dd");
        await LoadProjects();
        await LoadSummary();
    }

    private async Task LoadProjects()
    {
        try
        {
            var projects = await Http.GetFromJsonAsync<List<ProjectOption>>("/api/lookup/projects");
            projectOptions = projects?.OrderByDescending(p => p.Id).Take(100).ToList() ?? new();
        }
        catch
        {
            projectOptions = new();
        }
    }

    private async Task LoadQaWorkload()
    {
        try
        {
            var qa = await Http.GetFromJsonAsync<List<QaWorkload>>("/api/lookup/qa-users?scope=order");
            qaWorkloads = qa ?? new();
        }
        catch
        {
            qaWorkloads = new();
        }
    }

    private async Task LoadSummary()
    {
        loading = true;
        errorMessage = null;
        try
        {
            var query = new List<string>
            {
                $"from={fromDate:yyyy-MM-dd}",
                $"to={toDate:yyyy-MM-dd}"
            };
            if (!string.IsNullOrWhiteSpace(selectedProjectId))
            {
                query.Add($"projectId={selectedProjectId}");
            }
            var url = "/api/orders/summary" + (query.Any() ? "?" + string.Join("&", query) : "");
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                summary = await response.Content.ReadFromJsonAsync<DashboardSummary>();
                await LoadQaWorkload();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized || response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                // User doesn't have permission - show nothing (summary stays null)
                summary = null;
            }
            else
            {
                // Other errors - show error message
                errorMessage = $"Không tải được dashboard: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            // Only show error if it's not an authorization issue
            if (!ex.Message.Contains("401") && !ex.Message.Contains("403") && !ex.Message.Contains("Unauthorized") && !ex.Message.Contains("Forbidden"))
            {
                errorMessage = $"Không tải được dashboard: {ex.Message}";
            }
            else
            {
                // Authorization issue - show nothing (summary stays null)
                summary = null;
            }
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task OnFromDateChanged(ChangeEventArgs e)
    {
        fromDateInput = e.Value?.ToString() ?? string.Empty;
        await OnFilterChanged();
    }

    private async Task OnToDateChanged(ChangeEventArgs e)
    {
        toDateInput = e.Value?.ToString() ?? string.Empty;
        await OnFilterChanged();
    }

    private async Task OnFilterChanged()
    {
        if (DateTime.TryParse(fromDateInput, out var fromParsed)) fromDate = fromParsed;
        if (DateTime.TryParse(toDateInput, out var toParsed)) toDate = toParsed;
        await LoadSummary();
    }

    private async Task RenderCharts()
    {
        if (summary is null)
        {
            return;
        }

        var statusLabels = new List<string>();
        var statusValues = new List<int>();
        if (summary.StatusCounts != null)
        {
            foreach (var kvp in summary.StatusCounts)
            {
                if (Enum.TryParse<ProductionOrderStatus>(kvp.Key, out var st))
                {
                    statusLabels.Add(GetStatusLabel(st));
                }
                else
                {
                    statusLabels.Add(kvp.Key);
                }
                statusValues.Add(kvp.Value);
            }
        }

        var timelineLabels = summary.Timeline?.Select(t => t.Week).ToList() ?? new List<string>();
        var timelineStarted = summary.Timeline?.Select(t => t.Started).ToList() ?? new List<int>();
        var timelineFinished = summary.Timeline?.Select(t => t.Finished).ToList() ?? new List<int>();

        var qaLabels = qaWorkloads.Select(q => q.Name ?? $"QA {q.Id}").ToList();
        var qaMachines = qaWorkloads.Select(q => q.PendingMachinesCount).ToList();
        var qaMaterials = qaWorkloads.Select(q => q.PendingMaterialCount).ToList();
        var qaStages = qaWorkloads.Select(q => q.PendingStagesCount).ToList();

        var cfg = new
        {
            status = new { labels = statusLabels, values = statusValues },
            onTime = new { onTime = summary.OnTimeLate?.OnTime ?? 0, late = summary.OnTimeLate?.Late ?? 0 },
            timeline = new { labels = timelineLabels, started = timelineStarted, finished = timelineFinished },
            qa = new { labels = qaLabels, machines = qaMachines, materials = qaMaterials, stages = qaStages }
        };

        await JS.InvokeVoidAsync("renderProductionDashboard", cfg);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Only render charts after DOM is ready and summary has data
        if (!loading && summary is not null)
        {
            await RenderCharts();
        }
    }

    private void ResetFilters()
    {
        fromDate = DateTime.UtcNow.Date.AddDays(-29);
        toDate = DateTime.UtcNow.Date;
        selectedProjectId = null;
        fromDateInput = fromDate.ToString("yyyy-MM-dd");
        toDateInput = toDate.ToString("yyyy-MM-dd");
        _ = LoadSummary();
    }

    private string FormatDate(DateTime? dt) => dt.HasValue ? dt.Value.ToLocalTime().ToString("dd/MM/yyyy") : "-";
    private string FormatNumber(double? v) => v.HasValue ? v.Value.ToString("0.0") : "-";

    private string GetStatusLabel(ProductionOrderStatus status) => status switch
    {
        ProductionOrderStatus.Draft => "Nháp",
        ProductionOrderStatus.PendingDirectorApproval => "Chờ giám đốc duyệt",
        ProductionOrderStatus.DirectorRejected => "Giám đốc từ chối",
        ProductionOrderStatus.PendingQACheckMachines => "Chờ QA kiểm tra máy",
        ProductionOrderStatus.PendingQACheckMaterial => "Chờ QA kiểm tra vật tư",
        ProductionOrderStatus.InProduction => "Đang sản xuất",
        ProductionOrderStatus.Finished => "Hoàn thành",
        ProductionOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    private class ProjectOption
    {
        public int Id { get; set; }
        public string? Name { get; set; }
    }

    private class DashboardSummary
    {
        public DateTime DateFrom { get; set; }
        public DateTime DateTo { get; set; }
        public int TotalOrders { get; set; }
        public int OpenOrders { get; set; }
        public int InProduction { get; set; }
        public int Finished { get; set; }
        public double? AvgCycleDays { get; set; }
        public Dictionary<string, int>? StatusCounts { get; set; }
        public OnTimeLateDto? OnTimeLate { get; set; }
        public List<TimelinePoint>? Timeline { get; set; }
        public List<RecentOrderDto>? RecentOrders { get; set; }
    }

    private class OnTimeLateDto
    {
        public int OnTime { get; set; }
        public int Late { get; set; }
    }

    private class TimelinePoint
    {
        public string Week { get; set; } = string.Empty;
        public int Started { get; set; }
        public int Finished { get; set; }
    }

    private class RecentOrderDto
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public int ProjectId { get; set; }
        public string? ProjectName { get; set; }
        public ProductionOrderStatus Status { get; set; }
        public DateTime? PlannedFinishDate { get; set; }
        public DateTime? StartedAt { get; set; }
        public DateTime? FinishedAt { get; set; }
        public bool? IsLate { get; set; }
    }

    private class QaWorkload
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public int PendingItemsCount { get; set; }
        public int PendingMachinesCount { get; set; }
        public int PendingMaterialCount { get; set; }
        public int PendingStagesCount { get; set; }
    }
}