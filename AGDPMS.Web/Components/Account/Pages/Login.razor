@page "/login"

@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authentication
@using Microsoft.Extensions.Caching.Memory
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using AGDPMS.Web.Data

@inject NavigationManager Nav
@inject UserDataAccess UserDataAccess
@inject IPasswordHasher<AppUser> PasswordHasher
@inject IMemoryCache Cache

<PageTitle>Login</PageTitle>

<h3>Login</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <div>@Message</div>
}

<EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
    <DataAnnotationsValidator />
    <hr />
    <ValidationSummary />
    <div>
        <label>Phone Number</label>
        <InputText @bind-Value="Input.PhoneNumber" />
    </div>
    <div>
        <label>Password</label>
        <InputText @bind-Value="Input.Password" Type="password" />
    </div>
    <a href="/forgot-password">Forgot password?</a>
    <button type="submit">Login</button>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private LoginModel Input { get; set; } = new();

    [CascadingParameter]
    public HttpContext HttpContext { get; set; } = default!;

    private string? Message = string.Empty;

    public async Task LoginUser(EditContext context)
    {
        var user = await UserDataAccess.GetByPhoneNumberAsync(Input.PhoneNumber);
        if (user is null)
        {
            Message = "Invalid phone or password";
            return;
        }

        if (PasswordHasher.VerifyHashedPassword(user, user.PasswordHash, Input.Password) != PasswordVerificationResult.Success)
        {
            Message = "Invalid phone or password";
            return;
        }

        var token = Guid.NewGuid().ToString("N");
        Cache.Set($"signin:{token}", user.Id, TimeSpan.FromMinutes(5));
        var returnUrl = user.NeedChangePassword ? "/need-change-password" : "/";
        var callbackUrl = $"/api/auth/callback?token={token}&returnUrl={Uri.EscapeDataString(returnUrl)}";
        Nav.NavigateTo(callbackUrl, forceLoad: true);
    }

    public class LoginModel
    {
        [Required]
        [Display(Name = "Phone Number")]
        public string PhoneNumber { get; set; } = string.Empty;

        [Required, DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = string.Empty;
    }
}