@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using AGDPMS.Web.Data
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Services

@inject UserDataAccess UserDataAccess
@inject IPasswordHasher<AppUser> PasswordHasher
@inject ISmsSender SmsSender


@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @messageCssClass alert-dismissible" role="alert">
        @Message
        <button type="button" class="btn-close" @onclick="() => Message = null" aria-label="Close"></button>
    </div>
}

<EditForm Model="Input" method="post" OnValidSubmit="HandleAddAccount" FormName="add-account">
    <DataAnnotationsValidator />
    <ValidationSummary class="alert alert-danger" />

    <div class="row">

        <div class="mb-3 col-md-6">
            <label class="form-label" for="Input.FullName">Họ và tên</label>
            <div class="input-group input-group-merge">
                <span class="input-group-text"><i class="bx bx-user"></i></span>
                <InputText @bind-Value="Input.FullName" id="Input.FullName" class="form-control" placeholder="Nguyễn Văn A" />
            </div>
        </div>

        <div class="mb-3 col-md-6">
            <label class="form-label" for="Input.PhoneNumber">Số điện thoại</label>
            <div class="input-group input-group-merge">
                <span class="input-group-text"><i class="bx bx-phone"></i></span>
                <InputText @bind-Value="Input.PhoneNumber" id="Input.PhoneNumber" class="form-control" placeholder="0912 345 678" />
            </div>
        </div>

        <div class="mb-3 col-md-6">
            <label class="form-label" for="Input.RoleId">Vai trò</label>
            <div class="input-group input-group-merge">
                <span class="input-group-text"><i class="bx bx-shield-quarter"></i></span>
                <InputSelect @bind-Value="Input.RoleId" id="Input.RoleId" class="form-select">
                    <option value="0">Chọn vai trò</option>
                    @foreach (var role in Roles)
                    {
                        <option value="@role.Id">@role.Name</option>
                    }
                </InputSelect>
            </div>
        </div>
    </div>

    <div class="mt-2">
        <button type="submit" class="btn btn-primary me-2">Tạo tài khoản</button>
        <button type="button" class="btn btn-outline-secondary" @onclick="() => OnCancel.InvokeAsync()">Hủy</button>
    </div>
</EditForm>

@code {
    [Parameter] public IEnumerable<AppRole> Roles { get; set; } = [];
    [Parameter] public EventCallback<AppUser> OnAccountAdded { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private string? Message;
    private string messageCssClass = "alert-info";

    private async Task HandleAddAccount()
    {
        var role = Roles.FirstOrDefault(r => r.Id == Input.RoleId);
        if (role is null)
        {
            Message = "Vai trò được chọn không hợp lệ";
            messageCssClass = "alert-danger";
            return;
        }

        var user = new AppUser
        {
            PhoneNumber = Input.PhoneNumber,
            FullName = Input.FullName,
            Role = role,
        };

        user.PasswordHash = PasswordHasher.HashPassword(user, "abc123");
        try
        {
            await UserDataAccess.CreateAsync(user);
            Message = "Thêm tài khoản thành công";
            messageCssClass = "alert-success";
            await SmsSender.SendAsync("Tài khoản đã được thêm. Mật khẩu mặc định: abc123", [user.PhoneNumber]);
            await OnAccountAdded.InvokeAsync(user);
            Input = new();
        }
        catch (Exception e)
        {
            Message = e.Message;
            messageCssClass = "alert-danger";
        }
    }

    private sealed class InputModel
    {
        [Required, Phone]
        public string PhoneNumber { get; set; } = string.Empty;

        [Required]
        public string FullName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Vui lòng chọn một vai trò.")]
        [Range(1, int.MaxValue, ErrorMessage = "Vui lòng chọn một vai trò hợp lệ.")]
        public int RoleId { get; set; }
    }
}