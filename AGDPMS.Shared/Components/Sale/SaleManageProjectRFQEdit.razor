@page "/sale/projectrfq/edit/{id:int}"
@rendermode InteractiveServer

@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Services 
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Sale")]
@inject NavigationManager NavManager
@inject ISaleServices SaleService
@inject IFileStorageService FileStorageService

<PageTitle>Chỉnh sửa dự án RFQ</PageTitle>

<h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">Quản lý / Dự án RFQ /</span> Chỉnh sửa</h4>

@if (project == null || customers == null) 
{
    <div class="p-3">Đang tải dự án...</div>
}
else
{
    <EditForm Model="@project" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <div class="card">
            <h5 class="card-header">Chỉnh sửa: @project.ProjectRFQName</h5>
            <div class="alert alert-warning m-3 mb-3" role="alert">
                <i class="bx bx-info-circle me-2"></i>
                <strong>Lưu ý:</strong> Trạng thái dự án được quản lý tự động theo quy trình và không thể thay đổi thủ công từ màn hình này.
            </div>
            <div class="card-body">

                 <div class="row">
                    <div class="mb-3 col-md-6">
                        <label for="projectName" class="form-label">Tên dự án</label>
                        <InputText id="projectName" class="form-control" @bind-Value="project.ProjectRFQName" />
                         <ValidationMessage For="@(() => project.ProjectRFQName)" />
                    </div>
                    <div class="mb-3 col-md-6">
                        <label for="location" class="form-label">Địa điểm</label>
                        <InputText id="location" class="form-control" @bind-Value="project.Location" />
                        <ValidationMessage For="@(() => project.Location)" />
                    </div>
                </div>

                <div class="row">
                    <div class="mb-3 col-md-6">
                        <label for="clientId" class="form-label">Khách hàng</label>
                        <InputSelect id="clientId" class="form-select" @bind-Value="project.ClientId">
                            <option value="0">-- Chọn khách hàng --</option>
                            @foreach (var customer in customers)
                            {
                                <option value="@customer.Id">@customer.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => project.ClientId)" />
                    </div>
                    <div class="mb-3 col-md-6">
                        <label for="designCompany" class="form-label">Công ty thiết kế</label>
                        <InputText id="designCompany" class="form-control" @bind-Value="project.DesignCompany" />
                    </div>
                </div>

                <div class="row">
                    <div class="mb-3 col-md-6">
                        <label for="completionDate" class="form-label">Ngày hoàn thành</label>
                        <InputDate id="completionDate" class="form-control" @bind-Value="project.CompletionDate" />
                         <ValidationMessage For="@(() => project.CompletionDate)" />
                    </div>
                    <div class="mb-3 col-md-6">
                        <label for="status" class="form-label">Trạng thái</label>
                        <div class="input-group">
                            <span class="badge @GetStatusClass(project.Status) form-control d-flex align-items-center" style="font-size: 1rem; height: 38px;">
                                @GetVietnameseStatus(project.Status)
                            </span>
                        </div>
                        <small class="form-text text-muted">Trạng thái được quản lý tự động theo quy trình dự án</small>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="designFile" class="form-label">File thiết kế (PDF, DOCX, JPG, PNG - Tối đa 100MB)</label>
                    <InputFile id="designFile" class="form-control" OnChange="HandleDesignFileSelected" accept=".pdf,.docx,.jpg,.jpeg,.png" />
                    @if (isUploadingDesignFile)
                    {
                        <div class="mt-2 small text-info">
                            <i class="bx bx-loader bx-spin"></i> Đang tải lên...
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(newDesignFilePath))
                    {
                        <div class="mt-2 small text-success">
                            <i class="bx bx-check"></i> Đã tải lên: @Path.GetFileName(newDesignFilePath)
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(project.DesignFilePath))
                    {
                        <div class="mt-2">
                             <i class="bx bx-file me-1"></i> File hiện tại: 
                             <a href="@project.DesignFilePath" target="_blank">@Path.GetFileName(project.DesignFilePath)</a> 
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(designFileError))
                    {
                        <div class="text-danger small mt-1">@designFileError</div>
                    }
                </div>

                <div class="mb-3">
                    <label for="document" class="form-label">Tài liệu (PDF, DOCX, JPG, PNG - Tối đa 100MB)</label>
                    <InputFile id="document" class="form-control" OnChange="HandleDocumentSelected" accept=".pdf,.docx,.jpg,.jpeg,.png" />
                    @if (isUploadingDocument)
                    {
                        <div class="mt-2 small text-info">
                            <i class="bx bx-loader bx-spin"></i> Đang tải lên...
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(newDocumentPath))
                    {
                        <div class="mt-2 small text-success">
                            <i class="bx bx-check"></i> Đã tải lên: @Path.GetFileName(newDocumentPath)
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(project.DocumentPath))
                    {
                         <div class="mt-2">
                             <i class="bx bx-file me-1"></i> File hiện tại: 
                             <a href="@project.DocumentPath" target="_blank">@Path.GetFileName(project.DocumentPath)</a> 
                         </div>
                    }
                    @if (!string.IsNullOrEmpty(documentFileError))
                    {
                        <div class="text-danger small mt-1">@documentFileError</div>
                    }
                </div>


            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-primary me-2">Cập nhật</button>
                <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">Hủy</button>
            </div>
        </div>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private AppRFQ? project; 
    private List<AppClient>? customers; 

    private string? designFileError;
    private string? documentFileError;
    private bool isUploadingDesignFile = false;
    private bool isUploadingDocument = false;
    private string? oldDesignFilePath;
    private string? oldDocumentPath;
    private string? newDesignFilePath; // Store newly uploaded design file path
    private string? newDocumentPath; // Store newly uploaded document path

    private readonly string[] allowedExtensions = new[] { ".pdf", ".docx", ".jpg", ".png", ".jpeg" };
    private long maxFileSize = 100 * 1024 * 1024; // 100MB

    private bool _isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        if (_isInitialized) return; // Prevent re-initialization
        
        _isInitialized = true;
        
        project = await SaleService.GetProjectRFQByIdAsync(Id);
        customers = (await SaleService.GetClientsAsync()).ToList();

        if (project == null)
        {
            NavManager.NavigateTo("/projects", forceLoad: true); 
        }
        else
        {
            // Store original file paths for cleanup
            oldDesignFilePath = project.DesignFilePath;
            oldDocumentPath = project.DocumentPath;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only reload if the ID actually changed and we haven't initialized yet
        if (!_isInitialized)
        {
            await OnInitializedAsync();
        }
    }

    private async Task HandleDesignFileSelected(InputFileChangeEventArgs e)
    {
        if (project == null) return;
        
        // Prevent multiple simultaneous uploads
        if (isUploadingDesignFile) return;

        isUploadingDesignFile = true;
        designFileError = null;
        await InvokeAsync(StateHasChanged); // Use InvokeAsync for thread safety

        try
        {
            var file = e.File;
            if (file == null)
            {
                designFileError = "Không có file được chọn.";
                return;
            }

            Console.WriteLine($"Bắt đầu upload design file: {file.Name}, Size: {file.Size} bytes");
            // Save the new file
            var savedPath = await FileStorageService.SaveFileAsync(
                file, "designs", allowedExtensions, maxFileSize);

            Console.WriteLine($"Design file đã được lưu thành công: {savedPath}");
            // Store the new file path (don't update project yet to prevent reverting)
            newDesignFilePath = savedPath;
            designFileError = null;
        }
        catch (Exception ex)
        {
            designFileError = ex.Message;
            newDesignFilePath = null; // Clear on error
            Console.WriteLine($"Error uploading design file: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isUploadingDesignFile = false;
            await InvokeAsync(StateHasChanged); // Use InvokeAsync for thread safety
        }
    }

    private async Task HandleDocumentSelected(InputFileChangeEventArgs e)
    {
        if (project == null) return;
        
        // Prevent multiple simultaneous uploads
        if (isUploadingDocument) return;

        isUploadingDocument = true;
        documentFileError = null;
        await InvokeAsync(StateHasChanged); // Use InvokeAsync for thread safety

        try
        {
            var file = e.File;
            if (file == null)
            {
                documentFileError = "Không có file được chọn.";
                return;
            }

            Console.WriteLine($"Bắt đầu upload document file: {file.Name}, Size: {file.Size} bytes");
            // Save the new file
            var savedPath = await FileStorageService.SaveFileAsync(
                file, "documents", allowedExtensions, maxFileSize);

            Console.WriteLine($"Document file đã được lưu thành công: {savedPath}");
            // Store the new file path (don't update project yet to prevent reverting)
            newDocumentPath = savedPath;
            documentFileError = null;
        }
        catch (Exception ex)
        {
            documentFileError = ex.Message;
            newDocumentPath = null; // Clear on error
            Console.WriteLine($"Error uploading document file: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isUploadingDocument = false;
            await InvokeAsync(StateHasChanged); // Use InvokeAsync for thread safety
        }
    }

    private async Task HandleSubmit()
    {
         if (project == null) return; 

        if (project.ClientId == 0)
        {
             Console.WriteLine("Client selection is required.");
             return;
        }

        // Check for file upload errors
        if (!string.IsNullOrEmpty(designFileError) || !string.IsNullOrEmpty(documentFileError))
        {
            Console.WriteLine("Vui lòng sửa lỗi tải file trước khi lưu.");
            return;
        }

        try
        {
            // Update file paths if new files were uploaded
            if (!string.IsNullOrEmpty(newDesignFilePath))
            {
                // Delete old file if it exists and is different
                if (!string.IsNullOrEmpty(oldDesignFilePath) && 
                    oldDesignFilePath != newDesignFilePath && 
                    oldDesignFilePath.StartsWith("/uploads/"))
                {
                    await FileStorageService.DeleteFileAsync(oldDesignFilePath);
                }
                project.DesignFilePath = newDesignFilePath;
            }

            if (!string.IsNullOrEmpty(newDocumentPath))
            {
                // Delete old file if it exists and is different
                if (!string.IsNullOrEmpty(oldDocumentPath) && 
                    oldDocumentPath != newDocumentPath && 
                    oldDocumentPath.StartsWith("/uploads/"))
                {
                    await FileStorageService.DeleteFileAsync(oldDocumentPath);
                }
                project.DocumentPath = newDocumentPath;
            }

            // The UpdateProjectRFQAsync service method should only use project.ClientId
            await SaleService.UpdateProjectRFQAsync(project); 
            Console.WriteLine($"Đã cập nhật dự án: {project.ProjectRFQName}");
            GoBack();
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error updating project: {ex.Message}");
        }
    }

    private void GoBack()
    {
        NavManager.NavigateTo("/projects");
    }
    private string GetVietnameseStatus(ProjectRFQStatus status)
    {
        return status switch
        {
            ProjectRFQStatus.Planning => "Chờ phê duyệt",
            ProjectRFQStatus.Production => "Đang sản xuất",
            ProjectRFQStatus.Deploying => "Đang lắp đặt",
            ProjectRFQStatus.Completed => "Đã hoàn thành",
            ProjectRFQStatus.Cancelled => "Đã hủy",
            _ => status.ToString()
        };
    }

    private string GetStatusClass(ProjectRFQStatus status)
    {
        return status switch
        {
            ProjectRFQStatus.Planning => "bg-primary text-white",
            ProjectRFQStatus.Production => "bg-warning text-dark",
            ProjectRFQStatus.Deploying => "bg-info text-white",
            ProjectRFQStatus.Completed => "bg-success text-white",
            ProjectRFQStatus.Cancelled => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }

}

