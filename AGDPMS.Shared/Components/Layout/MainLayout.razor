@inherits LayoutComponentBase
@implements IDisposable

@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Services

@inject NavigationManager Nav
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider

<div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="offcanvasSidebar">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">
            <img src="_content/AGDPMS.Shared/images/logo.png" alt="AGDPMS Icon" class="rounded-circle me-2" width="32" height="32">
            <span class="fw-bold brand-text ms-2">AGDPMS</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-2">
        <ul class="nav nav-pills flex-column mb-auto">
            <AuthorizeView Roles="Director,Production Manager">
                <li class="nav-item">
                    <NavLink href="/" Match="NavLinkMatch.All" class="nav-link text-white"><i class="bi bi-speedometer2 me-2"></i>Báo cáo</NavLink>
                </li>
            </AuthorizeView>
            <li class="nav-item">
                <NavLink href="/projects" class="nav-link text-white"><i class="bi bi-list-task me-2"></i>Projects</NavLink>
            </li>
            <AuthorizeView Roles="Director,QA,Production Manager">
                <li class="nav-item">
                    <NavLink href="/production/orders" class="nav-link text-white"><i class="bi bi-gear me-2"></i>Production Orders</NavLink>
                </li>
            </AuthorizeView>
            <AuthorizeView Roles="Production Manager">
                <li class="nav-item">
                    <NavLink href="/print/stamp-manager" class="nav-link text-white"><i class="bi bi-printer me-2"></i>In tem bảo hành</NavLink>
                </li>
            </AuthorizeView>
        </ul>
    </div>
</div>

<aside class="bg-dark text-white position-fixed d-none d-md-flex flex-column p-2 @(sidebarCollapsed ? "collapsed" : "")" id="sidebar">
    <div class="d-flex align-items-center mb-3">
        <img src="_content/AGDPMS.Shared/images/logo.png" alt="AGDPMS Icon" class="rounded-circle ms-2" width="32" height="32">
        <span class="fs-5 fw-bold ms-2 brand-text">AGDPMS</span>
    </div>
    <hr class="text-secondary" />
    <ul class="nav nav-pills flex-column mb-auto">
        <AuthorizeView Roles="Director,Production Manager">
            <li class="nav-item">
                <NavLink href="/" Match="NavLinkMatch.All" class="nav-link text-white">
                    <i class="bi bi-speedometer2 me-2"></i>
                    <span>Báo cáo</span>
                </NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="Director">
            <li class="nav-item">
                <NavLink href="/accounts" Match="NavLinkMatch.All" class="nav-link text-white">
                    <i class="bi bi-person me-2"></i>
                    <span>Tài khoản</span>
                </NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="Director,Sale">
            <li class="nav-item">
                <NavLink href="/sale/customercontact" class="nav-link text-white">
                    <i class="bi bi-layers me-2"></i>
                    <span>Khách hàng</span>
                </NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="Director,Sale,Technician">
            <li class="nav-item">
                <NavLink href="/projects" class="nav-link text-white">
                    <i class="bi bi-list-task me-2"></i>
                    <span>Công trình</span>
                </NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="Director,QA,Production Manager">
            <li class="nav-item">
                <NavLink href="/production/orders" class="nav-link text-white">
                    <i class="bi bi-gear me-2"></i>
                    <span>Lệnh sản xuất</span>
                </NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="Production Manager">
            <li class="nav-item">
                <NavLink href="/print/stamp-manager" class="nav-link text-white"><i class="bi bi-printer me-2"></i><span>In tem bảo hành</span></NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="Director,QA,Production Manager">
            <li class="nav-item">
                <NavLink href="/qa/machines" class="nav-link text-white">
                    <i class="bi bi-layers me-2"></i>
                    <span>Máy móc</span>
                </NavLink>
            </li>
        </AuthorizeView>
        <AuthorizeView Roles="InventoryManager">
            <li class="nav-item">
                <a class="nav-link text-white" data-bs-toggle="collapse" href="#inventory-menu" role="button">
                    <i class="bi bi-list-task me-2"></i><span>Kho</span> <i class="bi bi-chevron-down small brand-text"></i>
                </a>
                <div class="collapse" id="inventory-menu">
                    <ul class="nav flex-column ps-4 small">
                        <li class="nav-item"><NavLink href="/inventory/stocks" class="nav-link text-white"><span>Tồn kho</span></NavLink></li>
                        <li class="nav-item"><NavLink href="/inventory/issues" class="nav-link text-white"><span>Xuất kho</span></NavLink></li>
                        <li class="nav-item"><NavLink href="/inventory/receipts" class="nav-link text-white"><span>Nhập kho</span></NavLink></li>
                    </ul>
                </div>
            </li>
        </AuthorizeView>
    </ul>
</aside>

<div id="content">
    <nav class="navbar navbar-light bg-white shadow-sm px-3">
        <button class="btn d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
            <i class="bi bi-list fs-4"></i>
        </button>
        <button class="btn d-none d-md-inline" @onclick="ToggleSidebar">
            <i class="bi bi-list fs-4"></i>
        </button>

        <span class="navbar-brand mb-0 h5 ms-3">@GetTitle()</span>

        <div class="ms-auto d-flex align-items-center gap-2">

            <div class="dropdown">
                <button class="btn shadow-none position-relative" type="button" id="dropdownBell" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bell fs-5"></i>
                    @if (unreadCount > 0)
                    {
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            @unreadCount
                            <span class="visually-hidden">unread notifications</span>
                        </span>
                    }
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownBell" style="min-width: 320px;">
                    <li><h6 class="dropdown-header fw-bold">Thông báo</h6></li>
                    @if (notifications.Any())
                    {
                        @foreach (var notification in notifications.Take(10)) // Giới hạn hiển thị
                        {
                            <li>
                                <a class="@GetNotificationItemClass(notification)"
                                   href="@notification.Url"
                                   @onclick="() => MarkAsRead(notification)">
                                    <div class="d-flex flex-column">
                                        <div class="small @(notification.IsRead ? "text-muted" : "fw-semibold text-dark") mb-1">
                                            @notification.Message
                                        </div>
                                        <div class="small text-muted">
                                            @notification.Timestamp.ToString("g")
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider my-1" /></li>
                        }
                    }
                    else
                    {
                        <li><span class="dropdown-item text-muted text-center small py-3">Không có thông báo</span></li>
                    }
                    <li><a class="dropdown-item text-center text-primary fw-semibold" href="/notifications">Xem tất cả</a></li>
                </ul>
            </div>

            <AuthorizeView>
                <Authorized>
                    <div class="dropdown">
                        <a class="d-flex align-items-center text-decoration-none text-dark dropdown-toggle"
                           href="#" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                            <strong>@GetUsername(context.User)</strong>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownUser">
                            <li><a class="dropdown-item" href="/profile">Profile</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item text-danger" href="/logout">Logout</a></li>
                        </ul>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <a class="btn btn-outline-primary" href="/login">Login</a>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </nav>
    <div class="container-fluid mt-4">
        @Body
    </div>
</div>

@code {
    private bool sidebarCollapsed = false;

    private int unreadCount { get; set; } = 0;
    private List<Notification> notifications { get; set; } = [];

    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        NotificationService.OnNotificationReceived += HandleNotificationReceived;
        await NotificationService.StartAsync();
        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        var result = await NotificationService.GetNotificationsAsync();
        if (result.Success)
        {
            notifications = result.Notifications.OrderByDescending(n => n.Timestamp).ToList();
            unreadCount = notifications.Count(n => !n.IsRead);
        }
    }

    private async Task HandleNotificationReceived(Notification notification)
    {
        notifications.Add(notification);
        if (!notification.IsRead) unreadCount++;
        await InvokeAsync(StateHasChanged);
    }

    private string GetNotificationItemClass(Notification notification)
    {
        var baseClass = "dropdown-item py-2";
        return notification.IsRead ? $"{baseClass} read-notification" : $"{baseClass} unread-notification";
    }

    private async Task MarkAsRead(Notification notification)
    {
        if (!notification.IsRead)
        {
            await NotificationService.MarkAsReadAsync(notification.Id);
            notification.IsRead = true;
            unreadCount--;
        }
    }

    public void Dispose()
    {
        NotificationService.OnNotificationReceived -= HandleNotificationReceived;
        NotificationService.DisposeAsync();
    }

    private string GetTitle()
    {
        var uri = Nav.Uri;
        if (uri.Contains("/sale/projectrfq")) return "Quản lý Công trình";
        if (uri.Contains("/sale/customercontact")) return "Quản lý Khách hàng";
        if (uri.Contains("/qa/machines")) return "Quản lý Máy móc";
        if (uri.Contains("/inventory/stocks")) return "Quản lý tồn kho";
        if (uri.Contains("/inventory/receipts")) return "Quản lý nhập kho";
        if (uri.Contains("/inventory/issues")) return "Quản lý xuất kho";
        if (Nav.Uri.Contains("/profile")) return "Tài khoản";
        if (Nav.Uri.Contains("/projects")) return "Công trình";
        if (Nav.Uri.Contains("/production/orders")) return "Lệnh sản xuất";
        return "Trang chủ";
    }

    private void ToggleSidebar() => sidebarCollapsed = !sidebarCollapsed;
    private string GetUsername(ClaimsPrincipal principal) => principal.FindFirst("FullName")?.Value ?? principal.FindFirst("unique_name")?.Value ?? "Guest";
}