@attribute [CascadingTypeParameter(nameof(TItem))]
@attribute [CascadingTypeParameter(nameof(TEdit))]
@typeparam TItem
@typeparam TEdit

<CascadingValue Value="this">
    @if (SearchBy is not null || FilterBy is not null)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            @if (SearchBy is not null)
            {
                <input type="text" class="form-control w-50" placeholder="@SearchPlaceholder" value="@SearchText" @oninput="OnSearchChanged" />
            }
            @if (FilterBy is not null)
            {
                <select class="form-select w-auto" @onchange="OnFilterChanged">
                    <option value="">Tất cả</option>
                    @if (FilterOptions is not null)
                    {
                        foreach (var option in FilterOptions)
                        {
                            <option value="@option.Value" selected="@(option.Value == SelectedFilterValue)">
                                @option.Label
                            </option>
                        }
                    }
                </select>
            }
        </div>
    }
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                @foreach (var col in Columns)
                {
                    <th>@col.Header</th>
                }
                @if (EnableEditing || ActionTemplate is not null)
                {
                    <th>Thao tác</th>
                }
            </tr>
        </thead>
        <tbody>
            @if (PagedItems.Any())
            {
                foreach (var (item, i) in PagedItems.Select((i, idx) => (i, idx)))
                {
                    var index = i + 1 + (CurrentPage - 1) * PageSize;
                    bool isEditing = EditingItem != null && EqualityComparer<TItem>.Default.Equals(item, EditingItem);
                    <tr>
                        <td>@index</td>
                        @if (isEditing && EditingModel is not null && CurrentEditContext is not null)
                        {
                            <CascadingValue Value="CurrentEditContext">
                                <DataAnnotationsValidator />
                                @foreach (var col in Columns)
                                {
                                    if (col.EditTemplate is not null)
                                    {
                                        @col.EditTemplate(EditingModel)
                                    }
                                    else
                                    {
                                        @col.CellTemplate(item)
                                    }
                                }
                                <td>
                                    <button type="button" @onclick="CancelEdit" class="btn btn-secondary me-1">Hủy</button>
                                    <button type="button" @onclick="SaveEdit" class="btn btn-success">Lưu</button>
                                </td>
                            </CascadingValue>
                        }
                        else
                        {
                            foreach (var col in Columns)
                            {
                                @col.CellTemplate(item)
                            }
                            @if (EnableEditing || ActionTemplate is not null)
                            {
                                <td>
                                    @if (EnableEditing)
                                    {
                                        <button class="btn btn-primary me-1" @onclick="() => EditRow(item)">Sửa</button>
                                    }
                                    @ActionTemplate?.Invoke(item)
                                </td>
                            }
                        }
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="99" class="text-center text-muted">Không có dữ liệu</td>
                </tr>
            }
        </tbody>
    </table>
    @if (EnablePagination)
    {
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="PrevPage">Trước</button>
                </li>

                @for (int i = 1; i <= TotalPages; i++)
                {
                    int page = i;
                    <li class="page-item @(page == CurrentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => GoToPage(page)">@(page)</button>
                    </li>
                }

                <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="NextPage">Sau</button>
                </li>
            </ul>
        </nav>
    }
    @DataTemplate
</CascadingValue>

@code {
    [Parameter] public IEnumerable<TItem> Items { get; set; } = Enumerable.Empty<TItem>();
    [Parameter] public RenderFragment? DataTemplate { get; set; }
    [Parameter] public RenderFragment<TItem>? ActionTemplate { get; set; }

    [Parameter] public Func<TItem, string>? FilterBy { get; set; }
    [Parameter] public IEnumerable<(string Value, string Label)>? FilterOptions { get; set; }

    [Parameter] public Func<TItem, string>? SearchBy { get; set; }
    [Parameter] public string SearchPlaceholder { get; set; } = "Tìm kiếm...";

    [Parameter] public bool EnablePagination { get; set; } = true;
    [Parameter] public int PageSize { get; set; } = 10;

    [Parameter] public bool EnableEditing { get; set; } = false;
    [Parameter] public Func<TItem, TEdit>? EditModelFactory { get; set; }
    public delegate Task ItemSavedHandler<TE, TI>(TEdit edit, TItem item);
    [Parameter] public ItemSavedHandler<TEdit, TItem>? OnItemSaved { get; set; }

    public List<ColumnDefinition<TItem, TEdit>> Columns { get; set; } = [];

    private string SearchText { get; set; } = string.Empty;
    private string? SelectedFilterValue { get; set; }
    private List<TItem> PagedItems { get; set; } = [];
    private int CurrentPage = 1;
    private int TotalPages = 1;

    private TItem? EditingItem { get; set; }
    private TEdit? EditingModel { get; set; }
    private EditContext? CurrentEditContext { get; set; }

    protected override void OnParametersSet()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var q = Items.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(SearchText) && SearchBy != null)
            q = q.Where(i => SearchBy(i)?.Contains(SearchText, StringComparison.OrdinalIgnoreCase) == true);

        if (!string.IsNullOrEmpty(SelectedFilterValue) && FilterBy != null)
            q = q.Where(i => FilterBy(i) == SelectedFilterValue);

        var filtered = q.ToList();

        TotalPages = EnablePagination ? Math.Max(1, (filtered.Count + PageSize - 1) / PageSize) : 1;
        if (EnablePagination)
        {
            CurrentPage = Math.Clamp(CurrentPage, 1, TotalPages);
            PagedItems = filtered.Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToList();
        }
        else
        {
            CurrentPage = 1;
            PagedItems = filtered;
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        SearchText = e.Value?.ToString() ?? string.Empty;
        CurrentPage = 1;
        ApplyFilters();
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        SelectedFilterValue = e.Value?.ToString();
        CurrentPage = 1;
        ApplyFilters();
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            ApplyFilters();
        }
    }

    private void PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            ApplyFilters();
        }
    }

    private void GoToPage(int page)
    {
        CurrentPage = Math.Clamp(page, 1, TotalPages);
        ApplyFilters();
    }

    private void EditRow(TItem item)
    {
        if (EditModelFactory is null) throw new InvalidOperationException("EditModelFactory must be provided to enable editing.");
        EditingItem = item;
        EditingModel = EditModelFactory(item);
        CurrentEditContext = new EditContext(EditingModel!);
    }

    private void CancelEdit()
    {
        EditingItem = default;
        EditingModel = default;
        CurrentEditContext = default;
    }

    private async Task SaveEdit()
    {
        if (EditingItem is null || EditingModel is null || CurrentEditContext is null) return;
        if (!CurrentEditContext.Validate()) return;

        if (OnItemSaved is not null)
            await OnItemSaved.Invoke(EditingModel, EditingItem);
        EditingItem = default;
        EditingModel = default;
        CurrentEditContext = default;
        ApplyFilters();
    }

    public class ColumnDefinition<TI, TE>
    {
        public string Header { get; set; } = string.Empty;
        public required RenderFragment<TI> CellTemplate { get; set; }
        public RenderFragment<TE>? EditTemplate { get; set; }
    }
}
