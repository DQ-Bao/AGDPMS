@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Linq
@using AGDPMS.Shared.Models
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider

<div>
    @if (stages is null)
    {
        <div>Đang tải giai đoạn...</div>
    }
    else if (!stages.Any())
    {
        <div>Không có giai đoạn</div>
    }
    else
    {
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Giai đoạn</th><th>QA phụ trách</th><th>Trạng thái</th><th>Số lần từ chối</th><th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in stages)
                    {
                        var isPendingQa = s.AssignedQaUserId.HasValue && !s.IsCompleted;
                        <tr>
                            <td>@s.StageName</td>
                            <td>@(s.AssignedQaUserName ?? "Chưa phân công")</td>
                            <td>@GetStageStatus(s)</td>
                            <td>@s.RejectionCount</td>
                            <td class="text-nowrap">
                                @if (ShouldShowButton("AssignQa", s))
                                {
                                    <button class="btn btn-outline-secondary btn-sm" @onclick='@(async () => await OpenQaSelector(s.Id))'>Giao QA</button>
                                }
                                @if (ShouldShowButton("Approve", s))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => Approve(s.Id))'>Duyệt</button>
                                }
                                @if (ShouldShowButton("Reject", s))
                                {
                                    <button class="btn btn-outline-danger btn-sm" @onclick='@(() => OpenRejectModal(s.Id))'>Từ chối</button>
                                }
                                @if (ShouldShowButton("Cancel", s))
                                {
                                    <button class="btn btn-outline-warning btn-sm" @onclick='@(() => Cancel(s.Id))'>Hủy giai đoạn</button>
                                }
                                @if (s.RejectionCount > 0 && !s.IsCompleted && (IsProductionManager() || IsQa()))
                                {
                                    <button class="btn btn-outline-info btn-sm" @onclick='@(() => ViewRejectReason(s.Id))'>Xem lý do từ chối</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
         @if (IsProductionManager() && OrderStatus == ProductionOrderStatus.InProduction)
        {
            <div>
                <button class="btn btn-sm btn-outline-primary" @onclick="OpenStageModal">Thêm giai đoạn</button>
            </div>
        }
    }
</div>

@* QA Selection Modal *@
@if (showQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chọn nhân viên QA</h5>
                    <button type="button" class="btn-close" @onclick="CloseQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            @foreach (var qa in qaUsers)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick='@(() => SelectQa(qa.Id))'>
                                    <div><strong>@qa.Name</strong></div>
                                    <small class="text-muted">@qa.Phone</small>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* View Reject Reason Modal *@
@if (showViewRejectReasonModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lý do từ chối</h5>
                    <button type="button" class="btn-close" @onclick="CloseViewRejectReasonModal"></button>
                </div>
                <div class="modal-body">
                    @if (viewingRejectReason is null)
                    {
                        <div>Đang tải...</div>
                    }
                    else if (isEditingRejectReason)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold">Lý do từ chối:</label>
                            <textarea class="form-control" rows="4" @bind="editingRejectReasonText"></textarea>
                        </div>
                        @if (viewingRejectReason.CreatedAt.HasValue)
                        {
                            <div class="text-muted small mb-3">
                                Thời gian: @viewingRejectReason.CreatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>
                        }
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold">Lý do từ chối:</label>
                            <div class="p-3 bg-light rounded">@viewingRejectReason.Reason</div>
                        </div>
                        @if (viewingRejectReason.CreatedAt.HasValue)
                        {
                            <div class="text-muted small">
                                Thời gian: @viewingRejectReason.CreatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    @if (isEditingRejectReason)
                    {
                        <button type="button" class="btn btn-secondary" @onclick="CancelEditRejectReason">Hủy</button>
                        <button type="button" class="btn btn-primary" disabled="@(!CanSaveRejectReason)" @onclick="SaveRejectReason">Lưu</button>
                    }
                    else
                    {
                        @if (canEditRejectReason)
                        {
                            <button type="button" class="btn btn-outline-primary" @onclick="StartEditRejectReason">Chỉnh sửa</button>
                        }
                        <button type="button" class="btn btn-secondary" @onclick="CloseViewRejectReasonModal">Đóng</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Reject Reason Modal *@
@if (showRejectModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Từ chối giai đoạn</h5>
                    <button type="button" class="btn-close" @onclick="CloseRejectModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Lý do từ chối <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="4" placeholder="Nhập lý do từ chối..." @bind="rejectReason"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRejectModal">Hủy</button>
                    <button type="button" class="btn btn-danger" disabled="@(!CanConfirmReject)" @onclick="ConfirmReject">Xác nhận từ chối</button>
                </div>
            </div>
        </div>
    </div>
}

@* Stage Type Selection Modal *@
@if (showStageTypeModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm giai đoạn</h5>
                    <button type="button" class="btn-close" @onclick="CloseStageModal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(showCreateCustomStage ? "" : "active")" @onclick='@(() => { showCreateCustomStage = false; StateHasChanged(); })'>Chọn giai đoạn</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(showCreateCustomStage ? "active" : "")" @onclick='@(() => { showCreateCustomStage = true; StateHasChanged(); })'>Tạo giai đoạn mới</button>
                        </li>
                    </ul>
                    @if (!showCreateCustomStage)
                    {
                        <input class="form-control mb-2" placeholder="Tìm giai đoạn..." @bind-value="stageTypeSearch" @bind-value:event="oninput" />
                        <div class="list-group" style="max-height:300px; overflow:auto;">
                            @if (stageTypes is null)
                            {
                                <div>Đang tải...</div>
                            }
                            else
                            {
                                var options = GetAvailableStageTypes().ToList();
                                if (!options.Any())
                                {
                                    <div>Không còn giai đoạn khả dụng.</div>
                                }
                                else
                                {
                                    @foreach (var st in options)
                                    {
                                        <button type="button" class="list-group-item list-group-item-action" @onclick='@(() => SelectStageType(st.Id))'>
                                            <div><strong>@st.Name</strong></div>
                                            <small class="text-muted">Mã: @st.Code</small>
                                        </button>
                                    }
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label">Tên giai đoạn <span class="text-danger">*</span></label>
                            <input class="form-control" placeholder="Nhập tên giai đoạn" @bind="customStageName" />
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" disabled="@(!CanCreateCustomStage)" @onclick="CreateCustomStage">Tạo và thêm</button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseStageModal">Hủy</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ItemId { get; set; }
    [Parameter] public ProductionOrderStatus OrderStatus { get; set; }
    [Parameter] public EventCallback OnChanged { get; set; }

    private List<StageVm>? stages;
    private string? userRole;
    private bool showQaModal = false;
    private int? selectedStageIdForQa;
    private List<QaUser>? qaUsers;
    private string? qaSearch;
    private string? errorMessage;
    private bool showStageTypeModal = false;
    private List<StageTypeVm>? stageTypes;
    private string? stageTypeSearch;
    private bool showCreateCustomStage = false;
    private string customStageName = string.Empty;
    private bool showRejectModal = false;
    private int? selectedStageIdForReject;
    private string rejectReason = string.Empty;
    private bool showViewRejectReasonModal = false;
    private RejectReasonVm? viewingRejectReason;
    private bool isEditingRejectReason = false;
    private string editingRejectReasonText = string.Empty;
    private bool canEditRejectReason = false;
    private int? currentUserId;

    protected override async Task OnParametersSetAsync()
    {
        await LoadUserRole();
        await Load();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task Load()
    {
        errorMessage = null;
        // stages come from order details; for simplicity reload the order and filter
        var orderId = await Http.GetFromJsonAsync<int>($"/api/items/{ItemId}/order-id");
        if (orderId == 0) { stages = new(); return; }
        var detail = await Http.GetFromJsonAsync<DetailResp>($"/api/orders/{orderId}");
        var item = detail?.items?.FirstOrDefault(i => i.Id == ItemId);
        stages = item?.Stages ?? new();
    }

    private async Task OpenQaSelector(int stageId)
    {
        selectedStageIdForQa = stageId;
        showQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
    }

    private void CloseQaModal()
    {
        showQaModal = false;
        selectedStageIdForQa = null;
        qaSearch = null;
    }

    private async Task LoadQaUsers()
    {
        try
        {
            var url = "/api/lookup/qa-users" + (string.IsNullOrWhiteSpace(qaSearch) ? string.Empty : $"?q={Uri.EscapeDataString(qaSearch!)}");
            qaUsers = await Http.GetFromJsonAsync<List<QaUser>>(url) ?? new();
        }
        catch
        {
            qaUsers = new();
        }
        StateHasChanged();
    }

    private async Task SelectQa(int qaUserId)
    {
        if (selectedStageIdForQa.HasValue)
        {
            await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/stages/{selectedStageIdForQa.Value}/assign-qa", new { ItemStageId = selectedStageIdForQa.Value, QaUserId = qaUserId }));
        }
        CloseQaModal();
    }

    private bool ShouldShowButton(string buttonName, StageVm stage)
    {
        if (OrderStatus != ProductionOrderStatus.InProduction)
        {
            return false;
        }
        var isPendingQa = stage.AssignedQaUserId.HasValue && !stage.IsCompleted;
        
        switch (buttonName)
        {
            case "AssignQa":
                // PM can assign QA, but not if already assigned (PendingQA) or completed
                return IsProductionManager() && !isPendingQa && !stage.IsCompleted;
            case "Approve":
            case "Reject":
                // Only QA can approve/reject, and only if assigned and pending
                return IsQa() && isPendingQa;
            case "Cancel":
                // PM can cancel stages that are not completed
                return IsProductionManager() && !stage.IsCompleted;
            default:
                return false;
        }
    }

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");

    private string GetStageStatus(StageVm stage)
    {
        if (stage.IsCompleted) return "Đã hoàn thành";
        if (!stage.AssignedQaUserId.HasValue) return "Chưa hoàn thành";
        return "Đang chờ QA";
    }

    private async Task ExecuteStageAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await Load();
                if (OnChanged.HasDelegate)
                {
                    await OnChanged.InvokeAsync();
                }
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        await InvokeAsync(StateHasChanged);
    }

    private Task Approve(int stageId) => ExecuteStageAction(() => Http.PostAsync($"/api/stages/{stageId}/approve", null));

    private void OpenRejectModal(int stageId)
    {
        selectedStageIdForReject = stageId;
        rejectReason = string.Empty;
        showRejectModal = true;
        StateHasChanged();
    }

    private void CloseRejectModal()
    {
        showRejectModal = false;
        selectedStageIdForReject = null;
        rejectReason = string.Empty;
        StateHasChanged();
    }

    private bool CanConfirmReject => showRejectModal && !string.IsNullOrWhiteSpace(rejectReason) && selectedStageIdForReject.HasValue;

    private async Task ConfirmReject()
    {
        if (!CanConfirmReject || !selectedStageIdForReject.HasValue) return;
        
        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/stages/{selectedStageIdForReject.Value}/reject", new { ItemStageId = selectedStageIdForReject.Value, Decision = "reject", Reason = rejectReason.Trim() }));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            CloseRejectModal();
        }
    }

    private Task Cancel(int stageId) => ExecuteStageAction(() => Http.PostAsync($"/api/stages/{stageId}/cancel", null));

    private async Task ViewRejectReason(int stageId)
    {
        try
        {
            viewingRejectReason = null;
            isEditingRejectReason = false;
            canEditRejectReason = false;
            showViewRejectReasonModal = true;
            StateHasChanged();
            
            var response = await Http.GetAsync($"/api/stages/{stageId}/latest-reject-reason");
            if (response.IsSuccessStatusCode)
            {
                viewingRejectReason = await response.Content.ReadFromJsonAsync<RejectReasonVm>();
                if (viewingRejectReason is not null)
                {
                    editingRejectReasonText = viewingRejectReason.Reason;
                    // Check if current user is the author and is QA
                    canEditRejectReason = IsQa() && currentUserId.HasValue && viewingRejectReason.RejectedByUserId == currentUserId.Value;
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                viewingRejectReason = new RejectReasonVm { Reason = "Không tìm thấy lý do từ chối" };
            }
            else
            {
                viewingRejectReason = new RejectReasonVm { Reason = "Lỗi khi tải lý do từ chối" };
            }
        }
        catch (Exception ex)
        {
            viewingRejectReason = new RejectReasonVm { Reason = $"Lỗi: {ex.Message}" };
        }
        StateHasChanged();
    }

    private void StartEditRejectReason()
    {
        isEditingRejectReason = true;
        StateHasChanged();
    }

    private void CancelEditRejectReason()
    {
        isEditingRejectReason = false;
        if (viewingRejectReason is not null)
        {
            editingRejectReasonText = viewingRejectReason.Reason;
        }
        StateHasChanged();
    }

    private bool CanSaveRejectReason => isEditingRejectReason && !string.IsNullOrWhiteSpace(editingRejectReasonText);

    private async Task SaveRejectReason()
    {
        if (!CanSaveRejectReason || viewingRejectReason?.Id == null) return;

        try
        {
            var response = await Http.PutAsJsonAsync($"/api/stages/reject-reports/{viewingRejectReason.Id}", new { Reason = editingRejectReasonText.Trim() });
            if (response.IsSuccessStatusCode)
            {
                if (viewingRejectReason is not null)
                {
                    viewingRejectReason.Reason = editingRejectReasonText.Trim();
                }
                isEditingRejectReason = false;
                errorMessage = null;
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Cập nhật thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        StateHasChanged();
    }

    private void CloseViewRejectReasonModal()
    {
        showViewRejectReasonModal = false;
        viewingRejectReason = null;
        isEditingRejectReason = false;
        editingRejectReasonText = string.Empty;
        canEditRejectReason = false;
        StateHasChanged();
    }

    private async Task OpenStageModal()
    {
        stageTypeSearch = null;
        showStageTypeModal = true;
        await LoadStageTypes();
        StateHasChanged();
    }

    private void CloseStageModal()
    {
        showStageTypeModal = false;
        stageTypeSearch = null;
        stageTypes = null;
        showCreateCustomStage = false;
        customStageName = string.Empty;
        StateHasChanged();
    }

    private async Task LoadStageTypes()
    {
        try
        {
            stageTypes = await Http.GetFromJsonAsync<List<StageTypeVm>>("/api/stage-types") ?? new();
        }
        catch
        {
            stageTypes = new();
        }
    }

    private IEnumerable<StageTypeVm> GetAvailableStageTypes()
    {
        if (stageTypes is null) return Enumerable.Empty<StageTypeVm>();
        var used = stages?.Select(s => s.StageTypeId).ToHashSet() ?? new HashSet<int>();
        var keyword = stageTypeSearch?.Trim();
        return stageTypes
            .Where(st => st.IsActive && !used.Contains(st.Id))
            .Where(st => string.IsNullOrWhiteSpace(keyword)
                || st.Name.Contains(keyword, StringComparison.OrdinalIgnoreCase)
                || st.Code.Contains(keyword, StringComparison.OrdinalIgnoreCase))
            .OrderBy(st => st.DisplayOrder)
            .ThenBy(st => st.Name);
    }

    private async Task SelectStageType(int stageTypeId)
    {
        await ExecuteStageAction(() => Http.PostAsync($"/api/items/{ItemId}/stages?stageTypeId={stageTypeId}", null));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            CloseStageModal();
        }
        await InvokeAsync(StateHasChanged);
    }

    private bool CanCreateCustomStage => !string.IsNullOrWhiteSpace(customStageName);

    private async Task CreateCustomStage()
    {
        if (!CanCreateCustomStage) return;

        try
        {
            // Tự động tạo code từ tên (chuyển sang tiếng Anh không dấu, viết hoa chữ cái đầu)
            var name = customStageName.Trim();
            var code = GenerateCodeFromName(name);
            var dto = new { Code = code, Name = name, DisplayOrder = 0, IsActive = true, IsDefault = false };
            var response = await Http.PostAsJsonAsync("/api/stage-types", dto);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CreateStageTypeResponse>();
                var stageTypeId = result?.Id ?? 0;
                if (stageTypeId > 0)
                {
                    // Reload stage types and select the newly created one
                    await LoadStageTypes();
                    await SelectStageType(stageTypeId);
                }
                else
                {
                    errorMessage = "Không thể lấy ID của giai đoạn vừa tạo";
                }
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Tạo giai đoạn thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        await InvokeAsync(StateHasChanged);
    }

    private string GenerateCodeFromName(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "Stage";
        
        // Chuyển đổi tên thành code (PascalCase, loại bỏ ký tự đặc biệt)
        var words = name.Split(new[] { ' ', '-', '_', '.', ',', ';', ':', '!', '?', '(', ')', '[', ']', '{', '}' }, StringSplitOptions.RemoveEmptyEntries);
        if (words.Length == 0) return "Stage";
        
        var code = string.Join("", words.Select(w => 
        {
            // Loại bỏ ký tự không phải chữ cái và số
            var cleaned = new string(w.Where(c => char.IsLetterOrDigit(c)).ToArray());
            if (cleaned.Length == 0) return string.Empty;
            if (cleaned.Length == 1) return cleaned.ToUpperInvariant();
            return char.ToUpperInvariant(cleaned[0]) + cleaned.Substring(1).ToLowerInvariant();
        }));
        return string.IsNullOrWhiteSpace(code) ? "Stage" : code;
    }

    private class CreateStageTypeResponse
    {
        public int Id { get; set; }
    }

    private class DetailResp { public List<ItemVm>? items { get; set; } }
    private class ItemVm { public int Id { get; set; } public List<StageVm>? Stages { get; set; } }
    private class StageVm
    {
        public int Id { get; set; }
        public int StageTypeId { get; set; }
        public string StageName { get; set; } = string.Empty;
        public int? AssignedQaUserId { get; set; }
        public string? AssignedQaUserName { get; set; }
        public bool IsCompleted { get; set; }
        public int RejectionCount { get; set; }
    }
    private class QaUser
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? Phone { get; set; }
    }
    private class StageTypeVm
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int DisplayOrder { get; set; }
        public bool IsActive { get; set; }
    }
    private class RejectReasonVm
    {
        public int? Id { get; set; }
        public string Reason { get; set; } = string.Empty;
        public DateTime? CreatedAt { get; set; }
        public int? RejectedByUserId { get; set; }
    }
}


