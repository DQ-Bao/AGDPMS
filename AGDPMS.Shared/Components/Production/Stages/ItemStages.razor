@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Linq
@using System.Text.Json.Serialization
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Models.DTOs
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@namespace AGDPMS.Shared.Components.Production.Stages

<div>
    @if (stages is null)
    {
        <div>Đang tải giai đoạn...</div>
    }
    else if (!stages.Any())
    {
        <div class="text-muted">Không có giai đoạn</div>
    }
    else
    {
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Giai đoạn</th>
                        <th>QA phụ trách</th>
                        <th>Trạng thái</th>
                        <th>Kế hoạch (giờ)</th>
                        <th>Thực tế (giờ)</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in stages.Where(st => ShouldShowStage(st)))
                    {
                        var editingStatusId = editingStatusStageId == s.Id;
                        <tr>
                            <td>
                                <div><strong>@s.StageName</strong></div>
                            </td>
                            <td>
                                @if (ShouldShowButton("AssignQa", s))
                                {
                                    <span style="cursor:pointer;"
                                          @onclick='@(async () => await OpenQaSelector(s.Id))' 
                                          @onclick:stopPropagation="true"
                                          title="Click để giao QA">
                                        @(s.AssignedQaUserName ?? "Chưa phân công")
                                    </span>
                                }
                                else
                                {
                                    <span>@(s.AssignedQaUserName ?? "Chưa phân công")</span>
                                }
                            </td>
                            <td>
                                @if (editingStatusId && ShouldShowButton("UpdateStatus", s))
                                {
                                    <select class="form-select form-select-sm" style="width: auto; display: inline-block;" 
                                            value="@editingStatus" @onchange='@(async (ChangeEventArgs e) => { editingStatus = short.Parse(e.Value?.ToString() ?? "0"); await SaveStatus(s.Id); })' @onclick:stopPropagation="true">
                                        <option value="0">Chưa bắt đầu</option>
                                        <option value="1">Đang thực hiện</option>
                                        <option value="2">Hoàn thành</option>
                                    </select>
                                }
                                else if (ShouldShowButton("UpdateStatus", s))
                                {
                                    <span style="cursor:pointer;"
                                          @onclick='@(() => StartEditStatus(s.Id))' 
                                          @onclick:stopPropagation="true"
                                          title="Click để thay đổi trạng thái">
                                        @GetStageStatus(s)
                                    </span>
                                }
                                else
                                {
                                    <span>@GetStageStatus(s)</span>
                                }
                            </td>
                            <td>
                                @if (CanEditStagePlan() && editingPlanStageId == s.Id)
                                {
                                    <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                        <div class="d-flex gap-1 align-items-center">
                                            <input type="number" class="form-control form-control-sm" style="width: 90px;" min="0" step="0.1" @bind="editingPlannedTimeHours" />
                                            <span>h</span>
                                        </div>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-success" @onclick='@(() => SaveStagePlan(s.Id))'>✓</button>
                                            <button class="btn btn-sm btn-secondary" @onclick="CancelStagePlanEdit">✗</button>
                                        </div>
                                    </div>
                                }
                                else if (CanEditStagePlan())
                                {
                                    <div style="cursor:pointer;" class="text-primary text-decoration-underline"
                                         @onclick='@(() => StartEditStagePlan(s))'
                                         @onclick:stopPropagation="true"
                                         title="Click để chỉnh giờ kế hoạch">
                                        @FormatStageHours(s.PlannedTimeHours)
                                    </div>
                                }
                                else
                                {
                                    <div>@FormatStageHours(s.PlannedTimeHours)</div>
                                }
                            </td>
                            <td>
                                @if (CanEditStageActual() && editingActualStageId == s.Id)
                                {
                                    <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                        <div class="d-flex gap-1 align-items-center">
                                            <input type="number" class="form-control form-control-sm" style="width: 90px;" min="0" step="0.1" @bind="editingActualTimeHours" />
                                            <span>h</span>
                                        </div>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-success" @onclick='@(() => SaveStageActual(s.Id))'>✓</button>
                                            <button class="btn btn-sm btn-secondary" @onclick="CancelStageActualEdit">✗</button>
                                        </div>
                                    </div>
                                }
                                else if (CanEditStageActual())
                                {
                                    <div style="cursor:pointer;" class="text-primary text-decoration-underline"
                                         @onclick='@(() => StartEditStageActual(s))'
                                         @onclick:stopPropagation="true"
                                         title="Click để chỉnh giờ thực tế">
                                        @FormatStageHours(s.ActualTimeHours)
                                    </div>
                                }
                                else
                                {
                                    <div>@FormatStageHours(s.ActualTimeHours)</div>
                                }
                            </td>
                            <td class="text-nowrap">
                                @if (ShouldShowButton("CreateIssue", s))
                                {
                                    <button class="btn btn-outline-warning btn-sm me-1" @onclick='@(() => OpenCreateIssueModal(s.Id))'>Tạo vấn đề</button>
                                }
                                @if (ShouldShowButton("ViewIssues", s))
                                {
                                    <button class="btn btn-outline-warning btn-sm" @onclick='@(() => ViewIssues(s.Id))'>Xem vấn đề</button>
                                }
                            </td>
                        </tr>
                        @if (expandedStageId == s.Id && stageIssues.ContainsKey(s.Id))
                        {
                            <tr>
                                <td colspan="4">
                                    <div class="p-3 bg-light">
                                        <h6>Vấn đề:</h6>
                                        @if (stageIssues[s.Id].Any())
                                        {
                                            @foreach (var issue in stageIssues[s.Id])
                                            {
                                                <div class="card mb-2">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between">
                                                            <div>
                                                                <strong>@GetPriorityLabel(issue.Priority)</strong>
                                                                <span class="badge @(issue.Status == IssueStatus.Open ? "bg-warning" : "bg-success") ms-2">
                                                                    @(issue.Status == IssueStatus.Open ? "Mở" : "Đã giải quyết")
                                                                </span>
                                                            </div>
                                                            @if (issue.Status == IssueStatus.Open && IsProductionManager())
                                                            {
                                                                <button class="btn btn-sm btn-success" @onclick='@(() => ResolveIssue(issue.Id))'>Giải quyết</button>
                                                            }
                                                        </div>
                                                        <p class="mb-0 mt-2">@issue.Reason</p>
                                                        <small class="text-muted">Tạo lúc: @FormatDate(issue.CreatedAt)</small>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <p class="text-muted">Không có vấn đề</p>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        @if (IsProductionManager() && (OrderStatus == ProductionOrderStatus.Draft || OrderStatus == ProductionOrderStatus.InProduction))
        {
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" @onclick="OpenBulkQaModal">Giao QA nhanh cho toàn bộ</button>
            </div>
        }
    }
</div>

@* QA Selection Modal *@
@if (showQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chọn nhân viên QA</h5>
                    <button type="button" class="btn-close" @onclick="CloseQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            @foreach (var qa in qaUsers)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick='@(() => SelectQa(qa.Id))'>
                                    <div><strong>@qa.Name</strong></div>
                                    <small class="text-muted">@qa.Phone</small>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Bulk QA Assignment Modal *@
@if (showBulkQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Giao QA nhanh cho toàn bộ giai đoạn</h5>
                    <button type="button" class="btn-close" @onclick="CloseBulkQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            @foreach (var qa in qaUsers)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick='@(() => SelectBulkQa(qa.Id))'>
                                    <div><strong>@qa.Name</strong></div>
                                    <small class="text-muted">@qa.Phone</small>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Create Issue Modal *@
@if (showCreateIssueModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tạo issue</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateIssueModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Mức độ ưu tiên <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="issuePriority">
                            <option value="0">Thấp</option>
                            <option value="1">Trung bình</option>
                            <option value="2">Cao</option>
                            <option value="3">Nghiêm trọng</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lý do <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="4" placeholder="Nhập lý do..." @bind="issueReason"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateIssueModal">Hủy</button>
                    <button type="button" class="btn btn-warning" disabled="@(!CanCreateIssue)" @onclick="ConfirmCreateIssue">Tạo issue</button>
                </div>
            </div>
        </div>
    </div>
}



@code {
    [Parameter] public int ItemId { get; set; }
    [Parameter] public ProductionOrderStatus OrderStatus { get; set; }
    [Parameter] public EventCallback OnChanged { get; set; }

    private List<StageVm>? stages;
    private string? userRole;
    private bool showQaModal = false;
    private int? selectedStageIdForQa;
    private List<QaUser>? qaUsers;
    private string? qaSearch;
    private string? errorMessage;
    private bool showBulkQaModal = false;
    private bool showCreateIssueModal = false;
    private int? selectedStageIdForIssue;
    private IssuePriority issuePriority = IssuePriority.Medium;
    private string issueReason = string.Empty;
    private int? selectedStageIdForIssues;
    private Dictionary<int, List<IssueVm>> stageIssues = new();
    private int? expandedStageId;
    
    // Inline editing states
    private int? editingStatusStageId;
    private short editingStatus;
    private int? editingPlanStageId;
    private decimal? editingPlannedTimeHours;
    private int? editingActualStageId;
    private decimal? editingActualTimeHours;

    protected override async Task OnParametersSetAsync()
    {
        await LoadUserRole();
        await Load();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task Load()
    {
        errorMessage = null;
        try
        {
            // stages come from order details; for simplicity reload the order and filter
            var orderId = await Http.GetFromJsonAsync<int>($"/api/items/{ItemId}/order-id");
            if (orderId == 0) 
            { 
                stages = new(); 
                StateHasChanged();
                return; 
            }
            var detail = await Http.GetFromJsonAsync<DetailResp>($"/api/orders/{orderId}");
            var item = detail?.items?.FirstOrDefault(i => i.Id == ItemId);
            stages = item?.Stages ?? new();
            
            // Nếu StageName rỗng, thử load từ StageTypeId (fallback)
            if (stages != null && stages.Any())
            {
                // Load stage types một lần
                List<StageTypeInfo>? stageTypes = null;
                try
                {
                    stageTypes = await Http.GetFromJsonAsync<List<StageTypeInfo>>("/api/stage-types");
                }
                catch
                {
                    // Ignore
                }
                
                foreach (var stage in stages)
                {
                    if (string.IsNullOrEmpty(stage.StageName) && stage.StageTypeId > 0 && stageTypes != null)
                    {
                        var stageType = stageTypes.FirstOrDefault(st => st.Id == stage.StageTypeId);
                        if (stageType != null)
                        {
                            stage.StageName = stageType.Name;
                        }
                    }
                    else if (string.IsNullOrEmpty(stage.StageName))
                    {
                        // Fallback nếu không tìm thấy
                        stage.StageName = $"Giai đoạn {stage.Id}";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải giai đoạn: {ex.Message}";
            stages = new();
        }
        StateHasChanged();
    }

    private async Task OpenQaSelector(int stageId)
    {
        selectedStageIdForQa = stageId;
        showQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
        StateHasChanged();
    }

    private void CloseQaModal()
    {
        showQaModal = false;
        selectedStageIdForQa = null;
        qaSearch = null;
    }

    private async Task LoadQaUsers()
    {
        try
        {
            var url = "/api/lookup/qa-users" + (string.IsNullOrWhiteSpace(qaSearch) ? string.Empty : $"?q={Uri.EscapeDataString(qaSearch!)}");
            qaUsers = await Http.GetFromJsonAsync<List<QaUser>>(url) ?? new();
        }
        catch
        {
            qaUsers = new();
        }
        StateHasChanged();
    }

    private async Task SelectQa(int qaUserId)
    {
        if (selectedStageIdForQa.HasValue)
        {
            await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{selectedStageIdForQa.Value}/assign-qa", new { QaUserId = qaUserId }));
        }
        CloseQaModal();
    }

    private async Task OpenBulkQaModal()
    {
        showBulkQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
    }

    private void CloseBulkQaModal()
    {
        showBulkQaModal = false;
        qaSearch = null;
    }

    private async Task SelectBulkQa(int qaUserId)
    {
        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/items/{ItemId}/assign-qa-bulk", new { QaUserId = qaUserId }));
        CloseBulkQaModal();
    }

    private bool ShouldShowStage(StageVm stage) => true;

    private bool ShouldShowButton(string buttonName, StageVm stage)
    {
        switch (buttonName)
        {
            case "AssignQa":
                return IsProductionManager() && !stage.IsCompleted && (OrderStatus == ProductionOrderStatus.Draft || OrderStatus == ProductionOrderStatus.InProduction);
            case "UpdateStatus":
                return IsProductionManager() && OrderStatus == ProductionOrderStatus.InProduction;
            case "CreateIssue":
                return (IsQa() || IsDirector()) && OrderStatus == ProductionOrderStatus.InProduction;
            case "ViewIssues":
                return (IsProductionManager() || IsQa() || IsDirector()) && OrderStatus == ProductionOrderStatus.InProduction;
            default:
                return false;
        }
    }

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");
    private bool IsDirector() => HasRole("Admin") || HasRole("Director");

    private bool CanEditStagePlan() => IsProductionManager() && (OrderStatus == ProductionOrderStatus.Draft);
    private bool CanEditStageActual() => IsProductionManager() && (OrderStatus == ProductionOrderStatus.InProduction);

    private string GetStageStatus(StageVm stage)
    {
        return stage.Status switch
        {
            StageStatus.NotStarted => "Chưa bắt đầu",
            StageStatus.InProgress => "Đang thực hiện",
            StageStatus.Completed => "Đã hoàn thành",
            _ => "Chưa xác định"
        };
    }

    private string FormatDate(DateTime? value) => value.HasValue ? value.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm") : "-";

    private async Task ExecuteStageAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await Load();
                if (OnChanged.HasDelegate)
                {
                    await OnChanged.InvokeAsync();
                }
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        await InvokeAsync(StateHasChanged);
    }

    private void OpenCreateIssueModal(int stageId)
    {
        selectedStageIdForIssue = stageId;
        issueReason = string.Empty;
        issuePriority = IssuePriority.Medium;
        showCreateIssueModal = true;
        StateHasChanged();
    }

    private void CloseCreateIssueModal()
    {
        showCreateIssueModal = false;
        selectedStageIdForIssue = null;
        issueReason = string.Empty;
        StateHasChanged();
    }

    private bool CanCreateIssue => showCreateIssueModal && !string.IsNullOrWhiteSpace(issueReason) && selectedStageIdForIssue.HasValue;

    private async Task ConfirmCreateIssue()
    {
        if (!CanCreateIssue || !selectedStageIdForIssue.HasValue) return;
        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/stages/{selectedStageIdForIssue.Value}/issues", new { Priority = (short)issuePriority, Reason = issueReason.Trim() }));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            CloseCreateIssueModal();
        }
    }
    private async Task ViewIssues(int stageId)
    {
        selectedStageIdForIssues = stageId;
        if (expandedStageId == stageId)
        {
            expandedStageId = null;
        }
        else
        {
            expandedStageId = stageId;
            await LoadIssues(stageId);
        }
        StateHasChanged();
    }

    private async Task LoadIssues(int stageId)
    {
        try
        {
            var issues = await Http.GetFromJsonAsync<List<IssueVm>>($"/api/stages/{stageId}/issues") ?? new();
            stageIssues[stageId] = issues;
        }
        catch
        {
            stageIssues[stageId] = new();
        }
    }

    private async Task ResolveIssue(int issueId)
    {
        await ExecuteStageAction(() => Http.PutAsync($"/api/stages/issues/{issueId}/resolve", null));
        if (selectedStageIdForIssues.HasValue)
        {
            await LoadIssues(selectedStageIdForIssues.Value);
        }
    }

    private string GetPriorityLabel(IssuePriority priority) => priority switch
    {
        IssuePriority.Low => "Thấp",
        IssuePriority.Medium => "Trung bình",
        IssuePriority.High => "Cao",
        IssuePriority.Critical => "Nghiêm trọng",
        _ => "Không xác định"
    };

    // Inline editing methods
    private void StartEditStatus(int stageId)
    {
        var stage = stages?.FirstOrDefault(s => s.Id == stageId);
        if (stage != null)
        {
            editingStatusStageId = stageId;
            editingStatus = (short)stage.Status;
        }
        StateHasChanged();
    }

    private async Task SaveStatus(int stageId)
    {
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/status", new { Status = editingStatus }));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingStatusStageId = null;
        }
    }

    private void StartEditStagePlan(StageVm stage)
    {
        editingPlanStageId = stage.Id;
        editingPlannedTimeHours = stage.PlannedTimeHours;
        StateHasChanged();
    }

    private void CancelStagePlanEdit()
    {
        editingPlanStageId = null;
        StateHasChanged();
    }

    private async Task SaveStagePlan(int stageId)
    {
        var dto = new UpdateStagePlanDto
        {
            PlannedTimeHours = editingPlannedTimeHours
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/plan", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingPlanStageId = null;
        }
    }

    private void StartEditStageActual(StageVm stage)
    {
        editingActualStageId = stage.Id;
        editingActualTimeHours = stage.ActualTimeHours;
        StateHasChanged();
    }

    private void CancelStageActualEdit()
    {
        editingActualStageId = null;
        StateHasChanged();
    }

    private async Task SaveStageActual(int stageId)
    {
        var dto = new UpdateStageDatesDto
        {
            ActualTimeHours = editingActualTimeHours
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/dates", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingActualStageId = null;
        }
    }

    private string FormatStageHours(decimal? hours)
    {
        if (!hours.HasValue)
        {
            return "-";
        }
        return $"{hours.Value:F1}h";
    }


    private class DetailResp 
    { 
        [JsonPropertyName("items")]
        public List<ItemVm>? items { get; set; } 
    }
    private class ItemVm 
    { 
        [JsonPropertyName("id")]
        public int Id { get; set; } 
        [JsonPropertyName("stages")]
        public List<StageVm>? Stages { get; set; } 
    }
    private class StageVm
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }
        [JsonPropertyName("stageTypeId")]
        public int StageTypeId { get; set; }
        [JsonPropertyName("stageName")]
        public string StageName { get; set; } = string.Empty;
        [JsonPropertyName("status")]
        public StageStatus Status { get; set; }
        [JsonPropertyName("plannedStartDate")]
        public DateTime? PlannedStartDate { get; set; }
        [JsonPropertyName("plannedFinishDate")]
        public DateTime? PlannedFinishDate { get; set; }
        [JsonPropertyName("actualStartDate")]
        public DateTime? ActualStartDate { get; set; }
        [JsonPropertyName("actualFinishDate")]
        public DateTime? ActualFinishDate { get; set; }
        [JsonPropertyName("plannedTimeHours")]
        public decimal? PlannedTimeHours { get; set; }
        [JsonPropertyName("actualTimeHours")]
        public decimal? ActualTimeHours { get; set; }
        [JsonPropertyName("assignedQaUserId")]
        public int? AssignedQaUserId { get; set; }
        [JsonPropertyName("assignedQaUserName")]
        public string? AssignedQaUserName { get; set; }
        [JsonPropertyName("isCompleted")]
        public bool IsCompleted { get; set; }
    }
    private class QaUser
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? Phone { get; set; }
    }
    
    private class StageTypeInfo
    {
        [JsonPropertyName("id")]
        public int Id { get; set; }
        [JsonPropertyName("name")]
        public string Name { get; set; } = string.Empty;
    }
    private class StageTypeVm
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public bool IsActive { get; set; }
    }
    private class IssueVm
    {
        public int Id { get; set; }
        public IssueStatus Status { get; set; }
        public IssuePriority Priority { get; set; }
        public string Reason { get; set; } = string.Empty;
        public DateTime? CreatedAt { get; set; }
    }
}


