@page "/production/orders/{Id:int}"
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Models.DTOs
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Linq
@using System.Text
@using System.Text.RegularExpressions
@using System.Globalization
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/production/orders">Lệnh sản xuất</a></li>
            <li class="breadcrumb-item active">@(model?.order?.Code ?? "Chi tiết")</li>
        </ol>
    </nav>
    @if (model is null)
    {
        <div>Loading...</div>
    }
    else
    {
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <h5 class="mb-1">Lệnh sản xuất @model.order?.Code</h5>
                <div class="text-secondary">Dự án: @model.order?.ProjectId | Trạng thái: @GetOrderStatusDisplay()</div>
                <div class="text-secondary small mt-1">
                    <span>Kế hoạch: Bắt đầu: @FormatDate(model.order?.PlannedStartDate) | Kết thúc: @FormatDate(model.order?.PlannedFinishDate)</span>
                </div>
                <div class="text-secondary small">
                    <span>Thực tế: Bắt đầu: @FormatDate(model.order?.StartedAt) | Kết thúc: @FormatDate(model.order?.FinishedAt)</span>
                </div>
                <div class="text-secondary small mt-1">
                    <span>QA phụ trách: @(string.IsNullOrWhiteSpace(orderQaName) ? "Chưa phân công" : orderQaName)</span>
                </div>
                @if (model.items?.Any() == true)
                {
                    <div class="text-secondary small mt-1">
                        <span class="ms-3">Giờ ước tính: @FormatHoursVerbose(TotalPlannedHours)</span>
                        <span class="ms-3">Giờ thực tế: @FormatHoursVerbose(TotalActualHours)</span>
                    </div>
                }
            </div>
            <div class="d-flex gap-2">
                @if (ShouldShowButton("Submit"))
                {
                    <button class="btn btn-outline-primary btn-sm" @onclick="Submit">Gửi duyệt</button>
                }
                @if (ShouldShowButton("Cancel"))
                {
                    <button class="btn btn-outline-danger btn-sm" @onclick="OpenCancelModal">Hủy lệnh</button>
                }
                @if (ShouldShowButton("Finish"))
                {
                    <button class="btn btn-outline-success btn-sm" @onclick="ConfirmFinish">Hoàn tất</button>
                }
                @if (ShouldShowButton("DirectorApprove"))
                {
                    <button class="btn btn-outline-success btn-sm" @onclick="DirectorApprove">Duyệt</button>
                }
                @if (ShouldShowButton("DirectorReject"))
                {
                    <button class="btn btn-outline-danger btn-sm" @onclick="DirectorReject">Từ chối</button>
                }
                @if (ShouldShowButton("RevertToDraft"))
                {
                    <button class="btn btn-outline-secondary btn-sm" @onclick="RevertToDraft">Hủy xin duyệt</button>
                }
                @if (ShouldShowButton("QaMachines"))
                {
                    <button class="btn btn-outline-success btn-sm" @onclick="QaMachines">Xác nhận máy</button>
                }
                @if (ShouldShowButton("QaMaterial"))
                {
                    <button class="btn btn-outline-success btn-sm" @onclick="QaMaterial">Xác nhận vật tư</button>
                }
                @if (ShouldShowAssignQa())
                {
                    <button class="btn btn-outline-warning btn-sm" @onclick="OpenAssignQaModal">Phân công QA</button>
                }
                @if (IsProductionManager() && model?.order?.Status == ProductionOrderStatus.Draft)
                {
                    <button class="btn btn-outline-info btn-sm" @onclick="OpenPlanModal">Cập nhật kế hoạch</button>
                }
                @if (IsProductionManager() || IsDirector())
                {
                    <button class="btn btn-outline-dark btn-sm" @onclick="OpenCostModal">Quản lý chi phí (EVM)</button>
                }
                @if (model?.items?.Any() == true)
                {
                    <button class="btn btn-outline-info btn-sm" @onclick="AddAllItemsToStamps">
                        <i class="bx bx-printer"></i> In tem nhanh
                    </button>
                }
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @* Overall Progress Bar *@
        @if (model?.items != null)
        {
            <div class="mb-3">
                <OrderStatusBar OrderId="@Id" />
                <div class="small text-secondary mb-1">Tiến độ tổng thể: @CompletedItems/@TotalItems item</div>
                <div class="progress" style="height: 30px; position: relative;">
                    @{
                        // Calculate hours from all items (using PlannedTimeHours which comes from filtered stages)
                        var notCompletedHours = model.items.Where(i => !i.IsCompleted).Sum(i => i.PlannedTimeHours ?? 0);
                        var completedHours = model.items.Where(i => i.IsCompleted && !i.IsStored).Sum(i => i.PlannedTimeHours ?? 0);
                        var storedHours = model.items.Where(i => i.IsCompleted && i.IsStored).Sum(i => i.PlannedTimeHours ?? 0);
                        
                        // Total is the sum of all three groups to ensure 100%
                        var totalPlannedHours = notCompletedHours + completedHours + storedHours;
                        
                        var notCompletedPercent = totalPlannedHours > 0 ? (double)notCompletedHours * 100.0 / (double)totalPlannedHours : 0;
                        var completedPercent = totalPlannedHours > 0 ? (double)completedHours * 100.0 / (double)totalPlannedHours : 0;
                        var storedPercent = totalPlannedHours > 0 ? (double)storedHours * 100.0 / (double)totalPlannedHours : 0;
                        
                        // Ensure percentages add up to 100% (handle rounding)
                        var totalPercent = notCompletedPercent + completedPercent + storedPercent;
                        if (totalPercent > 0 && Math.Abs(totalPercent - 100.0) > 0.1)
                        {
                            // Normalize if there's a rounding issue
                            var factor = 100.0 / totalPercent;
                            notCompletedPercent *= factor;
                            completedPercent *= factor;
                            storedPercent *= factor;
                        }
                        
                        var notCompletedCount = model.items.Count(i => !i.IsCompleted);
                        var completedCount = model.items.Count(i => i.IsCompleted && !i.IsStored);
                        var storedCount = model.items.Count(i => i.IsCompleted && i.IsStored);
                    }
                    @if (notCompletedPercent > 0)
                    {
                        var widthStr = notCompletedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        var percentStr = notCompletedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        <div class="progress-bar bg-secondary" role="progressbar" 
                             style="width: @widthStr" 
                             title="Chưa hoàn thành: @notCompletedCount item (@percentStr)">
                            @if (notCompletedPercent >= 5)
                            {
                                <span class="ms-2 text-white">@percentStr</span>
                            }
                        </div>
                    }
                    @if (completedPercent > 0)
                    {
                        var widthStr = completedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        var percentStr = completedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: @widthStr" 
                             title="Đã hoàn thành: @completedCount item (@percentStr)">
                            @if (completedPercent >= 5)
                            {
                                <span class="ms-2 text-white">@percentStr</span>
                            }
                        </div>
                    }
                    @if (storedPercent > 0)
                    {
                        var widthStr = storedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        var percentStr = storedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        <div class="progress-bar bg-primary" role="progressbar" 
                             style="width: @widthStr" 
                             title="Đã lưu kho: @storedCount item (@percentStr)">
                            @if (storedPercent >= 5)
                            {
                                <span class="ms-2 text-white">@percentStr</span>
                            }
                        </div>
                    }
                    @if (totalPlannedHours == 0)
                    {
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 100%" title="Chưa có dữ liệu">
                            <span class="ms-2 text-white">0%</span>
                        </div>
                    }
                </div>
                <div class="small text-muted mt-1 d-flex gap-3">
                    <span><span class="badge bg-secondary">●</span> Chưa hoàn thành: @notCompletedCount</span>
                    <span><span class="badge bg-success">●</span> Đã hoàn thành: @completedCount</span>
                    <span><span class="badge bg-primary">●</span> Đã lưu kho: @storedCount</span>
                </div>
            </div>
        }

        @if (showCostModal)
        {
            <CostManagementModal OrderId="@Id" OnClose="CloseCostModal" />
        }
        @if (showAssignQaModal)
        {
            <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Phân công QA cho lệnh @model?.order?.Code</h5>
                            <button type="button" class="btn-close" @onclick="CloseAssignQaModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <input class="form-control" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="OnQaSearchChanged" />
                                </div>
                            </div>
                            <div class="list-group" style="max-height:300px; overflow:auto;">
                                @if (qaUsers is null)
                                {
                                    <div class="px-2">Đang tải...</div>
                                }
                                else if (!qaUsers.Any())
                                {
                                    <div class="px-2">Không tìm thấy nhân viên QA</div>
                                }
                                else
                                {
                                    var sortedQa = qaUsers.OrderBy(q => q.PendingItemsCount).ThenBy(q => q.Name).ToList();
                                    var minCount = sortedQa.FirstOrDefault()?.PendingItemsCount ?? 0;
                                    @foreach (var qa in sortedQa)
                                    {
                                        var isRecommended = qa.PendingItemsCount == minCount && sortedQa.Count > 1;
                                        <button type="button" class="list-group-item list-group-item-action @(isRecommended ? "border-primary border-2" : "")" @onclick='@(() => SelectOrderQa(qa.Id))'>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div>
                                                        <strong>@qa.Name</strong>
                                                        @if (isRecommended)
                                                        {
                                                            <span class="badge bg-primary ms-2">Đề xuất</span>
                                                        }
                                                    </div>
                                                    <small class="text-muted">@qa.Phone</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-secondary">@GetQaWorkloadText(qa)</span>
                                                </div>
                                            </div>
                                        </button>
                                    }
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseAssignQaModal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Search and Filter *@
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control" placeholder="Tìm theo mã, cavity code/name..." 
                           @bind="itemSearch" @bind:event="oninput" />
                </div>
                <div class="col-md-3">
                    <div class="dropdown w-100">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            @GetItemStatusFilterLabel()
                        </button>
                        <ul class="dropdown-menu p-2 w-100">
                            @foreach (var opt in ItemStatusOptions)
                            {
                                <li class="form-check">
                                    <input class="form-check-input" type="checkbox" id="it-st-@opt.Value"
                                           checked="@itemStatusFilters.Contains(opt.Value)"
                                           @onchange="(e => ToggleItemStatusFilter(opt.Value, (bool)e.Value))" />
                                    <label class="form-check-label" for="it-st-@opt.Value">@opt.Label</label>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive" style="max-height:60vh; overflow:auto;">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Mã</th>
                        <th>Cavity</th>
                        <th>Trạng thái</th>
                        <th>Kế hoạch</th>
                        <th>Thực tế</th>
                        <th>Chênh lệch</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in GetFilteredItems())
                    {
                        var rowClass = string.Empty;
                        if (it.IsLate)
                        {
                            rowClass = "table-danger";
                        }
                        else if (it.NeedsQa && IsQa())
                        {
                            rowClass = "table-warning";
                        }
                        var editingPlan = editingItemPlanId == it.Id;
                        var editingActual = editingItemActualId == it.Id;
                        var editingCode = editingItemCodeId == it.Id;
                        <tr class="@rowClass" style="cursor:pointer;"
                            @onclick='@(() => Nav.NavigateTo($"/production/orders/{Id}/items/{it.Id}"))'>
                            <td>
                                @if (CanEditItemCode() && editingCode)
                                {
                                    <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                        <input type="text" class="form-control form-control-sm" style="width:80px;" maxlength="4" 
                                               @bind="editingItemCode" 
                                               @bind:after="StateHasChanged" />
                                        @if (!string.IsNullOrWhiteSpace(codeValidationError))
                                        {
                                            <small class="text-danger">@codeValidationError</small>
                                        }
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-success" @onclick='@(() => SaveItemCode(it.Id))' @onclick:stopPropagation="true">✓</button>
                                            <button class="btn btn-sm btn-secondary" @onclick='@(() => CancelItemCodeEdit())' @onclick:stopPropagation="true">✗</button>
                                        </div>
                                    </div>
                                }
                                else if (CanEditItemCode())
                                {
                                    <div style="cursor:pointer;" class="text-primary text-decoration-underline" 
                                         @onclick='@(() => StartEditItemCode(it))' 
                                         @onclick:stopPropagation="true" 
                                         title="Click để chỉnh mã">
                                        @it.Code
                                    </div>
                                }
                                else
                                {
                                    <div>@it.Code</div>
                                }
                            </td>
                            <td>
                                <a href="/cavities/@it.CavityId"
                                   class="text-decoration-none"
                                   @onclick:stopPropagation="true">
                                    @(string.IsNullOrWhiteSpace(it.CavityName) ? (it.CavityCode ?? $"Cavity {it.CavityId}") : it.CavityName)
                                </a>
                                @if (it.IsLate)
                                {
                                    <span class="badge bg-danger ms-1" title="@GetLateTooltip(it)">Trễ</span>
                                }
                            </td>
                            <td>
                                @if (it.IsStored)
                                {
                                    <span class="badge bg-primary">Đã lưu kho</span>
                                }
                                else if (it.IsCompleted)
                                {
                                    <span class="badge bg-success">Đã hoàn thành</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Chưa hoàn thành</span>
                                }
                            </td>
                            <td>
                                @if (CanEditItemPlan())
                                {
                                    if (editingPlan)
                                    {
                                        <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                            <input type="datetime-local" class="form-control form-control-sm" @bind="editingItemPlannedStartDate" />
                                            <input type="datetime-local" class="form-control form-control-sm" @bind="editingItemPlannedFinishDate" />
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-success" @onclick='@(() => SaveItemPlan(it.Id))' @onclick:stopPropagation="true">✓</button>
                                                <button class="btn btn-sm btn-secondary" @onclick='@(() => CancelItemPlanEdit())' @onclick:stopPropagation="true">✗</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="cursor:pointer;" class="text-primary text-decoration-underline" @onclick='@(() => StartEditItemPlan(it))' @onclick:stopPropagation="true" title="Click để cập nhật kế hoạch">
                                            @GetPlanInfoMarkup(it)
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div>
                                        @GetPlanInfoMarkup(it)
                                    </div>
                                }
                            </td>
                            <td>
                                @if (CanEditItemActual())
                                {
                                    if (editingActual)
                                    {
                                        <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                            <input type="datetime-local" class="form-control form-control-sm" @bind="editingItemActualStartDate" />
                                            <input type="datetime-local" class="form-control form-control-sm" @bind="editingItemActualFinishDate" />
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-success" @onclick='@(() => SaveItemActual(it.Id))' @onclick:stopPropagation="true">✓</button>
                                                <button class="btn btn-sm btn-secondary" @onclick='@(() => CancelItemActualEdit())' @onclick:stopPropagation="true">✗</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="cursor:pointer;" class="text-primary text-decoration-underline" @onclick='@(() => StartEditItemActual(it))' @onclick:stopPropagation="true" title="Click để cập nhật thực tế">
                                            @GetActualInfoMarkup(it)
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div>
                                        @GetActualInfoMarkup(it)
                                    </div>
                                }
                            </td>
                            <td>
                                @GetDifferenceInfo(it)
                            </td>
                            <td>
                                <div class="d-flex gap-1 flex-wrap">
                                    @if (CanEditItemCompletion())
                                    {
                                        @if (!it.IsCompleted && CanCompleteItem(it))
                                        {
                                            <button class="btn btn-sm btn-success" @onclick='@(() => ToggleItemCompletion(it))' @onclick:stopPropagation="true">
                                                Đã hoàn thành
                                            </button>
                                        }
                                        else if (it.IsCompleted && !it.IsStored)
                                        {
                                            <button class="btn btn-sm btn-primary" @onclick='@(() => StoreItem(it.Id))' @onclick:stopPropagation="true">
                                                Lưu kho
                                            </button>
                                        }
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private OrderDetailsResponse? model;
    private string? userRole;
    private string? errorMessage;
    private string? orderQaName;
    private bool showCancelConfirm;
    private string? cancelConfirmInput;
    private bool showPlanModal;
    private DateTime? plannedStartDate;
    private DateTime? plannedFinishDate;
    private int? editingItemPlanId;
    private DateTime? editingItemPlannedStartDate;
    private DateTime? editingItemPlannedFinishDate;
    private int? editingItemActualId;
    private DateTime? editingItemActualStartDate;
    private DateTime? editingItemActualFinishDate;
    private int? editingItemCodeId;
    private string? editingItemCode;
    private string? codeValidationError;
    private string itemSearch = string.Empty;
    private HashSet<string> itemStatusFilters = new();
    private bool showAssignQaModal;
    private string? qaSearch;
    private List<QaUser>? qaUsers;

    protected override async Task OnParametersSetAsync()
    {
        await LoadUserRole();
        await Load();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task Load()
    {
        errorMessage = null;
        orderQaName = null;
        try
        {
            var response = await Http.GetAsync($"/api/orders/{Id}");
            if (response.IsSuccessStatusCode)
            {
                var dto = await response.Content.ReadFromJsonAsync<OrderDetailsResponse>();
                model = dto;
                orderQaName = dto?.orderQaName;
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Lỗi khi tải đơn hàng: {response.StatusCode}. {errorContent}";
                model = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải đơn hàng: {ex.Message}";
            model = null;
        }
    }

    private bool ShouldShowButton(string buttonName) => buttonName switch
    {
        "Submit" => IsProductionManager() && CanSubmit(),
        "Cancel" => (IsProductionManager() || IsDirector()) && CanCancel(),
        "Finish" => IsProductionManager() && CanFinish(),
        "DirectorApprove" => IsDirector() && CanDirectorApprove(),
        "DirectorReject" => IsDirector() && CanDirectorReject(),
        "QaMachines" => IsQa() && CanQaMachines(),
        "QaMaterial" => IsQa() && CanQaMaterial(),
        "RevertToDraft" => IsProductionManager() && CanRevertToDraft(),
        _ => false
    };

    private bool CanSubmit() => model?.order?.Status == ProductionOrderStatus.Draft;
    private bool CanCancel() => model?.order?.Status is ProductionOrderStatus.Draft or ProductionOrderStatus.PendingDirectorApproval or ProductionOrderStatus.PendingQACheckMachines or ProductionOrderStatus.PendingQACheckMaterial or ProductionOrderStatus.InProduction;
    private bool CanFinish() => model?.order?.Status == ProductionOrderStatus.InProduction;
    private bool CanDirectorApprove() => model?.order?.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanDirectorReject() => model?.order?.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanRevertToDraft() => model?.order?.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanQaMachines() => model?.order?.Status == ProductionOrderStatus.PendingQACheckMachines;
    private bool CanQaMaterial() => model?.order?.Status == ProductionOrderStatus.PendingQACheckMaterial;

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsDirector() => HasRole("Admin") || HasRole("Director");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");

    private string GetOrderStatusDisplay()
    {
        if (model?.order is null) return string.Empty;
        var label = GetStatusLabel(model.order.Status);
        var date = GetStatusDate(model.order);
        return date.HasValue ? $"{label} ({FormatDate(date)})" : label;
    }

    private DateTime? GetStatusDate(ProductionOrder order) => order.Status switch
    {
        ProductionOrderStatus.Draft => order.CreatedAt,
        ProductionOrderStatus.PendingDirectorApproval => order.SubmittedAt ?? order.CreatedAt,
        ProductionOrderStatus.DirectorRejected => order.DirectorDecisionAt,
        ProductionOrderStatus.PendingQACheckMachines => order.DirectorDecisionAt,
        ProductionOrderStatus.PendingQACheckMaterial => order.QAMachinesCheckedAt,
        ProductionOrderStatus.InProduction => order.StartedAt ?? order.QAMaterialCheckedAt,
        ProductionOrderStatus.Finished => order.FinishedAt,
        ProductionOrderStatus.Cancelled => order.UpdatedAt ?? order.FinishedAt ?? order.StartedAt ?? order.CreatedAt,
        _ => null
    };

    private string FormatDate(DateTime? value) => value.HasValue ? value.Value.ToString("dd/MM/yyyy HH:mm") : "-";

    private string FormatHoursVerbose(decimal hours)
    {
        if (hours <= 0) return "-";
        var totalMinutes = (int)Math.Round((double)hours * 60.0);
        var h = totalMinutes / 60;
        var m = totalMinutes % 60;
        if (h > 0 && m > 0) return $"{h} giờ {m} phút";
        if (h > 0) return $"{h} giờ";
        return $"{m} phút";
    }

    private string GetStatusLabel(ProductionOrderStatus status) => status switch
    {
        ProductionOrderStatus.Draft => "Nháp",
        ProductionOrderStatus.PendingDirectorApproval => "Chờ giám đốc duyệt",
        ProductionOrderStatus.DirectorRejected => "Bị từ chối",
        ProductionOrderStatus.PendingQACheckMachines => "Chờ QA kiểm tra máy",
        ProductionOrderStatus.PendingQACheckMaterial => "Chờ QA kiểm tra vật tư",
        ProductionOrderStatus.InProduction => "Đang sản xuất",
        ProductionOrderStatus.Finished => "Hoàn thành",
        ProductionOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    private bool CanEditItemPlan() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.Draft;
    private bool CanEditItemActual() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.InProduction;
    private bool CanEditItemCompletion() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.InProduction;
    private bool CanEditItemCode() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.Draft;
    private bool ShouldShowAssignQa() =>
        (IsProductionManager() || IsDirector()) &&
        model?.order?.Status is ProductionOrderStatus.Draft or ProductionOrderStatus.PendingDirectorApproval or ProductionOrderStatus.PendingQACheckMachines or ProductionOrderStatus.PendingQACheckMaterial or ProductionOrderStatus.InProduction;

    private bool CanCompleteItem(ItemDto item)
    {
        if (!CanEditItemCompletion() || item == null)
            return false;

        // Check if all stages are completed
        var stages = item.Stages ?? new();
        var visibleStages = stages.Where(s => (s.PlannedTimeHours.HasValue && s.PlannedTimeHours > 0) || model?.order?.Status == ProductionOrderStatus.Draft).ToList();
        if (!visibleStages.All(s => s.IsCompleted))
            return false;

        return true;
    }

    private async Task<bool> ExecuteOrderAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await Load();
                return true;
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
                return false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
            return false;
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void StartEditItemPlan(ItemDto item)
    {
        editingItemPlanId = item.Id;
        editingItemPlannedStartDate = item.PlannedStartDate;
        editingItemPlannedFinishDate = item.PlannedFinishDate;
        StateHasChanged();
    }

    private void CancelItemPlanEdit()
    {
        editingItemPlanId = null;
        StateHasChanged();
    }

    private async Task SaveItemPlan(int itemId)
    {
        var dto = new UpdateItemPlanDto
        {
            PlannedStartDate = editingItemPlannedStartDate,
            PlannedFinishDate = editingItemPlannedFinishDate
        };
        var success = await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/items/{itemId}/plan", dto));
        if (success)
        {
            editingItemPlanId = null;
        }
    }

    private void StartEditItemActual(ItemDto item)
    {
        editingItemActualId = item.Id;
        editingItemActualStartDate = item.ActualStartDate;
        editingItemActualFinishDate = item.ActualFinishDate;
        StateHasChanged();
    }

    private void CancelItemActualEdit()
    {
        editingItemActualId = null;
        StateHasChanged();
    }

    private async Task SaveItemActual(int itemId)
    {
        var dto = new UpdateItemActualDto
        {
            ActualStartDate = editingItemActualStartDate,
            ActualFinishDate = editingItemActualFinishDate
        };
        var success = await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/items/{itemId}/actuals", dto));
        if (success)
        {
            editingItemActualId = null;
        }
    }

    private async Task ToggleItemCompletion(ItemDto item)
    {
        var dto = new UpdateItemCompletionDto
        {
            IsCompleted = !item.IsCompleted
        };
        await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/items/{item.Id}/completion", dto));
    }

    private async Task StoreItem(int itemId)
    {
        if (!CanEditItemCompletion()) return;
        var success = await ExecuteOrderAction(() => Http.PutAsync($"/api/items/{itemId}/stored", null));
        if (success)
        {
            await Load();
        }
    }

    private void AddItemToStamps(int itemId)
    {
        Nav.NavigateTo($"/print/stamp-manager?items={itemId}");
    }

    private void AddAllItemsToStamps()
    {
        if (model?.items == null || !model.items.Any()) return;
        var itemIds = string.Join(",", model.items.Select(i => i.Id));
        Nav.NavigateTo($"/print/stamp-manager?items={itemIds}");
    }

    private void StartEditItemCode(ItemDto item)
    {
        editingItemCodeId = item.Id;
        editingItemCode = item.Code;
        codeValidationError = null;
        StateHasChanged();
    }

    private void CancelItemCodeEdit()
    {
        editingItemCodeId = null;
        editingItemCode = null;
        codeValidationError = null;
        StateHasChanged();
    }

    private async Task SaveItemCode(int itemId)
    {
        codeValidationError = null;
        if (string.IsNullOrWhiteSpace(editingItemCode))
        {
            codeValidationError = "Mã không được để trống";
            StateHasChanged();
            return;
        }
        if (editingItemCode!.Length > 4)
        {
            codeValidationError = "Mã tối đa 4 ký tự";
            StateHasChanged();
            return;
        }
        if (!System.Text.RegularExpressions.Regex.IsMatch(editingItemCode, @"^[a-zA-Z0-9]+$"))
        {
            codeValidationError = "Mã chỉ được chứa chữ và số";
            StateHasChanged();
            return;
        }
        // Check uniqueness within order
        if (model?.items != null && model.items.Any(i => i.Id != itemId && i.Code.Equals(editingItemCode, StringComparison.OrdinalIgnoreCase)))
        {
            codeValidationError = "Mã đã tồn tại trong lệnh này";
            StateHasChanged();
            return;
        }
        var dto = new UpdateItemCodeDto
        {
            Code = editingItemCode
        };
        var success = await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/items/{itemId}/code", dto));
        if (success)
        {
            editingItemCodeId = null;
            editingItemCode = null;
            codeValidationError = null;
        }
    }

    private void OpenCancelModal()
    {
        cancelConfirmInput = string.Empty;
        showCancelConfirm = true;
        StateHasChanged();
    }

    private void CloseCancelModal()
    {
        showCancelConfirm = false;
        cancelConfirmInput = null;
        StateHasChanged();
    }

    private bool CanConfirmCancel =>
        showCancelConfirm && !string.IsNullOrWhiteSpace(model?.order?.Code) &&
        string.Equals(cancelConfirmInput?.Trim(), model!.order!.Code, StringComparison.OrdinalIgnoreCase);

    private async Task CancelConfirmed()
    {
        var success = await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/cancel", null));
        if (success)
        {
            showCancelConfirm = false;
            cancelConfirmInput = null;
            StateHasChanged();
        }
    }


    private void OpenPlanModal()
    {
        plannedStartDate = model?.order?.PlannedStartDate;
        plannedFinishDate = model?.order?.PlannedFinishDate;
        showPlanModal = true;
        StateHasChanged();
    }

    private void ClosePlanModal()
    {
        showPlanModal = false;
        StateHasChanged();
    }

    private async Task SavePlan()
    {
        var dto = new UpdateOrderPlanDto
        {
            PlannedStartDate = plannedStartDate,
            PlannedFinishDate = plannedFinishDate
        };
        var success = await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/orders/{Id}/plan", dto));
        if (success)
        {
            ClosePlanModal();
        }
    }

    private async Task Submit() => await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/submit", null));
    private bool showFinishConfirm = false;
    private void ConfirmFinish() { showFinishConfirm = true; StateHasChanged(); }
    private void CancelFinishConfirm() { showFinishConfirm = false; StateHasChanged(); }
    private async Task FinishConfirmed()
    {
        var success = await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/finish", null));
        if (success)
        {
            showFinishConfirm = false;
            StateHasChanged();
        }
    }

    private string GetProgress(ItemDto item)
    {
        var stages = item.Stages ?? new();
        if (!stages.Any())
        {
            var totalHoursEmpty = item.ActualTimeHours ?? 0;
            return $"0% ({totalHoursEmpty:F1}h)";
        }

        var completedStages = stages.Count(s => s.IsCompleted);
        var percentage = stages.Count == 0 ? 0 : (completedStages * 100.0) / stages.Count;
        var totalHours = item.ActualTimeHours ?? 0;

        return $"{percentage:F0}% ({totalHours:F1}h)";
    }

    private MarkupString GetPlanInfoMarkup(ItemDto item) =>
        BuildScheduleMarkup(item.PlannedStartDate, item.PlannedFinishDate, item.PlannedTimeHours);

    private MarkupString GetActualInfoMarkup(ItemDto item) =>
        BuildScheduleMarkup(item.ActualStartDate, item.ActualFinishDate, item.ActualTimeHours);

    private MarkupString BuildScheduleMarkup(DateTime? start, DateTime? finish, decimal? hours)
    {
        var sb = new StringBuilder();
        sb.Append("<small>");

        sb.Append($"<div>Bắt đầu: {FormatDate(start)}</div>");
        sb.Append($"<div>Kết thúc: {FormatDate(finish)}</div>");

        if (hours.HasValue)
        {
            sb.Append($"<div>Giờ: {hours.Value:F1}h</div>");
        }

        sb.Append("</small>");
        return new MarkupString(sb.ToString());
    }

    private string GetLateTooltip(ItemDto item)
    {
        if (!item.IsLate) return string.Empty;
        if (item.IsOverdue && item.DaysLate > 0)
        {
            return $"Đã quá hạn kế hoạch {item.DaysLate} ngày";
        }
        if (item.IsOverdue)
        {
            return "Đã quá hạn kế hoạch";
        }
        if (item.DaysLate > 0)
        {
            return $"Kết thúc trễ {item.DaysLate} ngày";
        }
        return "Trễ kế hoạch";
    }

    private MarkupString GetDifferenceInfo(ItemDto item)
    {
        var sb = new StringBuilder();
        sb.Append("<small>");
        
        // Chênh lệch về giờ
        if (item.PlannedTimeHours.HasValue && item.ActualTimeHours.HasValue)
        {
            var hourDiff = item.ActualTimeHours.Value - item.PlannedTimeHours.Value;
            var hourClass = hourDiff > 0 ? "text-danger" : (hourDiff < 0 ? "text-success" : "");
            var hourSign = hourDiff > 0 ? "+" : "";
            sb.Append($"<div class=\"{hourClass}\">Giờ: {hourSign}{hourDiff:F1}h</div>");
        }
        
        // Chênh lệch về ngày kết thúc
        if (item.PlannedFinishDate.HasValue && item.ActualFinishDate.HasValue)
        {
            var dateDiff = (item.ActualFinishDate.Value - item.PlannedFinishDate.Value).TotalDays;
            var dateClass = dateDiff > 0 ? "text-danger" : (dateDiff < 0 ? "text-success" : "");
            var dateSign = dateDiff > 0 ? "+" : "";
            var days = (int)Math.Ceiling(Math.Abs(dateDiff));
            sb.Append($"<div class=\"{dateClass}\">Ngày: {dateSign}{days} ngày</div>");
        }
        else if (item.PlannedFinishDate.HasValue && !item.ActualFinishDate.HasValue)
        {
            var now = DateTime.UtcNow;
            if (now > item.PlannedFinishDate.Value)
            {
                var days = (int)Math.Ceiling((now - item.PlannedFinishDate.Value).TotalDays);
                sb.Append($"<div class=\"text-danger\">Ngày: +{days} ngày</div>");
            }
        }
        
        sb.Append("</small>");
        return new MarkupString(sb.ToString());
    }

    private int TotalItems => model?.items?.Count ?? 0;
    private int CompletedItems => model?.items?.Count(i => i.IsCompleted) ?? 0;
    private decimal TotalPlannedHours => model?.items?.Sum(i => i.PlannedTimeHours ?? 0) ?? 0;
    private decimal TotalActualHours => model?.items?.Sum(i => i.ActualTimeHours ?? 0) ?? 0;

    private readonly List<(string Value, string Label)> ItemStatusOptions = new()
    {
        ("chua_hoan_thanh", "Chưa hoàn thành"),
        ("da_hoan_thanh", "Đã hoàn thành"),
        ("da_luu_kho", "Đã lưu kho")
    };

    private string GetItemStatusFilterLabel()
    {
        if (!itemStatusFilters.Any()) return "Tất cả trạng thái";
        if (itemStatusFilters.Count == 1)
        {
            var v = itemStatusFilters.First();
            var label = ItemStatusOptions.FirstOrDefault(o => o.Value == v).Label;
            return label ?? "1 trạng thái";
        }
        return $"{itemStatusFilters.Count} trạng thái";
    }

    private void ToggleItemStatusFilter(string value, bool isChecked)
    {
        if (isChecked)
            itemStatusFilters.Add(value);
        else
            itemStatusFilters.Remove(value);
    }

    private IEnumerable<ItemDto> GetFilteredItems()
    {
        var items = model?.items ?? Enumerable.Empty<ItemDto>();
        
        // Apply search filter
        if (!string.IsNullOrWhiteSpace(itemSearch))
        {
            var searchLower = itemSearch.ToLower();
            items = items.Where(it => 
                (it.Code?.ToLower().Contains(searchLower) ?? false) ||
                (it.CavityCode?.ToLower().Contains(searchLower) ?? false) ||
                (it.CavityName?.ToLower().Contains(searchLower) ?? false)
            );
        }
        
        // Apply status filter
        if (itemStatusFilters.Any())
        {
            items = items.Where(it =>
                (itemStatusFilters.Contains("chua_hoan_thanh") && !it.IsCompleted) ||
                (itemStatusFilters.Contains("da_hoan_thanh") && it.IsCompleted && !it.IsStored) ||
                (itemStatusFilters.Contains("da_luu_kho") && it.IsCompleted && it.IsStored));
        }
        
        return items;
    }
    private async Task DirectorApprove() => await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/director/approve", null));
    private async Task DirectorReject() => await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/director/reject", null));
    private async Task RevertToDraft() => await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/revert-to-draft", null));
    private async Task QaMachines() => await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/qa/machines-approve", null));
    private async Task QaMaterial() => await ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{Id}/qa/material-approve", null));

    private bool showCostModal;

    private void OpenCostModal()
    {
        showCostModal = true;
        StateHasChanged();
    }

    private void CloseCostModal()
    {
        showCostModal = false;
        StateHasChanged();
    }

    private void OpenAssignQaModal()
    {
        showAssignQaModal = true;
        qaSearch = null;
        qaUsers = null;
        _ = LoadQaUsers();
        StateHasChanged();
    }

    private void CloseAssignQaModal()
    {
        showAssignQaModal = false;
        qaSearch = null;
        qaUsers = null;
        StateHasChanged();
    }

    private async Task LoadQaUsers()
    {
        try
        {
            var query = new List<string> { "scope=order" };
            if (!string.IsNullOrWhiteSpace(qaSearch))
            {
                query.Add($"q={Uri.EscapeDataString(qaSearch!)}");
            }
            var url = "/api/lookup/qa-users" + (query.Any() ? "?" + string.Join("&", query) : "");
            qaUsers = await Http.GetFromJsonAsync<List<QaUser>>(url) ?? new();
        }
        catch
        {
            qaUsers = new();
        }
        StateHasChanged();
    }

    private async Task OnQaSearchChanged()
    {
        await LoadQaUsers();
    }

    private async Task SelectOrderQa(int qaUserId)
    {
        await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/orders/{Id}/assign-qa", new AssignQaOrderDto { QaUserId = qaUserId }));
        await Load();
        CloseAssignQaModal();
    }

    private class OrderDetailsResponse
    {
        public ProductionOrder? order { get; set; }
        public string? orderQaName { get; set; }
        public List<ItemDto> items { get; set; } = new();
        public List<ProgressPointDto> ProgressTimeline { get; set; } = new();
    }
    private class ItemDto
    {
        public int Id { get; set; }
        public int CavityId { get; set; }
        public string? CavityCode { get; set; }
        public string? CavityName { get; set; }
        public string Code { get; set; } = string.Empty;
        public int LineNo { get; set; }
        public string? QRCode { get; set; }
        public bool IsCompleted { get; set; }
        public bool IsStored { get; set; }
        public DateTime? PlannedStartDate { get; set; }
        public DateTime? PlannedFinishDate { get; set; }
        public DateTime? ActualStartDate { get; set; }
        public DateTime? ActualFinishDate { get; set; }
        public decimal? PlannedTimeHours { get; set; }
        public decimal? ActualTimeHours { get; set; }
        public bool NeedsQa { get; set; }
        public int CompletedStages { get; set; }
        public int TotalStages { get; set; }
        public List<StageDto>? Stages { get; set; }
        public bool IsLate { get; set; }
        public bool IsOverdue { get; set; }
        public int DaysLate { get; set; }
    }
    private class QaUser
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? Phone { get; set; }
        public int PendingItemsCount { get; set; }
        public int PendingMachinesCount { get; set; }
        public int PendingMaterialCount { get; set; }
        public int PendingStagesCount { get; set; }
    }

    private string GetQaWorkloadText(QaUser qa)
    {
        var total = qa.PendingItemsCount;
        if (total <= 0)
        {
            return "Rảnh";
        }

        var parts = new List<string>
        {
            $"Còn {total} việc"
        };

        if (qa.PendingMachinesCount > 0)
        {
            parts.Add($"KT máy: {qa.PendingMachinesCount}");
        }

        if (qa.PendingMaterialCount > 0)
        {
            parts.Add($"KT vật tư: {qa.PendingMaterialCount}");
        }

        if (qa.PendingStagesCount > 0)
        {
            parts.Add($"KT công đoạn: {qa.PendingStagesCount}");
        }

        return string.Join(" | ", parts);
    }

    private class StageDto
    {
        public int Id { get; set; }
        public bool IsCompleted { get; set; }
        public decimal? PlannedTimeHours { get; set; }
        public decimal? ActualTimeHours { get; set; }
    }

    private class ProgressPointDto
    {
        public DateTime Date { get; set; }
        public int CompletedCount { get; set; }
    }
}

@* Finish Confirmation Modal *@
@if (showFinishConfirm)
{
    var hasIncompleteItems = model?.items?.Any(i => !i.IsCompleted) ?? false;
    var hasUnstoredItems = model?.items?.Any(i => i.IsCompleted && !i.IsStored) ?? false;

    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận hoàn tất</h5>
                    <button type="button" class="btn-close" @onclick="CancelFinishConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn hoàn tất lệnh sản xuất này?</p>
                    @if (hasIncompleteItems)
                    {
                        <div class="alert alert-danger mb-2">
                            <strong>Vẫn còn sản phẩm chưa hoàn thành</strong>
                        </div>
                    }
                    @if (hasUnstoredItems)
                    {
                        <div class="alert alert-danger mb-0">
                            <strong>Vẫn còn sản phẩm chưa lưu kho</strong>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelFinishConfirm">Hủy</button>
                    <button type="button" class="btn btn-success" @onclick="FinishConfirmed">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
}

@* Plan Update Modal *@
@if (showPlanModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật kế hoạch</h5>
                    <button type="button" class="btn-close" @onclick="ClosePlanModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ngày bắt đầu dự kiến</label>
                        <input type="datetime-local" class="form-control" @bind="plannedStartDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ngày kết thúc dự kiến</label>
                        <input type="datetime-local" class="form-control" @bind="plannedFinishDate" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePlanModal">Hủy</button>
                    <button type="button" class="btn btn-primary" @onclick="SavePlan">Lưu</button>
                </div>
            </div>
        </div>
    </div>
}

@* Cancel Confirmation Modal *@
@if (showCancelConfirm && model?.order is not null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận hủy lệnh</h5>
                    <button type="button" class="btn-close" @onclick="CloseCancelModal"></button>
                </div>
                <div class="modal-body">
                    <p>Nhập chính xác mã lệnh <strong>@model.order.Code</strong> để xác nhận hủy.</p>
                    <input class="form-control" placeholder="Nhập mã lệnh" @bind="cancelConfirmInput" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCancelModal">Thoát</button>
                    <button type="button" class="btn btn-danger" disabled="@(!CanConfirmCancel)" @onclick="CancelConfirmed">Hủy lệnh</button>
                </div>
            </div>
        </div>
    </div>
}


