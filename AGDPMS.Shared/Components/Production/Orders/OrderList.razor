@page "/production/orders"
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Models.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">Lệnh sản xuất</li>
        </ol>
    </nav>
    <div class="d-flex align-items-center gap-2 mb-3">
        <input class="form-control" style="max-width:320px" placeholder="Tìm kiếm..." @bind-value="search" @bind-value:event="oninput" @bind-value:after="OnSearchChanged" />
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                @GetStatusFilterLabel()
            </button>
            <ul class="dropdown-menu p-2" style="min-width: 260px;">
                @foreach (var opt in StatusOptions)
                {
                    <li class="form-check">
                        <input class="form-check-input" type="checkbox" id="st-opt-@opt.Value"
                               checked="@stageStatusFilters.Contains(opt.Value)"
                               @onchange="(e => ToggleStatusFilter(opt.Value, (bool)e.Value))" />
                        <label class="form-check-label" for="st-opt-@opt.Value">@opt.Label</label>
                    </li>
                }
            </ul>
        </div>
        @if (IsProductionManager())
        {
            <button class="btn btn-primary" @onclick="Create">Tạo mới</button>
        }
        @if (IsProductionManager() || IsDirector())
        {
            <button class="btn btn-outline-secondary" @onclick='@(() => Nav.NavigateTo("/production/orders/settings"))'>Cài đặt</button>
        }
    </div>

    <div class="table-responsive" style="max-height:60vh; overflow:auto;">
        <table class="table table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th role="button" @onclick='@(() => SortBy("code"))'>Mã lệnh @SortIcon("code")</th>
                    <th>Dự án</th>
                    <th>Trạng thái</th>
                    <th>QA</th>
                    <th>Kế hoạch</th>
                    <th role="button" @onclick='@(() => SortBy("created_at"))'>Ngày tạo @SortIcon("created_at")</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (orders is null)
                {
                    <tr><td colspan="6">Đang tải...</td></tr>
                }
                else if (!orders.Any())
                {
                    <tr><td colspan="6">Không có dữ liệu. @errorMessage</td></tr>
                }
                else
                {
                    @foreach (var o in orders)
                    {
                        var projectName = GetProjectName(o.ProjectId);
                        var rowClass = (IsQa() && o.HasPendingQa) ? "table-warning" : string.Empty;
                        <tr class="@rowClass">
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@o.Code</td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@projectName</td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@GetStatusDisplay(o)</td>
                            <td class="text-nowrap" @onclick:stopPropagation="true">
                                @if (CanAssignQa(o))
                                {
                                    <button class="btn btn-link p-0" @onclick='@(() => OpenAssignQaModal(o))'>
                                        @(string.IsNullOrWhiteSpace(o.AssignedQaUserName) ? "Chưa phân công" : o.AssignedQaUserName)
                                    </button>
                                }
                                else
                                {
                                    <span>@(string.IsNullOrWhiteSpace(o.AssignedQaUserName) ? "-" : o.AssignedQaUserName)</span>
                                }
                            </td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">
                                @if (o.PlannedStartDate.HasValue || o.PlannedFinishDate.HasValue)
                                {
                                    <small>
                                        @if (o.PlannedStartDate.HasValue)
                                        {
                                            <div>Bắt đầu: @FormatDate(o.PlannedStartDate)</div>
                                        }
                                        @if (o.PlannedFinishDate.HasValue)
                                        {
                                            <div>Kết thúc: @FormatDate(o.PlannedFinishDate)</div>
                                        }
                                    </small>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@FormatDate(o.CreatedAt)</td>
                            <td class="text-nowrap" @onclick:stopPropagation="true">
                                @if (ShouldShowButton("Submit", o))
                                {
                                    <button class="btn btn-outline-primary btn-sm" @onclick='@(() => SubmitOrder(o.Id))' title="Gửi giám đốc duyệt">Gửi duyệt</button>
                                }
                                @if (ShouldShowButton("RevertToDraft", o))
                                {
                                    <button class="btn btn-outline-secondary btn-sm" @onclick='@(() => RevertToDraftOrder(o.Id))' title="Hủy yêu cầu duyệt, quay lại nháp">Hủy xin duyệt</button>
                                }
                                @if (ShouldShowButton("Finish", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(async () => await OpenFinishConfirm(o.Id))' title="Hoàn tất lệnh">Hoàn tất</button>
                                }
                                @if (ShouldShowButton("DirectorApprove", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => DirectorApproveOrder(o.Id))' title="Giám đốc phê duyệt">Duyệt Lệnh</button>
                                }
                                @if (ShouldShowButton("DirectorReject", o))
                                {
                                    <button class="btn btn-outline-danger btn-sm" @onclick='@(() => DirectorRejectOrder(o.Id))' title="Giám đốc từ chối">Từ chối Lệnh</button>
                                }
                                @if (ShouldShowButton("QaMachines", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => QaMachinesOrder(o.Id))' title="QA xác nhận máy móc">Xác nhận đã kiểm tra máy</button>
                                }
                                @if (ShouldShowButton("QaMaterial", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => QaMaterialOrder(o.Id))' title="QA xác nhận vật tư">Xác nhận đã kiểm tra vật tư</button>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

@if (showAssignQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Phân công QA cho lệnh @assignQaOrderCode</h5>
                    <button type="button" class="btn-close" @onclick="CloseAssignQaModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <input class="form-control" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="OnQaSearchChanged" />
                        </div>
                    </div>
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div class="px-2">Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div class="px-2">Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            var sortedQa = qaUsers.OrderBy(q => q.PendingItemsCount).ThenBy(q => q.Name).ToList();
                            var minCount = sortedQa.FirstOrDefault()?.PendingItemsCount ?? 0;
                            @foreach (var qa in sortedQa)
                            {
                                var isRecommended = qa.PendingItemsCount == minCount && sortedQa.Count > 1;
                                <button type="button" class="list-group-item list-group-item-action @(isRecommended ? "border-primary border-2" : "")" @onclick='@(() => SelectOrderQa(qa.Id))'>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div>
                                                <strong>@qa.Name</strong>
                                                @if (isRecommended)
                                                {
                                                    <span class="badge bg-primary ms-2">Đề xuất</span>
                                                }
                                            </div>
                                            <small class="text-muted">@qa.Phone</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">@qa.PendingItemsCount trạng thái QA chưa review</span>
                                        </div>
                                    </div>
                                </button>
                            }
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseAssignQaModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}
</div>

@* Finish Confirmation Modal *@
@if (showFinishConfirm)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận hoàn tất</h5>
                    <button type="button" class="btn-close" @onclick="CloseFinishConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn hoàn tất lệnh sản xuất này?</p>
                    @if (finishCheckLoading)
                    {
                        <div class="alert alert-info mb-0">
                            Đang kiểm tra trạng thái sản phẩm...
                        </div>
                    }
                    else if (!string.IsNullOrWhiteSpace(finishCheckError))
                    {
                        <div class="alert alert-danger mb-0">
                            <strong>Lỗi:</strong> @finishCheckError
                        </div>
                    }
                    else
                    {
                        @if (hasIncompleteItemsPending == true)
                        {
                            <div class="alert alert-danger mb-2">
                                <strong>Vẫn còn sản phẩm chưa hoàn thành</strong>
                            </div>
                        }
                        @if (hasUnstoredItemsPending == true)
                        {
                            <div class="alert alert-danger mb-0">
                                <strong>Vẫn còn sản phẩm chưa lưu kho</strong>
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseFinishConfirm">Hủy</button>
                    <button type="button" class="btn btn-success" @onclick="ConfirmFinish">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<OrderRow>? orders;
    private HashSet<int> stageStatusFilters = new();
    private string? search;
    private string sort = "created_at";
    private string dir = "desc";
    private string? errorMessage;
    private string? userRole;
    private bool finishCheckLoading;
    private bool? hasIncompleteItemsPending;
    private bool? hasUnstoredItemsPending;
    private string? finishCheckError;
    private bool showAssignQaModal;
    private int? assignQaOrderId;
    private string? assignQaOrderCode;
    private string? qaSearch;
    private List<QaUser>? qaUsers;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRole();
        await LoadOrders();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task LoadOrders()
    {
        errorMessage = null;
        try
        {
            var queryParams = new List<string>();
            if (!string.IsNullOrWhiteSpace(search))
                queryParams.Add($"q={Uri.EscapeDataString(search)}");
            queryParams.Add($"sort={sort}");
            queryParams.Add($"dir={dir}");
            if (stageStatusFilters.Any())
                queryParams.Add($"statuses={string.Join(",", stageStatusFilters)}");
            var url = "/api/orders" + (queryParams.Any() ? "?" + string.Join("&", queryParams) : "");
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                orders = await response.Content.ReadFromJsonAsync<List<OrderRow>>() ?? new();
            }
            else
            {
                errorMessage = $"Lỗi: {response.StatusCode}";
                orders = new();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
            orders = new();
        }
    }

    private async Task ToggleStatusFilter(int value, bool isChecked)
    {
        if (isChecked)
            stageStatusFilters.Add(value);
        else
            stageStatusFilters.Remove(value);
        await LoadOrders();
    }

    private async Task Create()
    {
        Nav.NavigateTo("/production/orders/create");
        await Task.CompletedTask;
    }

    private async Task SortBy(string column)
    {
        if (sort == column)
            dir = dir == "asc" ? "desc" : "asc";
        else
        {
            sort = column;
            dir = column == "created_at" ? "desc" : "asc";
        }
        await LoadOrders();
    }

    private async Task OnSearchChanged()
    {
        await LoadOrders();
    }

    private MarkupString SortIcon(string column)
    {
        if (sort != column) return (MarkupString)"";
        var icon = dir == "asc" ? "▲" : "▼";
        return (MarkupString)$"<span class=\"ms-1\">{icon}</span>";
    }

    private readonly List<(int Value, string Label)> StatusOptions = new()
    {
        ((int)ProductionOrderStatus.Draft, "Nháp"),
        ((int)ProductionOrderStatus.PendingDirectorApproval, "Chờ giám đốc duyệt"),
        ((int)ProductionOrderStatus.DirectorRejected, "Giám đốc từ chối"),
        ((int)ProductionOrderStatus.PendingQACheckMachines, "Chờ QA kiểm tra máy"),
        ((int)ProductionOrderStatus.PendingQACheckMaterial, "Chờ QA kiểm tra vật tư"),
        ((int)ProductionOrderStatus.InProduction, "Đang sản xuất"),
        ((int)ProductionOrderStatus.Finished, "Hoàn thành"),
        ((int)ProductionOrderStatus.Cancelled, "Đã hủy")
    };

    private string GetStatusFilterLabel()
    {
        if (!stageStatusFilters.Any()) return "Tất cả trạng thái";
        if (stageStatusFilters.Count == 1)
        {
            var val = stageStatusFilters.First();
            var match = StatusOptions.FirstOrDefault(o => o.Value == val);
            return match.Label ?? "1 trạng thái";
        }
        return $"{stageStatusFilters.Count} trạng thái";
    }

    private bool CanAssignQa(OrderRow order) =>
        (IsProductionManager() || IsDirector()) &&
        order.Status is ProductionOrderStatus.Draft or ProductionOrderStatus.PendingDirectorApproval or ProductionOrderStatus.PendingQACheckMachines or ProductionOrderStatus.PendingQACheckMaterial or ProductionOrderStatus.InProduction;

    private void OpenAssignQaModal(OrderRow order)
    {
        assignQaOrderId = order.Id;
        assignQaOrderCode = order.Code;
        qaSearch = null;
        qaUsers = null;
        showAssignQaModal = true;
        _ = LoadQaUsers();
        StateHasChanged();
    }

    private void CloseAssignQaModal()
    {
        showAssignQaModal = false;
        assignQaOrderId = null;
        assignQaOrderCode = null;
        qaSearch = null;
        qaUsers = null;
        StateHasChanged();
    }

    private async Task OnQaSearchChanged()
    {
        await LoadQaUsers();
    }

    private async Task LoadQaUsers()
    {
        try
        {
            var query = new List<string> { "scope=order" };
            if (!string.IsNullOrWhiteSpace(qaSearch))
            {
                query.Add($"q={Uri.EscapeDataString(qaSearch!)}");
            }
            var url = "/api/lookup/qa-users" + (query.Any() ? "?" + string.Join("&", query) : "");
            qaUsers = await Http.GetFromJsonAsync<List<QaUser>>(url) ?? new();
        }
        catch
        {
            qaUsers = new();
        }
        StateHasChanged();
    }

    private async Task SelectOrderQa(int qaUserId)
    {
        if (!assignQaOrderId.HasValue) return;
        await ExecuteOrderAction(() => Http.PutAsJsonAsync($"/api/orders/{assignQaOrderId.Value}/assign-qa", new AssignQaOrderDto { QaUserId = qaUserId }));
        CloseAssignQaModal();
    }

    private string GetProjectName(int projectId)
    {
        // Project name will be loaded from API response if needed
        return $"Dự án {projectId}";
    }

    private bool ShouldShowButton(string buttonName, OrderRow order)
    {
        return buttonName switch
        {
            "Submit" => IsProductionManager() && CanSubmit(order),
            "RevertToDraft" => IsProductionManager() && CanRevertToDraft(order),
            "Finish" => IsProductionManager() && CanFinish(order),
            "DirectorApprove" => IsDirector() && CanDirectorApprove(order),
            "DirectorReject" => IsDirector() && CanDirectorReject(order),
            "QaMachines" => IsQa() && CanQaMachines(order),
            "QaMaterial" => IsQa() && CanQaMaterial(order),
            _ => false
        };
    }

    private bool CanSubmit(OrderRow order) => order.Status == ProductionOrderStatus.Draft;
    private bool CanRevertToDraft(OrderRow order) => order.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanFinish(OrderRow order) => order.Status == ProductionOrderStatus.InProduction;
    private bool CanDirectorApprove(OrderRow order) => order.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanDirectorReject(OrderRow order) => order.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanQaMachines(OrderRow order) => order.Status == ProductionOrderStatus.PendingQACheckMachines;
    private bool CanQaMaterial(OrderRow order) => order.Status == ProductionOrderStatus.PendingQACheckMaterial;

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsDirector() => HasRole("Admin") || HasRole("Director");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");

    private string GetStatusLabel(ProductionOrderStatus status) => status switch
    {
        ProductionOrderStatus.Draft => "Nháp",
        ProductionOrderStatus.PendingDirectorApproval => "Chờ giám đốc duyệt",
        ProductionOrderStatus.DirectorRejected => "Giám đốc từ chối",
        ProductionOrderStatus.PendingQACheckMachines => "Chờ QA kiểm tra máy",
        ProductionOrderStatus.PendingQACheckMaterial => "Chờ QA kiểm tra vật tư",
        ProductionOrderStatus.InProduction => "Đang sản xuất",
        ProductionOrderStatus.Finished => "Hoàn thành",
        ProductionOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    private string GetStatusDisplay(OrderRow order)
    {
        var label = GetStatusLabel(order.Status);
        var date = GetStatusDate(order);
        return date.HasValue ? $"{label} ({FormatDate(date)})" : label;
    }

    private DateTime? GetStatusDate(OrderRow order) => order.Status switch
    {
        ProductionOrderStatus.Draft => order.CreatedAt,
        ProductionOrderStatus.PendingDirectorApproval => order.SubmittedAt ?? order.CreatedAt,
        ProductionOrderStatus.DirectorRejected => order.DirectorDecisionAt,
        ProductionOrderStatus.PendingQACheckMachines => order.DirectorDecisionAt,
        ProductionOrderStatus.PendingQACheckMaterial => order.QAMachinesCheckedAt,
        ProductionOrderStatus.InProduction => order.StartedAt ?? order.QAMaterialCheckedAt,
        ProductionOrderStatus.Finished => order.FinishedAt,
        ProductionOrderStatus.Cancelled => order.UpdatedAt ?? order.FinishedAt ?? order.StartedAt ?? order.CreatedAt,
        _ => null
    };

    private string FormatDate(DateTime? value) => value.HasValue ? value.Value.ToString("dd/MM/yyyy HH:mm") : "-";

    private async Task ExecuteOrderAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await LoadOrders();
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
    }

    private Task SubmitOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/submit", null));
    private Task RevertToDraftOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/revert-to-draft", null));
    
    private bool showFinishConfirm = false;
    private int? pendingFinishOrderId;
    private async Task OpenFinishConfirm(int orderId)
    {
        pendingFinishOrderId = orderId;
        showFinishConfirm = true;
        finishCheckLoading = true;
        finishCheckError = null;
        hasIncompleteItemsPending = null;
        hasUnstoredItemsPending = null;
        StateHasChanged();
        await LoadFinishStatus(orderId);
    }
    private void CloseFinishConfirm()
    {
        showFinishConfirm = false;
        pendingFinishOrderId = null;
        finishCheckLoading = false;
        finishCheckError = null;
        hasIncompleteItemsPending = null;
        hasUnstoredItemsPending = null;
        StateHasChanged();
    }
    private async Task ConfirmFinish()
    {
        if (pendingFinishOrderId.HasValue)
        {
            await FinishOrder(pendingFinishOrderId.Value);
            CloseFinishConfirm();
        }
    }
    private Task FinishOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/finish", null));
    private async Task LoadFinishStatus(int orderId)
    {
        try
        {
            var response = await Http.GetAsync($"/api/orders/{orderId}");
            if (response.IsSuccessStatusCode)
            {
                var details = await response.Content.ReadFromJsonAsync<OrderDetailsResponse>();
                var items = details?.items ?? new();
                hasIncompleteItemsPending = items.Any(i => !i.IsCompleted);
                hasUnstoredItemsPending = items.Any(i => i.IsCompleted && !i.IsStored);
            }
            else
            {
                finishCheckError = $"Không thể kiểm tra trạng thái: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            finishCheckError = $"Lỗi khi kiểm tra trạng thái: {ex.Message}";
        }
        finally
        {
            finishCheckLoading = false;
            StateHasChanged();
        }
    }
    private Task DirectorApproveOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/director/approve", null));
    private Task DirectorRejectOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/director/reject", null));
    private Task QaMachinesOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/qa/machines-approve", null));
    private Task QaMaterialOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/qa/material-approve", null));

    private class OrderRow
    {
        public int Id { get; set; }
        public int ProjectId { get; set; }
        public string Code { get; set; } = string.Empty;
        public ProductionOrderStatus Status { get; set; }
        public int? AssignedQaUserId { get; set; }
        public string? AssignedQaUserName { get; set; }
        public DateTime? PlannedStartDate { get; set; }
        public DateTime? PlannedFinishDate { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? SubmittedAt { get; set; }
        public DateTime? DirectorDecisionAt { get; set; }
        public DateTime? QAMachinesCheckedAt { get; set; }
        public DateTime? QAMaterialCheckedAt { get; set; }
        public DateTime? StartedAt { get; set; }
        public DateTime? FinishedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public bool HasPendingQa { get; set; }
    }

    private class OrderDetailsResponse
    {
        public List<ItemDto> items { get; set; } = new();
    }

    private class ItemDto
    {
        public bool IsCompleted { get; set; }
        public bool IsStored { get; set; }
    }

    private class QaUser
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? Phone { get; set; }
        public int PendingItemsCount { get; set; }
    }
}


