@page "/production/orders"
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Models.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http
@using System.Security.Claims
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active">Lệnh sản xuất</li>
        </ol>
    </nav>
    <div class="d-flex align-items-center gap-2 mb-3">
        <input class="form-control" style="max-width:320px" placeholder="Tìm kiếm..." @bind-value="search" @bind-value:event="oninput" @bind-value:after="OnSearchChanged" />
        <select class="form-select" style="max-width:320px" @onchange="OnStageStatusChanged">
            <option value="">Tất cả trạng thái</option>
            <option value="0" selected="@(stageStatusFilter == 0)">Nháp</option>
            <option value="1" selected="@(stageStatusFilter == 1)">Chờ giám đốc duyệt</option>
            <option value="2" selected="@(stageStatusFilter == 2)">Giám đốc từ chối</option>
            <option value="3" selected="@(stageStatusFilter == 3)">Chờ QA kiểm tra máy</option>
            <option value="4" selected="@(stageStatusFilter == 4)">Chờ QA kiểm tra vật tư</option>
            <option value="5" selected="@(stageStatusFilter == 5)">Đang sản xuất</option>
            <option value="6" selected="@(stageStatusFilter == 6)">Hoàn thành</option>
            <option value="9" selected="@(stageStatusFilter == 9)">Đã hủy</option>
        </select>
        @if (IsProductionManager())
        {
            <button class="btn btn-primary" @onclick="Create">Tạo mới</button>
        }
    </div>

    <div class="table-responsive" style="max-height:60vh; overflow:auto;">
        <table class="table table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th role="button" @onclick='@(() => SortBy("code"))'>Mã lệnh @SortIcon("code")</th>
                    <th>Dự án</th>
                    <th>Trạng thái</th>
                    <th>Kế hoạch</th>
                    <th role="button" @onclick='@(() => SortBy("created_at"))'>Ngày tạo @SortIcon("created_at")</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (orders is null)
                {
                    <tr><td colspan="6">Đang tải...</td></tr>
                }
                else if (!orders.Any())
                {
                    <tr><td colspan="6">Không có dữ liệu. @errorMessage</td></tr>
                }
                else
                {
                    @foreach (var o in orders)
                    {
                        var projectName = GetProjectName(o.ProjectId);
                        var rowClass = (IsQa() && o.HasPendingQa) ? "table-warning" : string.Empty;
                        <tr class="@rowClass">
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@o.Code</td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@projectName</td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@GetStatusDisplay(o)</td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">
                                @if (o.PlannedStartDate.HasValue || o.PlannedFinishDate.HasValue)
                                {
                                    <small>
                                        @if (o.PlannedStartDate.HasValue)
                                        {
                                            <div>Bắt đầu: @FormatDate(o.PlannedStartDate)</div>
                                        }
                                        @if (o.PlannedFinishDate.HasValue)
                                        {
                                            <div>Kết thúc: @FormatDate(o.PlannedFinishDate)</div>
                                        }
                                    </small>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td @onclick='@(() => Nav.NavigateTo($"/production/orders/{o.Id}"))' style="cursor:pointer;">@FormatDate(o.CreatedAt)</td>
                            <td class="text-nowrap" @onclick:stopPropagation="true">
                                @if (ShouldShowButton("Submit", o))
                                {
                                    <button class="btn btn-outline-primary btn-sm" @onclick='@(() => SubmitOrder(o.Id))' title="Gửi giám đốc duyệt">Gửi duyệt</button>
                                }
                                @if (ShouldShowButton("RevertToDraft", o))
                                {
                                    <button class="btn btn-outline-secondary btn-sm" @onclick='@(() => RevertToDraftOrder(o.Id))' title="Hủy yêu cầu duyệt, quay lại nháp">Hủy xin duyệt</button>
                                }
                                @if (ShouldShowButton("Finish", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => OpenFinishConfirm(o.Id))' title="Hoàn tất lệnh">Hoàn tất</button>
                                }
                                @if (ShouldShowButton("DirectorApprove", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => DirectorApproveOrder(o.Id))' title="Giám đốc phê duyệt">Duyệt Lệnh</button>
                                }
                                @if (ShouldShowButton("DirectorReject", o))
                                {
                                    <button class="btn btn-outline-danger btn-sm" @onclick='@(() => DirectorRejectOrder(o.Id))' title="Giám đốc từ chối">Từ chối Lệnh</button>
                                }
                                @if (ShouldShowButton("QaMachines", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => QaMachinesOrder(o.Id))' title="QA xác nhận máy móc">Xác nhận đã kiểm tra máy</button>
                                }
                                @if (ShouldShowButton("QaMaterial", o))
                                {
                                    <button class="btn btn-outline-success btn-sm" @onclick='@(() => QaMaterialOrder(o.Id))' title="QA xác nhận vật tư">Xác nhận đã kiểm tra vật tư</button>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@* Finish Confirmation Modal *@
@if (showFinishConfirm)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận hoàn tất</h5>
                    <button type="button" class="btn-close" @onclick="CloseFinishConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn hoàn tất lệnh sản xuất này?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseFinishConfirm">Hủy</button>
                    <button type="button" class="btn btn-success" @onclick="ConfirmFinish">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<OrderRow>? orders;
    private int? stageStatusFilter;
    private string? search;
    private string sort = "created_at";
    private string dir = "desc";
    private string? errorMessage;
    private string? userRole;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRole();
        await LoadOrders();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task LoadOrders()
    {
        errorMessage = null;
        try
        {
            var queryParams = new List<string>();
            if (!string.IsNullOrWhiteSpace(search))
                queryParams.Add($"q={Uri.EscapeDataString(search)}");
            queryParams.Add($"sort={sort}");
            queryParams.Add($"dir={dir}");
            if (stageStatusFilter.HasValue)
                queryParams.Add($"status={stageStatusFilter.Value}");
            var url = "/api/orders" + (queryParams.Any() ? "?" + string.Join("&", queryParams) : "");
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                orders = await response.Content.ReadFromJsonAsync<List<OrderRow>>() ?? new();
            }
            else
            {
                errorMessage = $"Lỗi: {response.StatusCode}";
                orders = new();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
            orders = new();
        }
    }

    private async Task OnStageStatusChanged(ChangeEventArgs e)
    {
        var val = e.Value?.ToString();
        stageStatusFilter = int.TryParse(val, out var status) ? status : null;
        await LoadOrders();
    }

    private async Task Create()
    {
        Nav.NavigateTo("/production/orders/create");
        await Task.CompletedTask;
    }

    private async Task SortBy(string column)
    {
        if (sort == column)
            dir = dir == "asc" ? "desc" : "asc";
        else
        {
            sort = column;
            dir = column == "created_at" ? "desc" : "asc";
        }
        await LoadOrders();
    }

    private async Task OnSearchChanged()
    {
        await LoadOrders();
    }

    private MarkupString SortIcon(string column)
    {
        if (sort != column) return (MarkupString)"";
        var icon = dir == "asc" ? "▲" : "▼";
        return (MarkupString)$"<span class=\"ms-1\">{icon}</span>";
    }

    private string GetProjectName(int projectId)
    {
        // Project name will be loaded from API response if needed
        return $"Dự án {projectId}";
    }

    private bool ShouldShowButton(string buttonName, OrderRow order)
    {
        return buttonName switch
        {
            "Submit" => IsProductionManager() && CanSubmit(order),
            "RevertToDraft" => IsProductionManager() && CanRevertToDraft(order),
            "Finish" => IsProductionManager() && CanFinish(order),
            "DirectorApprove" => IsDirector() && CanDirectorApprove(order),
            "DirectorReject" => IsDirector() && CanDirectorReject(order),
            "QaMachines" => IsQa() && CanQaMachines(order),
            "QaMaterial" => IsQa() && CanQaMaterial(order),
            _ => false
        };
    }

    private bool CanSubmit(OrderRow order) => order.Status == ProductionOrderStatus.Draft;
    private bool CanRevertToDraft(OrderRow order) => order.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanFinish(OrderRow order) => order.Status == ProductionOrderStatus.InProduction;
    private bool CanDirectorApprove(OrderRow order) => order.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanDirectorReject(OrderRow order) => order.Status == ProductionOrderStatus.PendingDirectorApproval;
    private bool CanQaMachines(OrderRow order) => order.Status == ProductionOrderStatus.PendingQACheckMachines;
    private bool CanQaMaterial(OrderRow order) => order.Status == ProductionOrderStatus.PendingQACheckMaterial;

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsDirector() => HasRole("Admin") || HasRole("Director");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");

    private string GetStatusLabel(ProductionOrderStatus status) => status switch
    {
        ProductionOrderStatus.Draft => "Nháp",
        ProductionOrderStatus.PendingDirectorApproval => "Chờ giám đốc duyệt",
        ProductionOrderStatus.DirectorRejected => "Giám đốc từ chối",
        ProductionOrderStatus.PendingQACheckMachines => "Chờ QA kiểm tra máy",
        ProductionOrderStatus.PendingQACheckMaterial => "Chờ QA kiểm tra vật tư",
        ProductionOrderStatus.InProduction => "Đang sản xuất",
        ProductionOrderStatus.Finished => "Hoàn thành",
        ProductionOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    private string GetStatusDisplay(OrderRow order)
    {
        var label = GetStatusLabel(order.Status);
        var date = GetStatusDate(order);
        return date.HasValue ? $"{label} ({FormatDate(date)})" : label;
    }

    private DateTime? GetStatusDate(OrderRow order) => order.Status switch
    {
        ProductionOrderStatus.Draft => order.CreatedAt,
        ProductionOrderStatus.PendingDirectorApproval => order.SubmittedAt ?? order.CreatedAt,
        ProductionOrderStatus.DirectorRejected => order.DirectorDecisionAt,
        ProductionOrderStatus.PendingQACheckMachines => order.DirectorDecisionAt,
        ProductionOrderStatus.PendingQACheckMaterial => order.QAMachinesCheckedAt,
        ProductionOrderStatus.InProduction => order.StartedAt ?? order.QAMaterialCheckedAt,
        ProductionOrderStatus.Finished => order.FinishedAt,
        ProductionOrderStatus.Cancelled => order.UpdatedAt ?? order.FinishedAt ?? order.StartedAt ?? order.CreatedAt,
        _ => null
    };

    private string FormatDate(DateTime? value) => value.HasValue ? value.Value.ToString("dd/MM/yyyy HH:mm") : "-";

    private async Task ExecuteOrderAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await LoadOrders();
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
    }

    private Task SubmitOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/submit", null));
    private Task RevertToDraftOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/revert-to-draft", null));
    
    private bool showFinishConfirm = false;
    private int? pendingFinishOrderId;
    private void OpenFinishConfirm(int orderId)
    {
        pendingFinishOrderId = orderId;
        showFinishConfirm = true;
        StateHasChanged();
    }
    private void CloseFinishConfirm()
    {
        showFinishConfirm = false;
        pendingFinishOrderId = null;
        StateHasChanged();
    }
    private async Task ConfirmFinish()
    {
        if (pendingFinishOrderId.HasValue)
        {
            await FinishOrder(pendingFinishOrderId.Value);
            CloseFinishConfirm();
        }
    }
    private Task FinishOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/finish", null));
    private Task DirectorApproveOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/director/approve", null));
    private Task DirectorRejectOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/director/reject", null));
    private Task QaMachinesOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/qa/machines-approve", null));
    private Task QaMaterialOrder(int orderId) => ExecuteOrderAction(() => Http.PostAsync($"/api/orders/{orderId}/qa/material-approve", null));

    private class OrderRow
    {
        public int Id { get; set; }
        public int ProjectId { get; set; }
        public string Code { get; set; } = string.Empty;
        public ProductionOrderStatus Status { get; set; }
        public DateTime? PlannedStartDate { get; set; }
        public DateTime? PlannedFinishDate { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? SubmittedAt { get; set; }
        public DateTime? DirectorDecisionAt { get; set; }
        public DateTime? QAMachinesCheckedAt { get; set; }
        public DateTime? QAMaterialCheckedAt { get; set; }
        public DateTime? StartedAt { get; set; }
        public DateTime? FinishedAt { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public bool HasPendingQa { get; set; }
    }
}


