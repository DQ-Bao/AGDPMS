@page "/production/orders/{OrderId:int}/items/{ItemId:int}"
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Models.DTOs
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Linq
@using System.Text
@using System.Globalization
@using System.IO
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/production/orders">Lệnh sản xuất</a></li>
            <li class="breadcrumb-item"><a href="/production/orders/@OrderId">@(model?.order?.Code ?? "Chi tiết")</a></li>
            <li class="breadcrumb-item active">Item #@(model?.item?.LineNo ?? ItemId)</li>
        </ol>
    </nav>
        @if (model is null)
        {
            if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            else
            {
                <div>Loading...</div>
            }
        }
        else
    {
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <h5 class="mb-1">Item #@model.item?.LineNo - @(model.item?.Code ?? "N/A") - @(model.item?.CavityName ?? model.item?.CavityCode ?? $"Cavity {model.item?.CavityId}")</h5>
                <div class="text-secondary">Lệnh sản xuất: @model.order?.Code | Trạng thái: @GetOrderStatusDisplay()</div>
                <div class="text-secondary small mt-1">
                    @if (CanEditItemPlan())
                    {
                        <span style="cursor:pointer;" class="text-primary text-decoration-underline"
                              @onclick="StartEditItemPlan"
                              title="Click để cập nhật kế hoạch">
                            Kế hoạch: Bắt đầu: @FormatDate(model.item?.PlannedStartDate) | Kết thúc: @FormatDate(model.item?.PlannedFinishDate)
                        </span>
                    }
                    else
                    {
                        <span>Kế hoạch: Bắt đầu: @FormatDate(model.item?.PlannedStartDate) | Kết thúc: @FormatDate(model.item?.PlannedFinishDate)</span>
                    }
                </div>
                <div class="text-secondary small">
                    <span>Thực tế: Bắt đầu: @FormatDate(model.item?.ActualStartDate) | Kết thúc: @FormatDate(model.item?.ActualFinishDate)</span>
                </div>
                <div class="text-secondary small mt-1">
                    <span>Giờ ước tính: @FormatStageHoursVerbose(model.item?.PlannedTimeHours)</span>
                    <span class="ms-3">Giờ thực tế: @FormatStageHoursVerbose(model.item?.ActualTimeHours)</span>
                </div>
                @if (model.item?.IsLate == true)
                {
                    <div class="text-danger small mt-1">
                        <span class="badge bg-danger">Trễ</span>
                        <span>@GetLateTooltip()</span>
                    </div>
                }
            </div>
            <div class="d-flex flex-column gap-2 align-items-end">
                @* QR Code *@
                @if (!string.IsNullOrWhiteSpace(model?.item?.QRCode) && qrImageUrl != null)
                {
                    <img src="@qrImageUrl" alt="QR Code" class="img-fluid" style="max-width: 120px; height: auto;" />
                }
                <button class="btn btn-sm btn-outline-info" @onclick="AddItemToStamps" title="In tem nhanh">
                    <i class="bx bx-printer me-1"></i> In tem nhanh
                </button>
                @if (CanEditItemCompletion())
                {
                    @if (!(model?.item?.IsCompleted == true) && CanCompleteItem())
                    {
                        <button class="btn btn-sm btn-success" @onclick="ToggleItemCompletion">
                            Đã hoàn thành
                        </button>
                    }
                    else if (model?.item?.IsCompleted == true && !(model?.item?.IsStored == true))
                    {
                        <button class="btn btn-sm btn-primary" @onclick="StoreItem">
                            Lưu kho
                        </button>
                    }
                }
                else
                {
                    @if (model?.item?.IsStored == true)
                    {
                        <span class="badge bg-primary">Đã lưu kho</span>
                    }
                    else if (model?.item?.IsCompleted == true)
                    {
                        <span class="badge bg-success">Đã hoàn thành</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Chưa hoàn thành</span>
                    }
                }
            </div>
        </div>
        @if (CanEditItemPlan() && editingItemPlan)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Bắt đầu dự kiến</label>
                            <input type="datetime-local" class="form-control form-control-sm" @bind="editingItemPlannedStartDate" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kết thúc dự kiến</label>
                            <input type="datetime-local" class="form-control form-control-sm" @bind="editingItemPlannedFinishDate" />
                        </div>
                        <div class="col-md-4 d-flex gap-2 mt-3 mt-md-0">
                            <button class="btn btn-sm btn-primary" @onclick="SaveItemPlan">Lưu</button>
                            <button class="btn btn-sm btn-secondary" @onclick="CancelItemPlanEdit">Hủy</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @* Material Summary *@
        @if (model?.materials?.Any() == true)
        {
            <div class="mb-3">
                <div class="small fw-bold mb-1">Vật tư cần dùng cho item này</div>
                <div class="d-flex flex-wrap gap-2 mb-2 small">
                    <span class="badge bg-primary">Nhôm</span>
                    <span class="badge bg-info text-dark">Kính</span>
                    <span class="badge bg-success">Roăng</span>
                    <span class="badge bg-warning text-dark">Phụ kiện</span>
                    <span class="badge bg-secondary">Vật tư phụ</span>
                </div>
                <div class="d-flex flex-wrap gap-2 small">
                    @foreach (var m in model.materials)
                    {
                        var cls = GetMaterialBadgeClass(m.MaterialType);
                        var dimParts = new List<string>();
                        if (m.Length > 0)
                        {
                            dimParts.Add($"{m.Length / 1000:0.###}");
                        }
                        if (m.Width > 0)
                        {
                            dimParts.Add($"{m.Width / 1000:0.###}");
                        }
                        var hasDimensions = dimParts.Any();
                        var dimText = hasDimensions ? $" - {string.Join(" x ", dimParts)}" : string.Empty;
                        var unitText = hasDimensions && !string.IsNullOrWhiteSpace(m.Unit) ? $" {m.Unit}" : string.Empty;
                        <span class="@cls">
                            [@m.MaterialName@dimText@unitText] x @m.Quantity
                        </span>
                    }
                </div>
            </div>
        }

        @* Stage Progress Bar *@
        @if (model?.item != null)
        {
            <div class="mb-3">
                <div class="small text-secondary mb-1">Tiến độ giai đoạn: @(model.item.CompletedStages)/@(model.item.TotalStages)</div>
                <div class="progress" style="height: 30px; position: relative;">
                    @{
                        var relevantStages = model.stages?.Where(st => ShouldShowStage(st)).ToList() ?? new List<StageDto>();
                        
                        // Calculate hours for each status group
                        var notCompletedHours = relevantStages
                            .Where(s => !s.IsCompleted && !HasPendingReview(s.Id))
                            .Sum(s => (double)(s.PlannedTimeHours ?? 0));
                        var waitingForReviewHours = relevantStages
                            .Where(s => !s.IsCompleted && HasPendingReview(s.Id))
                            .Sum(s => (double)(s.PlannedTimeHours ?? 0));
                        var completedPlannedHours = relevantStages
                            .Where(s => s.IsCompleted)
                            .Sum(s => (double)(s.PlannedTimeHours ?? 0));
                        
                        // Total should be the sum of all three groups to ensure 100%
                        var totalPlannedHours = notCompletedHours + waitingForReviewHours + completedPlannedHours;
                        
                        double notCompletedPercent = 0;
                        double waitingForReviewPercent = 0;
                        double completedPercent = 0;
                        int notCompletedCount = relevantStages.Count(s => !s.IsCompleted && !HasPendingReview(s.Id));
                        int waitingForReviewCount = relevantStages.Count(s => !s.IsCompleted && HasPendingReview(s.Id));
                        int completedCount = relevantStages.Count(s => s.IsCompleted);
                        
                        if (totalPlannedHours > 0)
                        {
                            notCompletedPercent = notCompletedHours * 100.0 / totalPlannedHours;
                            waitingForReviewPercent = waitingForReviewHours * 100.0 / totalPlannedHours;
                            completedPercent = completedPlannedHours * 100.0 / totalPlannedHours;
                            
                            // Ensure percentages add up to 100% (handle rounding)
                            var totalPercent = notCompletedPercent + waitingForReviewPercent + completedPercent;
                            if (Math.Abs(totalPercent - 100.0) > 0.1)
                            {
                                // Normalize if there's a rounding issue
                                var factor = 100.0 / totalPercent;
                                notCompletedPercent *= factor;
                                waitingForReviewPercent *= factor;
                                completedPercent *= factor;
                            }
                        }
                        else
                        {
                            // Fallback to stage count if no planned hours
                            var totalStages = model.item.TotalStages;
                            var completedStages = model.item.CompletedStages;
                            notCompletedCount = totalStages - completedStages - waitingForReviewCount;
                            
                            if (totalStages > 0)
                            {
                                notCompletedPercent = notCompletedCount * 100.0 / totalStages;
                                waitingForReviewPercent = waitingForReviewCount * 100.0 / totalStages;
                                completedPercent = completedCount * 100.0 / totalStages;
                            }
                        }
                    }
                    @if (notCompletedPercent > 0)
                    {
                        var widthStr = notCompletedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        var percentStr = notCompletedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        <div class="progress-bar bg-secondary" role="progressbar" 
                             style="width: @widthStr" 
                             title="Chưa hoàn thành: @notCompletedCount giai đoạn (@percentStr)">
                            @if (notCompletedPercent >= 5)
                            {
                                <span class="ms-2 text-white">@percentStr</span>
                            }
                        </div>
                    }
                    @if (waitingForReviewPercent > 0)
                    {
                        var widthStr = waitingForReviewPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        var percentStr = waitingForReviewPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        <div class="progress-bar bg-warning" role="progressbar" 
                             style="width: @widthStr" 
                             title="Chờ QA kiểm tra: @waitingForReviewCount giai đoạn (@percentStr)">
                            @if (waitingForReviewPercent >= 5)
                            {
                                <span class="ms-2 text-dark">@percentStr</span>
                            }
                        </div>
                    }
                    @if (completedPercent > 0)
                    {
                        var widthStr = completedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        var percentStr = completedPercent.ToString("F1", CultureInfo.InvariantCulture) + "%";
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: @widthStr" 
                             title="Đã hoàn thành: @completedCount giai đoạn (@percentStr)">
                            @if (completedPercent >= 5)
                            {
                                <span class="ms-2 text-white">@percentStr</span>
                            }
                        </div>
                    }
                    @if (notCompletedPercent == 0 && waitingForReviewPercent == 0 && completedPercent == 0)
                    {
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 100%" title="Chưa có dữ liệu">
                            <span class="ms-2 text-white">0%</span>
                        </div>
                    }
                </div>
                <div class="small text-muted mt-1 d-flex gap-3">
                    <span><span class="badge bg-secondary">●</span> Chưa hoàn thành: @notCompletedCount</span>
                    <span><span class="badge bg-warning">●</span> Chờ QA kiểm tra: @waitingForReviewCount</span>
                    <span><span class="badge bg-success">●</span> Đã hoàn thành: @completedCount</span>
                </div>
            </div>
        }

        @* Stages Table *@
        <div class="table-responsive" style="max-height:60vh; overflow:auto;">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Giai đoạn</th>
                        <th>QA phụ trách</th>
                        <th>Trạng thái</th>
                        <th>Ước tính</th>
                        <th>Thực tế</th>
                        <th>Chênh lệch</th>
                        <th>SL kế hoạch</th>
                        <th>SL thực tế</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (model?.stages?.Any() == true)
                    {
                        @foreach (var s in model.stages.Where(st => ShouldShowStage(st)))
                        {
                            var canReview = IsQa() && model?.order?.Status == ProductionOrderStatus.InProduction && HasPendingReview(s.Id) && IsAssignedQa(s);
                            var reviewStatus = GetReviewStatus(s.Id);
                            var rowClass = reviewStatus == "passed" ? "table-success" : (reviewStatus == "failed" ? "table-danger" : "");
                            <tr class="@rowClass">
                                <td>
                                    <div><strong>@s.StageName</strong></div>
                                </td>
                                <td>
                                    @if (ShouldShowButton("AssignQa", s))
                                    {
                                        <span class="text-primary text-decoration-underline" style="cursor:pointer;"
                                              @onclick='@(async () => await OpenQaSelector(s.Id))' 
                                              @onclick:stopPropagation="true"
                                              title="Click để giao QA">
                                            @(s.AssignedQaUserName ?? "Chưa phân công")
                                        </span>
                                    }
                                    else
                                    {
                                        <span>@(s.AssignedQaUserName ?? "Chưa phân công")</span>
                                    }
                                </td>
                                <td>
                                    <span>@GetStageStatus(s)</span>
                                </td>
                                <td>
                                    @if (CanEditStagePlan() && editingPlanStageId == s.Id)
                                    {
                                        <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                            <div class="d-flex gap-1 align-items-center">
                                                <input type="number" class="form-control form-control-sm" style="width: 50px;" min="0" step="1" @bind="editingPlannedHours" />
                                                <span>giờ</span>
                                                <input type="number" class="form-control form-control-sm" style="width: 50px;" min="0" max="59" step="1" @bind="editingPlannedMinutes" />
                                                <span>phút</span>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-success" @onclick='@(() => SaveStagePlan(s.Id))'>✓</button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelStagePlanEdit">✗</button>
                                            </div>
                                        </div>
                                    }
                                    else if (CanEditStagePlan())
                                    {
                                        <div style="cursor:pointer;" class="text-primary text-decoration-underline"
                                             @onclick='@(() => StartEditStagePlan(s))'
                                             @onclick:stopPropagation="true"
                                             title="Click để chỉnh giờ kế hoạch">
                                            @FormatStageHoursVerbose(s.PlannedTimeHours)
                                        </div>
                                    }
                                    else
                                    {
                                        <div>@FormatStageHoursVerbose(s.PlannedTimeHours)</div>
                                    }
                                </td>
                                <td>
                                    @if (CanEditStageActual() && editingActualStageId == s.Id)
                                    {
                                        <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                            <div class="d-flex gap-1 align-items-center">
                                                <input type="number" class="form-control form-control-sm" style="width: 50px;" min="0" step="1" @bind="editingActualHours" />
                                                <span>giờ</span>
                                                <input type="number" class="form-control form-control-sm" style="width: 50px;" min="0" max="59" step="1" @bind="editingActualMinutes" />
                                                <span>phút</span>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-success" @onclick='@(() => SaveStageActual(s.Id))'>✓</button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelStageActualEdit">✗</button>
                                            </div>
                                        </div>
                                    }
                                    else if (CanEditStageActual())
                                    {
                                        <div style="cursor:pointer;" class="text-primary text-decoration-underline"
                                             @onclick='@(() => StartEditStageActual(s))'
                                             @onclick:stopPropagation="true"
                                             title="Click để chỉnh giờ thực tế">
                                            @FormatStageHoursVerbose(s.ActualTimeHours)
                                        </div>
                                    }
                                    else
                                    {
                                        <div>@FormatStageHoursVerbose(s.ActualTimeHours)</div>
                                    }
                                </td>
                                <td>
                                    @if (s.IsCompleted)
                                    {
                                        <span>@FormatStageDifference(s.PlannedTimeHours, s.ActualTimeHours)</span>
                                    }
                                </td>
                                <td>
                                    <span>@GetStagePlannedUnitsLabel(s)</span>
                                </td>
                                <td>
                                    @if (CanEditStageActual())
                                    {
                                        <input type="number" class="form-control form-control-sm" style="width: 90px;" 
                                               min="@(s.PlannedUnits ?? 0)" 
                                               value="@GetActualUnitsDisplayValue(s)"
                                               @onchange='@((ChangeEventArgs e) => OnActualUnitsChanged(s, e))' />
                                    }
                                    else
                                    {
                                        <span>@(s.ActualUnits ?? 0)</span>
                                    }
                                </td>
                                <td class="text-nowrap">
                                    @if (ShouldShowButton("RequestReview", s))
                                    {
                                        <button class="btn btn-outline-primary btn-sm me-1" @onclick='@(() => OpenRequestReviewConfirm(s.Id))'>Yêu cầu kiểm tra</button>
                                    }
                                    @if (canReview)
                                    {
                                        <button class="btn btn-outline-success btn-sm me-1" @onclick='@(() => OpenReviewModal(s.Id))'>Kiểm tra</button>
                                    }
                                    @if (ShouldShowButton("ViewReview", s))
                                    {
                                        var reviewStatusText = GetReviewStatusText(s.Id);
                                        var buttonText = string.IsNullOrEmpty(reviewStatusText) 
                                            ? "Xem kiểm tra" 
                                            : $"Xem kiểm tra ({reviewStatusText})";
                                        <button class="btn btn-outline-info btn-sm me-1" @onclick='@(() => ViewReview(s.Id))'>
                                            @buttonText
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">Không có giai đoạn</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        if (ShouldShowBulkAssignQa())
        {
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" @onclick="OpenBulkQaModal">Giao QA nhanh cho toàn bộ</button>
            </div>
        }
    }
</div>

@* QA Selection Modal *@
@if (showQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chọn nhân viên QA</h5>
                    <button type="button" class="btn-close" @onclick="CloseQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            var sortedQa = qaUsers.OrderBy(q => q.PendingItemsCount).ThenBy(q => q.Name).ToList();
                            var minCount = sortedQa.FirstOrDefault()?.PendingItemsCount ?? 0;
                            @foreach (var qa in sortedQa)
                            {
                                var isRecommended = qa.PendingItemsCount == minCount && sortedQa.Count > 1;
                                <button type="button" class="list-group-item list-group-item-action @(isRecommended ? "border-primary border-2" : "")" @onclick='@(() => SelectQa(qa.Id))'>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div>
                                                <strong>@qa.Name</strong>
                                                @if (isRecommended)
                                                {
                                                    <span class="badge bg-primary ms-2">Đề xuất</span>
                                                }
                                            </div>
                                            <small class="text-muted">@qa.Phone</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">@GetQaWorkloadText(qa)</span>
                                        </div>
                                    </div>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Bulk QA Assignment Modal *@
@if (showBulkQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Giao QA nhanh cho toàn bộ giai đoạn</h5>
                    <button type="button" class="btn-close" @onclick="CloseBulkQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            var sortedQa = qaUsers.OrderBy(q => q.PendingItemsCount).ThenBy(q => q.Name).ToList();
                            var minCount = sortedQa.FirstOrDefault()?.PendingItemsCount ?? 0;
                            @foreach (var qa in sortedQa)
                            {
                                var isRecommended = qa.PendingItemsCount == minCount && sortedQa.Count > 1;
                                <button type="button" class="list-group-item list-group-item-action @(isRecommended ? "border-primary border-2" : "")" @onclick='@(() => SelectBulkQa(qa.Id))'>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div>
                                                <strong>@qa.Name</strong>
                                                @if (isRecommended)
                                                {
                                                    <span class="badge bg-primary ms-2">Đề xuất</span>
                                                }
                                            </div>
                                            <small class="text-muted">@qa.Phone</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-secondary">@GetQaWorkloadText(qa)</span>
                                        </div>
                                    </div>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Review Modal *@
@if (showReviewModal && reviewData != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="badge @(reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id] == true) == true ? "bg-success" : "bg-warning")">
                            @{
                                var allSelected = reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id].HasValue) == true;
                                var allPassed = reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id] == true) == true;
                                if (allSelected && allPassed)
                                {
                                    <text>Đã đạt</text>
                                }
                                else if (allSelected)
                                {
                                    <text>Chưa đạt</text>
                                }
                                else
                                {
                                    <text>Đang kiểm tra</text>
                                }
                            }
                        </span>
                        <span class="ms-2">Kiểm tra giai đoạn</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseReviewModal"></button>
                </div>
                <div class="modal-body">
                    @if (reviewData.Criteria != null)
                    {
                        <div class="mb-3">
                            <h6>Tiêu chí kiểm tra:</h6>
                            <div class="list-group">
                                @foreach (var criteria in reviewData.Criteria.OrderBy(c => c.OrderIndex).ThenBy(c => c.Id))
                                {
                                    var isPassed = criteriaResults.ContainsKey(criteria.Id) ? criteriaResults[criteria.Id] : null;
                                    var isExpanded = isPassed == false;
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">@criteria.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(criteria.Description))
                                                {
                                                    <small class="text-muted">@criteria.Description</small>
                                                }
                                            </div>
                                            <div class="ms-3">
                                                <select class="form-select" 
                                                        style="min-width: 150px; @(isPassed == null ? "border: 2px solid #ffc107; background-color: #fff9e6;" : isPassed == true ? "border: 2px solid #28a745; background-color: #d4edda;" : "border: 2px solid #dc3545; background-color: #f8d7da;")"
                                                        value="@(isPassed.HasValue ? isPassed.Value.ToString().ToLower() : "")"
                                                        @onchange='@((ChangeEventArgs e) => { 
                                                            var value = e.Value?.ToString();
                                                            if (string.IsNullOrEmpty(value))
                                                            {
                                                                criteriaResults[criteria.Id] = null;
                                                                // Clear severity and content when unselected
                                                                criteriaSeverity.Remove(criteria.Id);
                                                                criteriaContent.Remove(criteria.Id);
                                                            }
                                                            else if (bool.TryParse(value, out var boolValue))
                                                            {
                                                                criteriaResults[criteria.Id] = boolValue;
                                                                // Initialize severity and content if not exists
                                                                if (boolValue == false && !criteriaSeverity.ContainsKey(criteria.Id))
                                                                {
                                                                    criteriaSeverity[criteria.Id] = null;
                                                                    criteriaContent[criteria.Id] = null;
                                                                }
                                                            }
                                                            StateHasChanged();
                                                        })'>
                                                    <option value="">Chọn...</option>
                                                    <option value="true">Đạt</option>
                                                    <option value="false">Không đạt</option>
                                                </select>
                                            </div>
                                        </div>
                                        @if (isExpanded)
                                        {
                                            <div class="mt-3 p-3 border rounded bg-light">
                                                <div class="mb-3">
                                                    <label class="form-label">Mức độ nghiêm trọng <span class="text-danger">*</span></label>
                                                    <select class="form-select" @bind="criteriaSeverity[criteria.Id]" @bind:after="StateHasChanged">
                                                        <option value="">-- Chọn mức độ --</option>
                                                        <option value="low">Thấp</option>
                                                        <option value="medium">Trung bình</option>
                                                        <option value="high">Cao</option>
                                                        <option value="critical">Nghiêm trọng</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Nội dung <span class="text-danger">*</span></label>
                                                    <textarea class="form-control" rows="3" 
                                                              placeholder="Mô tả chi tiết vấn đề..."
                                                              @bind="criteriaContent[criteria.Id]" 
                                                              @bind:after="StateHasChanged"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Đính kèm ảnh/video</label>
                                                    <InputFile class="form-control" 
                                                               accept="image/*,video/*" 
                                                               multiple
                                                               OnChange="@(e => HandleCriteriaFileUpload(e, criteria.Id))" />
                                                    @if (!string.IsNullOrEmpty(errorMessage) && errorMessage.Contains("upload"))
                                                    {
                                                        <div class="alert alert-danger mt-2">@errorMessage</div>
                                                    }
                                                    @if (criteriaAttachments.ContainsKey(criteria.Id) && criteriaAttachments[criteria.Id].Any())
                                                    {
                                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                                            @foreach (var attachment in criteriaAttachments[criteria.Id])
                                                            {
                                                                <div class="position-relative" style="width: 120px; height: 120px;">
                                                                    @if (attachment.IsImage)
                                                                    {
                                                                        <img src="@attachment.Url" alt="@attachment.FileName" 
                                                                             class="img-thumbnail w-100 h-100" 
                                                                             style="object-fit: cover; cursor: pointer;"
                                                                             @onclick='@(() => OpenMediaModal(attachment.Url, true))'
                                                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\'%3E%3Crect width=\'120\' height=\'120\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ELỗi tải ảnh%3C/text%3E%3C/svg%3E';" />
                                                                    }
                                                                    else
                                                                    {
                                                                        <video src="@attachment.Url" 
                                                                               class="img-thumbnail w-100 h-100" 
                                                                               style="object-fit: cover; cursor: pointer;"
                                                                               @onclick='@(() => OpenMediaModal(attachment.Url, false))'
                                                                               onerror="this.onerror=null; this.style.display='none';"></video>
                                                                    }
                                                                    <button type="button" 
                                                                            class="btn-close position-absolute top-0 end-0 bg-white rounded-circle p-1" 
                                                                            style="opacity: 0.8;"
                                                                            @onclick='@(() => { criteriaAttachments[criteria.Id].Remove(attachment); StateHasChanged(); })'></button>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" rows="4" placeholder="Nhập ghi chú..." @bind="reviewNotes"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đính kèm ảnh/video</label>
                        <InputFile class="form-control"
                                   accept="image/*,video/*"
                                   multiple
                                   OnChange="HandleReviewFileUpload" />
                        @if (!string.IsNullOrEmpty(errorMessage) && errorMessage.Contains("upload"))
                        {
                            <div class="alert alert-danger mt-2">@errorMessage</div>
                        }
                        @if (reviewAttachments.Any())
                        {
                            <div class="mt-2 d-flex flex-wrap gap-2">
                                @foreach (var attachment in reviewAttachments)
                                {
                                    <div class="position-relative" style="width: 120px; height: 120px;">
                                        @if (attachment.IsImage)
                                        {
                                            <img src="@attachment.Url" alt="@attachment.FileName"
                                                 class="img-thumbnail w-100 h-100"
                                                 style="object-fit: cover; cursor: pointer;"
                                                 @onclick='@(() => OpenMediaModal(attachment.Url, true))'
                                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\'%3E%3Crect width=\'120\' height=\'120\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ELỗi tải ảnh%3C/text%3E%3C/svg%3E';" />
                                        }
                                        else
                                        {
                                            <video src="@attachment.Url"
                                                   class="img-thumbnail w-100 h-100"
                                                   style="object-fit: cover; cursor: pointer;"
                                                   @onclick='@(() => OpenMediaModal(attachment.Url, false))'
                                                   onerror="this.onerror=null; this.style.display='none';"></video>
                                        }
                                        <button type="button"
                                                class="btn-close position-absolute top-0 end-0 bg-white rounded-circle p-1"
                                                style="opacity: 0.8;"
                                                @onclick='@(() => { reviewAttachments.Remove(attachment); StateHasChanged(); })'></button>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseReviewModal">Hủy</button>
                    @{
                        var canSubmit = CanSubmitReview();
                        var submitTooltip = canSubmit ? "" : "Vẫn còn tiêu chí chưa hoàn thành đánh giá";
                    }
                    <span title="@submitTooltip">
                        <button type="button" 
                                class="btn btn-success me-2" 
                                @onclick="() => SubmitReview(true)" 
                                disabled="@(!canSubmit)"
                                style="@(!canSubmit ? "cursor: not-allowed;" : "")">
                            Xác nhận đạt
                        </button>
                        <button type="button" 
                                class="btn btn-danger" 
                                @onclick="() => SubmitReview(false)" 
                                disabled="@(!canSubmit)"
                                style="@(!canSubmit ? "cursor: not-allowed;" : "")">
                            Xác nhận không đạt
                        </button>
                    </span>
                </div>
            </div>
        </div>
    </div>
}

@* Request Review Confirmation Modal *@
@if (showRequestReviewConfirm && requestReviewStageId.HasValue)
{
    var stage = model?.stages?.FirstOrDefault(s => s.Id == requestReviewStageId.Value);
    var hasQa = stage != null && stage.AssignedQaUserId.HasValue;
    var hasActualHours = stage != null && stage.ActualTimeHours.HasValue && stage.ActualTimeHours.Value > 0;
    var hasActualUnits = stage != null && stage.ActualUnits.HasValue && stage.PlannedUnits.HasValue && stage.ActualUnits.Value >= stage.PlannedUnits.Value;
    var canProceed = hasQa && hasActualHours && hasActualUnits;
    
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận yêu cầu kiểm tra</h5>
                    <button type="button" class="btn-close" @onclick="CloseRequestReviewConfirm"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn yêu cầu kiểm tra cho giai đoạn này?</p>
                    
                    @if (!hasQa)
                    {
                        <div class="alert alert-danger mb-2">
                            <strong>Chưa phân công QA</strong>
                        </div>
                    }
                    
                    @if (!hasActualHours)
                    {
                        <div class="alert alert-warning mb-2">
                            <strong>Cảnh báo:</strong> Chưa cập nhật giờ thực tế
                        </div>
                    }
                    
                    @if (!hasActualUnits)
                    {
                        <div class="alert alert-warning mb-2">
                            <strong>Cảnh báo:</strong> Chưa cập nhật đủ số lượng thực tế
                        </div>
                    }
                    
                    @if (canProceed)
                    {
                        <div class="alert alert-success mb-2">
                            Tất cả điều kiện đã được đáp ứng. Có thể tiếp tục.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRequestReviewConfirm">Hủy</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmRequestReview">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
}

@* View Review Modal *@
@if (showViewReviewModal && viewReviewData != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="badge @(viewReviewData.Review?.Status == "passed" ? "bg-success" : "bg-danger")">
                            @(viewReviewData.Review?.Status == "passed" ? "Đã đạt" : "Chưa đạt")
                        </span>
                        <span class="ms-2">Kết quả kiểm tra</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseViewReviewModal"></button>
                </div>
                <div class="modal-body">
                    @if (viewReviewData.Review != null)
                    {
                        <div class="mb-3">
                            <small class="text-muted">
                                Yêu cầu lúc: @FormatDate(viewReviewData.Review.RequestedAt) | 
                                @if (viewReviewData.Review.ReviewedAt.HasValue)
                                {
                                    <span>Kiểm tra lúc: @FormatDate(viewReviewData.Review.ReviewedAt)</span>
                                }
                            </small>
                        </div>
                    }
                    @if (viewReviewData.Criteria != null)
                    {
                        <div class="mb-3">
                            <h6>Kết quả kiểm tra:</h6>
                            <div class="list-group">
                                @foreach (var criteria in viewReviewData.Criteria.OrderBy(c => c.OrderIndex).ThenBy(c => c.Id))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">@criteria.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(criteria.Description))
                                                {
                                                    <small class="text-muted">@criteria.Description</small>
                                                }
                                            </div>
                                            <div class="ms-3">
                                                @if (criteria.Result != null)
                                                {
                                                    <span class="badge @(criteria.Result.IsPassed == true ? "bg-success" : "bg-danger")">
                                                        @(criteria.Result.IsPassed == true ? "Đạt" : "Không đạt")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Chưa kiểm tra</span>
                                                }
                                            </div>
                                        </div>
                                        @if (criteria.Result != null && criteria.Result.IsPassed == false)
                                        {
                                            <div class="mt-3 p-3 border rounded bg-light">
                                                @if (!string.IsNullOrWhiteSpace(criteria.Result.Severity))
                                                {
                                                    <div class="mb-2">
                                                        <strong>Mức độ nghiêm trọng:</strong>
                                                        <span class="badge @(criteria.Result.Severity == "critical" ? "bg-danger" : criteria.Result.Severity == "high" ? "bg-warning" : criteria.Result.Severity == "medium" ? "bg-info" : "bg-secondary")">
                                                            @(criteria.Result.Severity == "critical" ? "Nghiêm trọng" : 
                                                              criteria.Result.Severity == "high" ? "Cao" : 
                                                              criteria.Result.Severity == "medium" ? "Trung bình" : "Thấp")
                                                        </span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(criteria.Result.Content))
                                                {
                                                    <div class="mb-2">
                                                        <strong>Nội dung:</strong>
                                                        <div class="mt-1">@criteria.Result.Content</div>
                                                    </div>
                                                }
                                                @{
                                                    var hasAttachments = criteria.Result?.Attachments != null && criteria.Result.Attachments.Any();
                                                }
                                                @if (hasAttachments)
                                                {
                                                    <div class="mb-2">
                                                        <strong>Đính kèm (@criteria.Result!.Attachments!.Count):</strong>
                                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                                            @foreach (var attachmentUrl in criteria.Result.Attachments!)
                                                            {
                                                                if (!string.IsNullOrEmpty(attachmentUrl))
                                                                {
                                                                    var urlLower = attachmentUrl.ToLower();
                                                                    var isImage = urlLower.EndsWith(".jpg") || urlLower.EndsWith(".jpeg") || 
                                                                                  urlLower.EndsWith(".png") || urlLower.EndsWith(".gif") || 
                                                                                  urlLower.EndsWith(".webp") || urlLower.EndsWith(".bmp");
                                                                    var isVideo = urlLower.EndsWith(".mp4") || urlLower.EndsWith(".mov") || 
                                                                                  urlLower.EndsWith(".avi") || urlLower.EndsWith(".mkv") ||
                                                                                  urlLower.EndsWith(".webm");
                                                                    <div class="position-relative" style="width: 200px; height: 200px; border: 1px solid #dee2e6; border-radius: 0.25rem; overflow: hidden;">
                                                                        @if (isImage)
                                                                        {
                                                                            <img src="@attachmentUrl" alt="Attachment" 
                                                                                 class="w-100 h-100" 
                                                                                 style="object-fit: cover; cursor: pointer; display: block;"
                                                                                 @onclick='@(() => OpenMediaModal(attachmentUrl, true))' 
                                                                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EKhông thể tải ảnh%3C/text%3E%3C/svg%3E';" />
                                                                        }
                                                                        else if (isVideo)
                                                                        {
                                                                            <video src="@attachmentUrl" 
                                                                                   class="w-100 h-100" 
                                                                                   style="object-fit: cover; cursor: pointer; display: block;"
                                                                                   @onclick='@(() => OpenMediaModal(attachmentUrl, false))'
                                                                                   preload="metadata"
                                                                                   muted
                                                                                   onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center h-100 bg-light text-muted\'><small>Không thể tải video</small></div>';"></video>
                                                                            <div class="position-absolute top-50 start-50 translate-middle" style="pointer-events: none;">
                                                                                <i class="bi bi-play-circle-fill text-white" style="font-size: 3rem; text-shadow: 0 0 10px rgba(0,0,0,0.5);"></i>
                                                                            </div>
                                                                        }
                                                                        else
                                                                        {
                                                                            <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                                                                                <small>File: @Path.GetFileName(attachmentUrl)</small>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                else if (criteria.Result != null)
                                                {
                                                    <div class="mb-2 text-muted">
                                                        <small>Không có đính kèm</small>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(viewReviewData.Review?.Notes))
                    {
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <div class="form-control" style="min-height: 80px;">@viewReviewData.Review.Notes</div>
                        </div>
                    }
                    @if (viewReviewData.Review?.Attachments?.Any() == true)
                    {
                        <div class="mb-3">
                            <label class="form-label">Đính kèm ảnh/video</label>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var attachmentUrl in viewReviewData.Review.Attachments)
                                {
                                    var urlLower = attachmentUrl.ToLower();
                                    var isImage = urlLower.EndsWith(".jpg") || urlLower.EndsWith(".jpeg") ||
                                                  urlLower.EndsWith(".png") || urlLower.EndsWith(".gif") ||
                                                  urlLower.EndsWith(".webp") || urlLower.EndsWith(".bmp");
                                    var isVideo = urlLower.EndsWith(".mp4") || urlLower.EndsWith(".mov") ||
                                                  urlLower.EndsWith(".avi") || urlLower.EndsWith(".mkv") ||
                                                  urlLower.EndsWith(".webm");
                                    <div class="position-relative" style="width: 200px; height: 200px; border: 1px solid #dee2e6; border-radius: 0.25rem; overflow: hidden;">
                                        @if (isImage)
                                        {
                                            <img src="@attachmentUrl" alt="Attachment"
                                                 class="w-100 h-100"
                                                 style="object-fit: cover; cursor: pointer; display: block;"
                                                 @onclick='@(() => OpenMediaModal(attachmentUrl, true))'
                                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EKhông thể tải ảnh%3C/text%3E%3C/svg%3E';" />
                                        }
                                        else if (isVideo)
                                        {
                                            <video src="@attachmentUrl"
                                                   class="w-100 h-100"
                                                   style="object-fit: cover; cursor: pointer; display: block;"
                                                   @onclick='@(() => OpenMediaModal(attachmentUrl, false))'
                                                   preload="metadata"
                                                   muted
                                                   onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center h-100 bg-light text-muted\'><small>Không thể tải video</small></div>';"></video>
                                            <div class="position-absolute top-50 start-50 translate-middle" style="pointer-events: none;">
                                                <i class="bi bi-play-circle-fill text-white" style="font-size: 3rem; text-shadow: 0 0 10px rgba(0,0,0,0.5);"></i>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                                                <small>File: @Path.GetFileName(attachmentUrl)</small>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewReviewModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@* Media Modal (Image/Video) *@
@if (showImageModal && !string.IsNullOrEmpty(imageModalUrl))
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.9); z-index: 9999;" @onclick="CloseImageModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseImageModal"></button>
                </div>
                <div class="modal-body p-0 text-center">
                    @if (isImageInModal)
                    {
                        <img src="@imageModalUrl" alt="Preview" class="img-fluid" style="max-height: 85vh; max-width: 100%;" />
                    }
                    else
                    {
                        <video src="@imageModalUrl" controls class="w-100" style="max-height: 85vh;" autoplay></video>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int OrderId { get; set; }
    [Parameter] public int ItemId { get; set; }

    private ItemDetailsResponse? model;
    private string? userRole;
    private string? errorMessage;
    private bool showQaModal = false;
    private string? qrImageUrl;
    private int? selectedStageIdForQa;
    private List<QaUser>? qaUsers;
    private string? qaSearch;
    private bool showBulkQaModal = false;
    
    // Review states
    private bool showReviewModal = false;
    private int? reviewStageId;
    private ReviewData? reviewData;
    private Dictionary<int, bool?> criteriaResults = new();
    private Dictionary<int, string?> criteriaSeverity = new();
    private Dictionary<int, string?> criteriaContent = new();
    private Dictionary<int, List<AttachmentInfo>> criteriaAttachments = new();
    private string reviewNotes = string.Empty;
    private List<AttachmentInfo> reviewAttachments = new();
    private bool showViewReviewModal = false;
    private int? viewReviewStageId;
    private ReviewData? viewReviewData;
    private Dictionary<int, bool> stageHasPendingReview = new();
    private Dictionary<int, bool> stageHasLatestReview = new();
    private Dictionary<int, string> stageReviewStatus = new(); // Store review status: "passed", "failed", or empty
    private bool showRequestReviewConfirm = false;
    private int? requestReviewStageId;
    
    // Inline editing states
    private int? editingPlanStageId;
    private decimal? editingPlannedTimeHours;
    private int editingPlannedHours;
    private int editingPlannedMinutes;
    private int? editingActualStageId;
    private decimal? editingActualTimeHours;
    private int editingActualHours;
    private int editingActualMinutes;
    private bool editingItemPlan;
    private DateTime? editingItemPlannedStartDate;
    private DateTime? editingItemPlannedFinishDate;

    protected override async Task OnParametersSetAsync()
    {
        await LoadUserRole();
        await LoadCurrentUserId();
        await Load();
        LoadQrImage();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task Load()
    {
        errorMessage = null;
        try
        {
            var response = await Http.GetAsync($"/api/items/{ItemId}");
            if (response.IsSuccessStatusCode)
            {
                model = await response.Content.ReadFromJsonAsync<ItemDetailsResponse>();
                // Load review status and issues for each stage
                if (model?.stages != null)
                {
                    foreach (var stage in model.stages)
                    {
                        await CheckReviewStatus(stage.Id);
                    }
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Lỗi khi tải item: {response.StatusCode}. {errorContent}";
                model = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải item: {ex.Message}";
            model = null;
        }
    }

    private async Task CheckReviewStatus(int stageId)
    {
        try
        {
            // Check for pending review first
            var pendingResponse = await Http.GetAsync($"/api/stages/{stageId}/review");
            if (pendingResponse.IsSuccessStatusCode)
            {
                var pendingReview = await pendingResponse.Content.ReadFromJsonAsync<ReviewData>();
                if (pendingReview?.Review != null && pendingReview.Review.Status == "pending")
                {
                    // There's a pending review, don't show "ViewReview" button
                    stageHasPendingReview[stageId] = true;
                    stageHasLatestReview[stageId] = false;
                    stageReviewStatus[stageId] = ""; // No status for pending
                    return;
                }
            }
            
            // Check latest review (completed reviews)
            var response = await Http.GetAsync($"/api/stages/{stageId}/latest-review");
            if (response.IsSuccessStatusCode)
            {
                var review = await response.Content.ReadFromJsonAsync<ReviewData>();
                if (review?.Review != null)
                {
                    // Only show "ViewReview" if review is completed (passed or failed), not pending
                    var status = review.Review.Status;
                    stageHasLatestReview[stageId] = (status == "passed" || status == "failed");
                    stageHasPendingReview[stageId] = (status == "pending");
                    stageReviewStatus[stageId] = (status == "passed" || status == "failed") ? status : "";
                }
                else
                {
                    stageHasLatestReview[stageId] = false;
                    stageHasPendingReview[stageId] = false;
                    stageReviewStatus[stageId] = "";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // No review at all
                stageHasLatestReview[stageId] = false;
                stageHasPendingReview[stageId] = false;
                stageReviewStatus[stageId] = "";
            }
        }
        catch
        {
            stageHasLatestReview[stageId] = false;
            stageHasPendingReview[stageId] = false;
            stageReviewStatus[stageId] = "";
        }
    }

    private string GetReviewStatus(int stageId)
    {
        return stageReviewStatus.ContainsKey(stageId) ? stageReviewStatus[stageId] : "";
    }

    private string GetReviewStatusText(int stageId)
    {
        var status = GetReviewStatus(stageId);
        return status == "passed" ? "đạt" : (status == "failed" ? "không đạt" : "");
    }

    private void LoadQrImage()
    {
        if (model?.item?.QRCode == null) return;
        qrImageUrl = $"/api/items/{ItemId}/qr";
        StateHasChanged();
    }

    private async Task OpenQaSelector(int stageId)
    {
        selectedStageIdForQa = stageId;
        showQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
        StateHasChanged();
    }

    private void CloseQaModal()
    {
        showQaModal = false;
        selectedStageIdForQa = null;
        qaSearch = null;
    }

    private async Task LoadQaUsers()
    {
        try
        {
            var query = new List<string> { "scope=stage" };
            if (!string.IsNullOrWhiteSpace(qaSearch))
            {
                query.Add($"q={Uri.EscapeDataString(qaSearch!)}");
            }
            var url = "/api/lookup/qa-users" + (query.Any() ? "?" + string.Join("&", query) : "");
            qaUsers = await Http.GetFromJsonAsync<List<QaUser>>(url) ?? new();
        }
        catch
        {
            qaUsers = new();
        }
        StateHasChanged();
    }

    private async Task SelectQa(int qaUserId)
    {
        if (selectedStageIdForQa.HasValue)
        {
            await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{selectedStageIdForQa.Value}/assign-qa", new { QaUserId = qaUserId }));
        }
        CloseQaModal();
    }

    private async Task OpenBulkQaModal()
    {
        showBulkQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
    }

    private void CloseBulkQaModal()
    {
        showBulkQaModal = false;
        qaSearch = null;
    }

    private async Task SelectBulkQa(int qaUserId)
    {
        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/items/{ItemId}/assign-qa-bulk", new { QaUserId = qaUserId }));
        CloseBulkQaModal();
    }

    private bool ShouldShowStage(StageDto stage)
    {
        // Hide stages with planned_time_hours = 0 or NULL unless order is Draft
        if (model?.order?.Status != ProductionOrderStatus.Draft)
        {
            if (!stage.PlannedTimeHours.HasValue || stage.PlannedTimeHours == 0)
            {
                return false;
            }
        }
        return true;
    }

    private bool ShouldShowButton(string buttonName, StageDto stage)
    {
        switch (buttonName)
        {
            case "AssignQa":
                return IsProductionManager() &&
                 !stage.IsCompleted && 
                 (model?.order?.Status == ProductionOrderStatus.Draft ||
                 model?.order?.Status == ProductionOrderStatus.PendingQACheckMachines ||
                 model?.order?.Status == ProductionOrderStatus.PendingQACheckMaterial ||
                  model?.order?.Status == ProductionOrderStatus.InProduction);
            case "RequestReview":
                return IsProductionManager() && !stage.IsCompleted && model?.order?.Status == ProductionOrderStatus.InProduction && !HasPendingReview(stage.Id);
            case "Review":
                // Need to check async, so we'll handle this differently
                return false; // Will be set via async check
            case "ViewReview":
                // Only show if there's a completed review (passed or failed) and no pending review
                return HasLatestReview(stage.Id) && !HasPendingReview(stage.Id);
            default:
                return false;
        }
    }

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");
    private bool IsDirector() => HasRole("Admin") || HasRole("Director");

    private bool ShouldShowBulkAssignQa() =>
        IsProductionManager() &&
        (model?.order?.Status == ProductionOrderStatus.Draft ||
         model?.order?.Status == ProductionOrderStatus.PendingQACheckMachines ||
         model?.order?.Status == ProductionOrderStatus.PendingQACheckMaterial ||
         model?.order?.Status == ProductionOrderStatus.InProduction);

    private bool CanEditStagePlan() => IsProductionManager() && (model?.order?.Status == ProductionOrderStatus.Draft);
    private bool CanEditStageActual() => IsProductionManager() && (model?.order?.Status == ProductionOrderStatus.InProduction);
    private bool CanEditItemCompletion() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.InProduction;
    private bool CanEditItemPlan() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.Draft;

    private bool CanCompleteItem()
    {
        if (!CanEditItemCompletion() || model?.item == null || model?.stages == null)
            return false;

        // Check if all stages are completed
        var visibleStages = model.stages.Where(st => ShouldShowStage(st)).ToList();
        if (!visibleStages.All(s => s.IsCompleted))
            return false;

        return true;
    }

    private string GetStageStatus(StageDto stage)
    {
        if (HasPendingReview(stage.Id))
        {
            return "Chờ kiểm tra QA";
        }
        // Calculate status dynamically from actual_time_hours
        if (stage.IsCompleted)
        {
            return "Đã hoàn thành";
        }
        if (stage.ActualTimeHours.HasValue && stage.ActualTimeHours > 0)
        {
            return "Đang thực hiện";
        }
        return "Chưa bắt đầu";
    }

    private string FormatDate(DateTime? value) => value.HasValue ? value.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm") : "-";

    private async Task ExecuteStageAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await Load();
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        await InvokeAsync(StateHasChanged);
    }

    private void StartEditStagePlan(StageDto stage)
    {
        editingPlanStageId = stage.Id;
        editingPlannedTimeHours = stage.PlannedTimeHours;
        var totalMinutes = (int)Math.Round((double)(stage.PlannedTimeHours ?? 0) * 60.0);
        editingPlannedHours = totalMinutes / 60;
        editingPlannedMinutes = totalMinutes % 60;
        StateHasChanged();
    }

    private void CancelStagePlanEdit()
    {
        editingPlanStageId = null;
        StateHasChanged();
    }

    private async Task SaveStagePlan(int stageId)
    {
        var totalMinutes = Math.Max(0, editingPlannedHours * 60 + editingPlannedMinutes);
        editingPlannedTimeHours = totalMinutes > 0 ? Math.Round((decimal)totalMinutes / 60m, 2) : null;
        var dto = new UpdateStagePlanDto
        {
            PlannedTimeHours = editingPlannedTimeHours
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/plan", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingPlanStageId = null;
        }
    }

    private void StartEditStageActual(StageDto stage)
    {
        editingActualStageId = stage.Id;
        editingActualTimeHours = stage.ActualTimeHours;
        var totalMinutes = (int)Math.Round((double)(stage.ActualTimeHours ?? 0) * 60.0);
        editingActualHours = totalMinutes / 60;
        editingActualMinutes = totalMinutes % 60;
        StateHasChanged();
    }

    private void CancelStageActualEdit()
    {
        editingActualStageId = null;
        StateHasChanged();
    }

    private async Task SaveStageActual(int stageId)
    {
        var totalMinutes = Math.Max(0, editingActualHours * 60 + editingActualMinutes);
        editingActualTimeHours = totalMinutes > 0 ? Math.Round((decimal)totalMinutes / 60m, 2) : null;
        var dto = new UpdateStageDatesDto
        {
            ActualTimeHours = editingActualTimeHours
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/dates", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingActualStageId = null;
        }
    }

    private string FormatStageHoursVerbose(decimal? hours)
    {
        if (!hours.HasValue || hours.Value <= 0)
        {
            return "-";
        }
        var totalMinutes = (int)Math.Round(hours.Value * 60);
        var h = totalMinutes / 60;
        var m = totalMinutes % 60;
        if (h > 0 && m > 0)
        {
            return $"{h} giờ {m} phút";
        }
        if (h > 0)
        {
            return $"{h} giờ";
        }
        return $"{m} phút";
    }

    private string FormatStageDifference(decimal? planned, decimal? actual)
    {
        if (!planned.HasValue || !actual.HasValue)
        {
            return "-";
        }
        var diffHours = actual.Value - planned.Value;
        if (diffHours == 0)
        {
            return "0";
        }
        var sign = diffHours > 0 ? "+" : "-";
        var totalMinutes = (int)Math.Round(Math.Abs(diffHours) * 60);
        var h = totalMinutes / 60;
        var m = totalMinutes % 60;
        string text;
        if (h > 0 && m > 0)
        {
            text = $"{h} giờ {m} phút";
        }
        else if (h > 0)
        {
            text = $"{h} giờ";
        }
        else
        {
            text = $"{m} phút";
        }
        return $"{sign}{text}";
    }

    private string GetMaterialBadgeClass(string? materialTypeName)
    {
        if (string.IsNullOrWhiteSpace(materialTypeName)) return "badge bg-secondary text-light";
        return materialTypeName switch
        {
            "Nhôm" => "badge bg-primary text-light",
            "Kính" => "badge bg-info text-dark",
            "Roăng" => "badge bg-success text-light",
            "Phụ kiện" => "badge bg-warning text-dark",
            "Vật tư phụ" => "badge bg-secondary text-light",
            _ => "badge bg-secondary text-light"
        };
    }

    private string GetStagePlannedUnitsLabel(StageDto s)
    {
        if (!s.PlannedUnits.HasValue || s.PlannedUnits.Value <= 0)
        {
            return "-";
        }
        var count = s.PlannedUnits.Value;
        var name = s.StageName ?? string.Empty;
        string unit = "đơn vị";
        if (name.Contains("Cắt nhôm", StringComparison.OrdinalIgnoreCase))
        {
            unit = "thanh nhôm";
        }
        else if (name.Contains("Cắt kính", StringComparison.OrdinalIgnoreCase) || name.Contains("kính", StringComparison.OrdinalIgnoreCase))
        {
            unit = "tấm kính";
        }
        else if (name.Contains("Ép gioăng", StringComparison.OrdinalIgnoreCase))
        {
            unit = "gioăng";
        }
        else if (name.Contains("Bắn phụ kiện", StringComparison.OrdinalIgnoreCase))
        {
            unit = "phụ kiện";
        }
        else if (name.Contains("Hoàn thiện silicon", StringComparison.OrdinalIgnoreCase))
        {
            unit = "mét keo";
        }
        else if (name.Contains("Cắt sập", StringComparison.OrdinalIgnoreCase))
        {
            unit = "thanh";
        }
        else if (name.Contains("Ghép khung", StringComparison.OrdinalIgnoreCase) || name.Contains("Cắt góc cửa", StringComparison.OrdinalIgnoreCase))
        {
            unit = "góc";
        }
        return $"{count} {unit}";
    }

    private int GetActualUnitsDisplayValue(StageDto stage)
    {
        // Only return actual units if it's already set, otherwise return 0 (not planned units)
        // This prevents auto-setting to planned units when order status changes
        return stage.ActualUnits ?? 0;
    }

    private async Task OnActualUnitsChanged(StageDto stage, ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var value))
        {
            // If parsing fails, don't set to planned units - keep current actual or 0
            value = stage.ActualUnits ?? 0;
        }
        
        // Enforce min = planned units (actual must be >= planned)
        if (stage.PlannedUnits.HasValue && value < stage.PlannedUnits.Value)
        {
            value = stage.PlannedUnits.Value;
        }

        // Only update if value actually changed from current actual units
        if (stage.ActualUnits.HasValue && stage.ActualUnits.Value == value)
        {
            return; // No change, don't save
        }

        var dto = new UpdateStageUnitsDto
        {
            ActualUnits = value
        };

        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stage.Id}/units", dto));
    }

    private async Task ToggleItemCompletion()
    {
        if (model?.item == null) return;
        var dto = new UpdateItemCompletionDto
        {
            IsCompleted = !model.item.IsCompleted
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/items/{ItemId}/completion", dto));
    }

    private async Task StoreItem()
    {
        if (model?.item == null) return;
        await ExecuteStageAction(() => Http.PutAsync($"/api/items/{ItemId}/stored", null));
    }

    private void AddItemToStamps()
    {
        Nav.NavigateTo($"/print/stamp-manager?items={ItemId}");
    }

    private void StartEditItemPlan()
    {
        if (model?.item == null) return;
        editingItemPlan = true;
        editingItemPlannedStartDate = model.item.PlannedStartDate;
        editingItemPlannedFinishDate = model.item.PlannedFinishDate;
        StateHasChanged();
    }

    private void CancelItemPlanEdit()
    {
        editingItemPlan = false;
        StateHasChanged();
    }

    private async Task SaveItemPlan()
    {
        var dto = new UpdateItemPlanDto
        {
            PlannedStartDate = editingItemPlannedStartDate,
            PlannedFinishDate = editingItemPlannedFinishDate
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/items/{ItemId}/plan", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingItemPlan = false;
        }
    }

    private string GetOrderStatusDisplay()
    {
        if (model?.order is null) return string.Empty;
        return GetStatusLabel(model.order.Status);
    }

    private string GetStatusLabel(ProductionOrderStatus status) => status switch
    {
        ProductionOrderStatus.Draft => "Nháp",
        ProductionOrderStatus.PendingDirectorApproval => "Chờ giám đốc duyệt",
        ProductionOrderStatus.DirectorRejected => "Bị từ chối",
        ProductionOrderStatus.PendingQACheckMachines => "Chờ QA kiểm tra máy",
        ProductionOrderStatus.PendingQACheckMaterial => "Chờ QA kiểm tra vật tư",
        ProductionOrderStatus.InProduction => "Đang sản xuất",
        ProductionOrderStatus.Finished => "Hoàn thành",
        ProductionOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    private string GetLateTooltip()
    {
        if (model?.item == null || !model.item.IsLate) return string.Empty;
        if (model.item.IsOverdue && model.item.DaysLate > 0)
        {
            return $"Đã quá hạn kế hoạch {model.item.DaysLate} ngày";
        }
        if (model.item.IsOverdue)
        {
            return "Đã quá hạn kế hoạch";
        }
        if (model.item.DaysLate > 0)
        {
            return $"Hoàn thành trễ {model.item.DaysLate} ngày";
        }
        return "Trễ kế hoạch";
    }

    private class ItemDetailsResponse
    {
        public ItemDto? item { get; set; }
        public OrderDto? order { get; set; }
        public List<StageDto>? stages { get; set; }
        public List<MaterialSummaryDto>? materials { get; set; }
    }

    private class ItemDto
    {
        public int Id { get; set; }
        public int CavityId { get; set; }
        public string? CavityCode { get; set; }
        public string? CavityName { get; set; }
        public string Code { get; set; } = string.Empty;
        public int LineNo { get; set; }
        public string? QRCode { get; set; }
        public bool IsCompleted { get; set; }
        public bool IsStored { get; set; }
        public DateTime? PlannedStartDate { get; set; }
        public DateTime? PlannedFinishDate { get; set; }
        public DateTime? ActualStartDate { get; set; }
        public DateTime? ActualFinishDate { get; set; }
        public decimal? PlannedTimeHours { get; set; }
        public decimal? ActualTimeHours { get; set; }
        public bool IsLate { get; set; }
        public bool IsOverdue { get; set; }
        public int DaysLate { get; set; }
        public int CompletedStages { get; set; }
        public int TotalStages { get; set; }
    }

    private class OrderDto
    {
        public int Id { get; set; }
        public string? Code { get; set; }
        public ProductionOrderStatus Status { get; set; }
        public int ProjectId { get; set; }
    }

    private class StageDto
    {
        public int Id { get; set; }
        public int StageTypeId { get; set; }
        public string StageName { get; set; } = string.Empty;
        public decimal? PlannedTimeHours { get; set; }
        public decimal? ActualTimeHours { get; set; }
        public int? AssignedQaUserId { get; set; }
        public string? AssignedQaUserName { get; set; }
        public bool IsCompleted { get; set; }
        public int? PlannedUnits { get; set; }
        public int? ActualUnits { get; set; }
    }

    private class QaUser
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? Phone { get; set; }
        public int PendingItemsCount { get; set; }
        public int PendingMachinesCount { get; set; }
        public int PendingMaterialCount { get; set; }
        public int PendingStagesCount { get; set; }
    }

    private string GetQaWorkloadText(QaUser qa)
    {
        var total = qa.PendingItemsCount;
        if (total <= 0)
        {
            return "Rảnh";
        }

        var parts = new List<string>
        {
            $"Còn {total} việc"
        };

        if (qa.PendingMachinesCount > 0)
        {
            parts.Add($"KT máy: {qa.PendingMachinesCount}");
        }

        if (qa.PendingMaterialCount > 0)
        {
            parts.Add($"KT vật tư: {qa.PendingMaterialCount}");
        }

        if (qa.PendingStagesCount > 0)
        {
            parts.Add($"KT công đoạn: {qa.PendingStagesCount}");
        }

        return string.Join(" | ", parts);
    }

    private void OpenRequestReviewConfirm(int stageId)
    {
        requestReviewStageId = stageId;
        showRequestReviewConfirm = true;
        StateHasChanged();
    }

    private void CloseRequestReviewConfirm()
    {
        showRequestReviewConfirm = false;
        requestReviewStageId = null;
        StateHasChanged();
    }

    private async Task ConfirmRequestReview()
    {
        if (requestReviewStageId == null) return;
        await ExecuteStageAction(() => Http.PostAsync($"/api/stages/{requestReviewStageId.Value}/request-review", null));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            CloseRequestReviewConfirm();
            await Load(); // Reload to refresh stages
            StateHasChanged();
        }
    }

    private async Task RequestReview(int stageId)
    {
        await ExecuteStageAction(() => Http.PostAsync($"/api/stages/{stageId}/request-review", null));
    }

    private async Task OpenReviewModal(int stageId)
    {
        reviewStageId = stageId;
        reviewNotes = string.Empty;
        criteriaResults.Clear();
        criteriaSeverity.Clear();
        criteriaContent.Clear();
        criteriaAttachments.Clear();
        reviewAttachments.Clear();
        showReviewModal = true;
        await LoadReviewData(stageId);
        StateHasChanged();
    }

    private void CloseReviewModal()
    {
        showReviewModal = false;
        reviewStageId = null;
        reviewData = null;
        criteriaResults.Clear();
        criteriaSeverity.Clear();
        criteriaContent.Clear();
        criteriaAttachments.Clear();
        reviewNotes = string.Empty;
        reviewAttachments.Clear();
        StateHasChanged();
    }

    private async Task LoadReviewData(int stageId)
    {
        try
        {
            // Clear existing data first
            criteriaResults.Clear();
            criteriaSeverity.Clear();
            criteriaContent.Clear();
            criteriaAttachments.Clear();
            
            var response = await Http.GetAsync($"/api/stages/{stageId}/review");
            if (response.IsSuccessStatusCode)
            {
                reviewData = await response.Content.ReadFromJsonAsync<ReviewData>();
                reviewNotes = reviewData?.Review?.Notes ?? string.Empty;
                reviewAttachments.Clear();
                var reviewAttachmentUrls = reviewData?.Review?.Attachments ?? new List<string>();
                foreach (var url in reviewAttachmentUrls)
                {
                    if (string.IsNullOrWhiteSpace(url)) continue;
                    var lower = url.ToLowerInvariant();
                    reviewAttachments.Add(new AttachmentInfo
                    {
                        Url = url,
                        FileName = Path.GetFileName(url),
                        IsImage = lower.EndsWith(".jpg") || lower.EndsWith(".jpeg") ||
                                  lower.EndsWith(".png") || lower.EndsWith(".gif") ||
                                  lower.EndsWith(".webp") || lower.EndsWith(".bmp")
                    });
                }
                if (reviewData?.Criteria != null)
                {
                    foreach (var criteria in reviewData.Criteria)
                    {
                        if (criteria.Result != null)
                        {
                            criteriaResults[criteria.Id] = criteria.Result.IsPassed;
                            criteriaSeverity[criteria.Id] = criteria.Result.Severity;
                            criteriaContent[criteria.Id] = criteria.Result.Content;
                            
                            // Load attachments from API
                            if (criteria.Result.Attachments != null && criteria.Result.Attachments.Any())
                            {
                                criteriaAttachments[criteria.Id] = criteria.Result.Attachments
                                    .Select(url => new AttachmentInfo 
                                    { 
                                        Url = url, 
                                        FileName = Path.GetFileName(url),
                                        IsImage = url.ToLower().EndsWith(".jpg") || url.ToLower().EndsWith(".jpeg") || 
                                                  url.ToLower().EndsWith(".png") || url.ToLower().EndsWith(".gif") || 
                                                  url.ToLower().EndsWith(".webp")
                                    }).ToList();
                            }
                            else
                            {
                                criteriaAttachments[criteria.Id] = new List<AttachmentInfo>();
                            }
                        }
                        else
                        {
                            criteriaResults[criteria.Id] = null; // No default value
                            criteriaAttachments[criteria.Id] = new List<AttachmentInfo>();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải dữ liệu đánh giá: {ex.Message}";
            reviewData = null;
            reviewAttachments.Clear();
        }
        StateHasChanged();
    }

    private async Task HandleCriteriaFileUpload(InputFileChangeEventArgs e, int criteriaId)
    {
        try
        {
            if (!criteriaAttachments.ContainsKey(criteriaId))
            {
                criteriaAttachments[criteriaId] = new List<AttachmentInfo>();
            }

            foreach (var file in e.GetMultipleFiles())
            {
                // Create FormData to upload file
                using var content = new MultipartFormDataContent();
                var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
                var streamContent = new StreamContent(stream);
                content.Add(streamContent, "file", file.Name);

                var response = await Http.PostAsync("/api/stages/upload-attachment", content);
                
                // Dispose stream after upload
                streamContent.Dispose();
                stream.Dispose();
                
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<UploadResult>();
                    if (result != null && !string.IsNullOrEmpty(result.url))
                    {
                        var isImage = file.ContentType.StartsWith("image/") || 
                                     file.Name.ToLower().EndsWith(".jpg") || 
                                     file.Name.ToLower().EndsWith(".jpeg") || 
                                     file.Name.ToLower().EndsWith(".png") || 
                                     file.Name.ToLower().EndsWith(".gif") || 
                                     file.Name.ToLower().EndsWith(".webp");
                        criteriaAttachments[criteriaId].Add(new AttachmentInfo
                        {
                            Url = result.url,
                            FileName = result.fileName ?? file.Name,
                            IsImage = isImage
                        });
                    }
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    errorMessage = $"Lỗi khi upload file {file.Name}: {error}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi upload file: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task HandleReviewFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            foreach (var file in e.GetMultipleFiles())
            {
                using var content = new MultipartFormDataContent();
                var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
                var streamContent = new StreamContent(stream);
                content.Add(streamContent, "file", file.Name);

                var response = await Http.PostAsync("/api/stages/upload-attachment", content);

                streamContent.Dispose();
                stream.Dispose();

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<UploadResult>();
                    if (result != null && !string.IsNullOrEmpty(result.url))
                    {
                        var isImage = file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase) ||
                                      file.Name.ToLower().EndsWith(".jpg") ||
                                      file.Name.ToLower().EndsWith(".jpeg") ||
                                      file.Name.ToLower().EndsWith(".png") ||
                                      file.Name.ToLower().EndsWith(".gif") ||
                                      file.Name.ToLower().EndsWith(".webp") ||
                                      file.Name.ToLower().EndsWith(".bmp");
                        reviewAttachments.Add(new AttachmentInfo
                        {
                            Url = result.url,
                            FileName = result.fileName ?? file.Name,
                            IsImage = isImage
                        });
                    }
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    errorMessage = $"Lỗi khi upload file {file.Name}: {error}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi upload file: {ex.Message}";
        }
        StateHasChanged();
    }


    private bool CanSubmitReview()
    {
        if (reviewData?.Criteria == null) return false;
        
        // Check if all criteria have been selected (not null)
        var allSelected = reviewData.Criteria.All(c => 
            criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id].HasValue);
        
        if (!allSelected) return false;
        
        // Check if failed criteria have severity and content
        foreach (var criteria in reviewData.Criteria)
        {
            if (criteriaResults.ContainsKey(criteria.Id) && criteriaResults[criteria.Id] == false)
            {
                if (string.IsNullOrWhiteSpace(criteriaSeverity.GetValueOrDefault(criteria.Id)))
                    return false;
                if (string.IsNullOrWhiteSpace(criteriaContent.GetValueOrDefault(criteria.Id)))
                    return false;
            }
        }
        
        return true;
    }

    private async Task SubmitReview(bool isPassed)
    {
        if (reviewStageId == null || reviewData == null) return;
        
        // Validate that all criteria have been selected
        var allSelected = reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id].HasValue) ?? false;
        if (!allSelected)
        {
            errorMessage = "Vui lòng đánh giá tất cả các tiêu chí";
            StateHasChanged();
            return;
        }

        // Validate that failed criteria have severity and content
        foreach (var criteria in reviewData.Criteria ?? Enumerable.Empty<CriteriaInfo>())
        {
            if (criteriaResults.ContainsKey(criteria.Id) && criteriaResults[criteria.Id] == false)
            {
                if (string.IsNullOrWhiteSpace(criteriaSeverity.GetValueOrDefault(criteria.Id)))
                {
                    errorMessage = $"Vui lòng chọn mức độ nghiêm trọng cho tiêu chí: {criteria.Name}";
                    StateHasChanged();
                    return;
                }
                if (string.IsNullOrWhiteSpace(criteriaContent.GetValueOrDefault(criteria.Id)))
                {
                    errorMessage = $"Vui lòng nhập nội dung cho tiêu chí: {criteria.Name}";
                    StateHasChanged();
                    return;
                }
            }
        }
        
        var criteriaResultsDto = (reviewData?.Criteria ?? Enumerable.Empty<CriteriaInfo>()).Select(c => new AGDPMS.Shared.Models.DTOs.StageReviewCriteriaResultDto
        {
            CriteriaId = c.Id,
            IsPassed = criteriaResults.ContainsKey(c.Id) ? criteriaResults[c.Id] : null,
            Value = null,
            Notes = null,
            Severity = criteriaSeverity.GetValueOrDefault(c.Id),
            Content = criteriaContent.GetValueOrDefault(c.Id),
            Attachments = criteriaAttachments.GetValueOrDefault(c.Id)?.Select(a => a.Url).ToList()
        }).ToList();

        var dto = new AGDPMS.Shared.Models.DTOs.SubmitStageReviewDto
        {
            Notes = reviewNotes,
            CriteriaResults = criteriaResultsDto,
            IsPassed = isPassed, // Manual pass/fail decision by QA
            Attachments = reviewAttachments.Any() ? reviewAttachments.Select(a => a.Url).ToList() : new List<string>()
        };

        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/stages/{reviewStageId.Value}/submit-review", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            CloseReviewModal();
            await Load(); // Reload to refresh stages
            // Reload review status for all stages to update buttons
            if (model?.stages != null)
            {
                foreach (var stage in model.stages)
                {
                    await CheckReviewStatus(stage.Id);
                }
            }
            StateHasChanged();
        }
    }

    private async Task ViewReview(int stageId)
    {
        System.Diagnostics.Debug.WriteLine($"ViewReview called for stage {stageId}");
        viewReviewStageId = stageId;
        showViewReviewModal = true;
        await LoadViewReviewData(stageId);
        StateHasChanged();
    }

    private void CloseViewReviewModal()
    {
        showViewReviewModal = false;
        viewReviewStageId = null;
        viewReviewData = null;
        StateHasChanged();
    }

    private async Task LoadViewReviewData(int stageId)
    {
        try
        {
            var response = await Http.GetAsync($"/api/stages/{stageId}/latest-review");
            if (response.IsSuccessStatusCode)
            {
                var jsonContent = await response.Content.ReadAsStringAsync();
                System.Diagnostics.Debug.WriteLine($"API Response for stage {stageId}: {jsonContent}");
                
                viewReviewData = await response.Content.ReadFromJsonAsync<ReviewData>();
                
                // Debug: Log attachments data
                if (viewReviewData?.Criteria != null)
                {
                    foreach (var criteria in viewReviewData.Criteria)
                    {
                        if (criteria.Result != null)
                        {
                            var attCount = criteria.Result.Attachments?.Count ?? 0;
                            var attIsNull = criteria.Result.Attachments == null;
                            System.Diagnostics.Debug.WriteLine($"Criteria {criteria.Id} ({criteria.Name}): IsPassed={criteria.Result.IsPassed}, Attachments null={attIsNull}, Count={attCount}");
                            if (criteria.Result.Attachments != null && criteria.Result.Attachments.Any())
                            {
                                foreach (var att in criteria.Result.Attachments)
                                {
                                    System.Diagnostics.Debug.WriteLine($"  - Attachment: {att}");
                                }
                            }
                            else
                            {
                                System.Diagnostics.Debug.WriteLine($"  - No attachments or empty list");
                            }
                        }
                    }
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                System.Diagnostics.Debug.WriteLine($"API Error for stage {stageId}: {response.StatusCode} - {errorContent}");
                viewReviewData = null;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Exception loading review data: {ex.Message}\n{ex.StackTrace}");
            errorMessage = $"Lỗi khi tải dữ liệu đánh giá: {ex.Message}";
            viewReviewData = null;
        }
        StateHasChanged();
    }

    private bool HasPendingReview(int stageId)
    {
        return stageHasPendingReview.ContainsKey(stageId) && stageHasPendingReview[stageId];
    }

    private bool HasLatestReview(int stageId)
    {
        return stageHasLatestReview.ContainsKey(stageId) && stageHasLatestReview[stageId];
    }

    private int? currentUserId;

    private async Task LoadCurrentUserId()
    {
        if (!currentUserId.HasValue)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out var userId))
            {
                currentUserId = userId;
            }
        }
    }

    private bool IsAssignedQa(StageDto stage)
    {
        if (!IsQa() || !currentUserId.HasValue) return false;
        return stage.AssignedQaUserId == currentUserId.Value;
    }

    private class ReviewData
    {
        public ReviewInfo? Review { get; set; }
        public List<CriteriaInfo>? Criteria { get; set; }
    }

    private class ReviewInfo
    {
        public int Id { get; set; }
        public int ProductionItemStageId { get; set; }
        public int RequestedByUserId { get; set; }
        public int? ReviewedByUserId { get; set; }
        public string Status { get; set; } = string.Empty;
        public string? Notes { get; set; }
        public DateTime? RequestedAt { get; set; }
        public DateTime? ReviewedAt { get; set; }
        public List<string>? Attachments { get; set; }
    }

    private class CriteriaInfo
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string CheckType { get; set; } = "boolean";
        public bool Required { get; set; }
        public int OrderIndex { get; set; }
        public CriteriaResult? Result { get; set; }
    }

    private class CriteriaResult
    {
        public bool? IsPassed { get; set; }
        public string? Value { get; set; }
        public string? Notes { get; set; }
        public string? Severity { get; set; }
        public string? Content { get; set; }
        public List<string>? Attachments { get; set; }
    }

    private class AttachmentInfo
    {
        public string Url { get; set; } = string.Empty;
        public string FileName { get; set; } = string.Empty;
        public bool IsImage { get; set; }
    }

    private class MaterialSummaryDto
    {
        public string? MaterialId { get; set; }
        public string? MaterialName { get; set; }
        public string? MaterialType { get; set; }
        public int Quantity { get; set; }
        public double Length { get; set; }
        public double Width { get; set; }
        public string? Unit { get; set; }
        public string? Color { get; set; }
    }

    private class UploadResult
    {
        public string? url { get; set; }
        public string? fileName { get; set; }
    }

    private string? imageModalUrl;
    private bool showImageModal = false;
    private bool isImageInModal = true;

    private void OpenMediaModal(string mediaUrl, bool isImage)
    {
        imageModalUrl = mediaUrl;
        isImageInModal = isImage;
        showImageModal = true;
        StateHasChanged();
    }

    private void CloseImageModal()
    {
        showImageModal = false;
        imageModalUrl = null;
        isImageInModal = true;
        StateHasChanged();
    }
}