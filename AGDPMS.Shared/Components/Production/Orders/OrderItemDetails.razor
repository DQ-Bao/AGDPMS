@page "/production/orders/{OrderId:int}/items/{ItemId:int}"
@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Models.DTOs
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Linq
@using System.Text
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/production/orders">Lệnh sản xuất</a></li>
            <li class="breadcrumb-item"><a href="/production/orders/@OrderId">@(model?.order?.Code ?? "Chi tiết")</a></li>
            <li class="breadcrumb-item active">Item #@(model?.item?.LineNo ?? ItemId)</li>
        </ol>
    </nav>
    @if (model is null)
    {
        <div>Loading...</div>
    }
    else
    {
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <h5 class="mb-1">Item #@model.item?.LineNo - @(model.item?.Code ?? "N/A") - @(model.item?.CavityName ?? model.item?.CavityCode ?? $"Cavity {model.item?.CavityId}")</h5>
                <div class="text-secondary">Lệnh sản xuất: @model.order?.Code | Trạng thái: @GetOrderStatusDisplay()</div>
                <div class="text-secondary small mt-1">
                    <span>Kế hoạch: Bắt đầu: @FormatDate(model.item?.PlannedStartDate) | Kết thúc: @FormatDate(model.item?.PlannedFinishDate)</span>
                </div>
                <div class="text-secondary small">
                    <span>Thực tế: Bắt đầu: @FormatDate(model.item?.ActualStartDate) | Kết thúc: @FormatDate(model.item?.ActualFinishDate)</span>
                </div>
                <div class="text-secondary small mt-1">
                    <span>Giờ kế hoạch: @($"{model.item?.PlannedTimeHours ?? 0:F1}h")</span>
                    <span class="ms-3">Giờ thực tế: @($"{model.item?.ActualTimeHours ?? 0:F1}h")</span>
                </div>
                @if (model.item?.IsLate == true)
                {
                    <div class="text-danger small mt-1">
                        <span class="badge bg-danger">Trễ</span>
                        <span>@GetLateTooltip()</span>
                    </div>
                }
            </div>
            <div class="d-flex flex-column gap-2 align-items-end">
                @* QR Code *@
                @if (!string.IsNullOrWhiteSpace(model?.item?.QRCode) && qrImageUrl != null)
                {
                    <img src="@qrImageUrl" alt="QR Code" class="img-fluid" style="max-width: 120px; height: auto;" />
                }
                @if (CanEditItemCompletion())
                {
                    <button class="btn btn-sm @(model?.item?.IsCompleted == true ? "btn-success" : "btn-outline-secondary")"
                            @onclick="ToggleItemCompletion"
                            disabled="@(!CanCompleteItem())">
                        @(model?.item?.IsCompleted == true ? "Đã hoàn thành" : "Chưa hoàn thành")
                    </button>
                }
                else
                {
                    <span class="badge @(model?.item?.IsCompleted == true ? "bg-success" : "bg-secondary")">
                        @(model?.item?.IsCompleted == true ? "Đã hoàn thành" : "Chưa hoàn thành")
                    </span>
                }
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }


        @* Stage Progress Bar *@
        @if (model?.item != null)
        {
            <div class="mb-3">
                <div class="small text-secondary mb-1">Tiến độ giai đoạn: @(model.item.CompletedStages)/@(model.item.TotalStages)</div>
                <div class="progress" style="height: 30px;">
                    @{
                        var totalStages = model.item.TotalStages;
                        var completedStages = model.item.CompletedStages;
                        var progressPercent = totalStages > 0 
                            ? (completedStages * 100.0 / totalStages) 
                            : 0;
                        var progressClass = progressPercent == 100 ? "bg-success" : (progressPercent > 0 ? "bg-info" : "bg-secondary");
                    }
                    <div class="progress-bar @progressClass" role="progressbar" 
                         style="width: @($"{progressPercent:F1}%")" 
                         aria-valuenow="@progressPercent" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span class="ms-2">@($"{progressPercent:F1}%")</span>
                    </div>
                </div>
            </div>
        }

        @* Stages Table *@
        <div class="table-responsive" style="max-height:60vh; overflow:auto;">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Giai đoạn</th>
                        <th>QA phụ trách</th>
                        <th>Trạng thái</th>
                        <th>Kế hoạch (giờ)</th>
                        <th>Thực tế (giờ)</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (model?.stages?.Any() == true)
                    {
                        @foreach (var s in model.stages.Where(st => ShouldShowStage(st)))
                        {
                            var canReview = IsQa() && model?.order?.Status == ProductionOrderStatus.InProduction && HasPendingReview(s.Id) && IsAssignedQa(s);
                            var reviewStatus = GetReviewStatus(s.Id);
                            var rowClass = reviewStatus == "passed" ? "table-success" : (reviewStatus == "failed" ? "table-danger" : "");
                            <tr class="@rowClass">
                                <td>
                                    <div><strong>@s.StageName</strong></div>
                                </td>
                                <td>
                                    @if (ShouldShowButton("AssignQa", s))
                                    {
                                        <span style="cursor:pointer;"
                                              @onclick='@(async () => await OpenQaSelector(s.Id))' 
                                              @onclick:stopPropagation="true"
                                              title="Click để giao QA">
                                            @(s.AssignedQaUserName ?? "Chưa phân công")
                                        </span>
                                    }
                                    else
                                    {
                                        <span>@(s.AssignedQaUserName ?? "Chưa phân công")</span>
                                    }
                                </td>
                                <td>
                                    <span>@GetStageStatus(s)</span>
                                </td>
                                <td>
                                    @if (CanEditStagePlan() && editingPlanStageId == s.Id)
                                    {
                                        <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                            <div class="d-flex gap-1 align-items-center">
                                                <input type="number" class="form-control form-control-sm" style="width: 90px;" min="0" step="0.1" @bind="editingPlannedTimeHours" />
                                                <span>h</span>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-success" @onclick='@(() => SaveStagePlan(s.Id))'>✓</button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelStagePlanEdit">✗</button>
                                            </div>
                                        </div>
                                    }
                                    else if (CanEditStagePlan())
                                    {
                                        <div style="cursor:pointer;" class="text-primary text-decoration-underline"
                                             @onclick='@(() => StartEditStagePlan(s))'
                                             @onclick:stopPropagation="true"
                                             title="Click để chỉnh giờ kế hoạch">
                                            @FormatStageHours(s.PlannedTimeHours)
                                        </div>
                                    }
                                    else
                                    {
                                        <div>@FormatStageHours(s.PlannedTimeHours)</div>
                                    }
                                </td>
                                <td>
                                    @if (CanEditStageActual() && editingActualStageId == s.Id)
                                    {
                                        <div class="d-flex flex-column gap-1" @onclick:stopPropagation="true">
                                            <div class="d-flex gap-1 align-items-center">
                                                <input type="number" class="form-control form-control-sm" style="width: 90px;" min="0" step="0.1" @bind="editingActualTimeHours" />
                                                <span>h</span>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-success" @onclick='@(() => SaveStageActual(s.Id))'>✓</button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelStageActualEdit">✗</button>
                                            </div>
                                        </div>
                                    }
                                    else if (CanEditStageActual())
                                    {
                                        <div style="cursor:pointer;" class="text-primary text-decoration-underline"
                                             @onclick='@(() => StartEditStageActual(s))'
                                             @onclick:stopPropagation="true"
                                             title="Click để chỉnh giờ thực tế">
                                            @FormatStageHours(s.ActualTimeHours)
                                        </div>
                                    }
                                    else
                                    {
                                        <div>@FormatStageHours(s.ActualTimeHours)</div>
                                    }
                                </td>
                                <td class="text-nowrap">
                                    @if (ShouldShowButton("RequestReview", s))
                                    {
                                        <button class="btn btn-outline-primary btn-sm me-1" @onclick='@(() => RequestReview(s.Id))'>Yêu cầu kiểm tra</button>
                                    }
                                    @if (canReview)
                                    {
                                        <button class="btn btn-outline-success btn-sm me-1" @onclick='@(() => OpenReviewModal(s.Id))'>Kiểm tra</button>
                                    }
                                    @if (ShouldShowButton("ViewReview", s))
                                    {
                                        var reviewStatusText = GetReviewStatusText(s.Id);
                                        var buttonText = string.IsNullOrEmpty(reviewStatusText) 
                                            ? "Xem kiểm tra" 
                                            : $"Xem kiểm tra ({reviewStatusText})";
                                        <button class="btn btn-outline-info btn-sm me-1" @onclick='@(() => ViewReview(s.Id))'>
                                            @buttonText
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">Không có giai đoạn</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (IsProductionManager() && (model?.order?.Status == ProductionOrderStatus.Draft || model?.order?.Status == ProductionOrderStatus.InProduction))
        {
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" @onclick="OpenBulkQaModal">Giao QA nhanh cho toàn bộ</button>
            </div>
        }
    }
</div>

@* QA Selection Modal *@
@if (showQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chọn nhân viên QA</h5>
                    <button type="button" class="btn-close" @onclick="CloseQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            @foreach (var qa in qaUsers)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick='@(() => SelectQa(qa.Id))'>
                                    <div><strong>@qa.Name</strong></div>
                                    <small class="text-muted">@qa.Phone</small>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Bulk QA Assignment Modal *@
@if (showBulkQaModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Giao QA nhanh cho toàn bộ giai đoạn</h5>
                    <button type="button" class="btn-close" @onclick="CloseBulkQaModal"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Tìm QA..." @bind-value="qaSearch" @bind-value:event="oninput" @bind-value:after="LoadQaUsers" />
                    <div class="list-group" style="max-height:300px; overflow:auto;">
                        @if (qaUsers is null)
                        {
                            <div>Đang tải...</div>
                        }
                        else if (!qaUsers.Any())
                        {
                            <div>Không tìm thấy nhân viên QA</div>
                        }
                        else
                        {
                            @foreach (var qa in qaUsers)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick='@(() => SelectBulkQa(qa.Id))'>
                                    <div><strong>@qa.Name</strong></div>
                                    <small class="text-muted">@qa.Phone</small>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Review Modal *@
@if (showReviewModal && reviewData != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="badge @(reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id] == true) == true ? "bg-success" : "bg-warning")">
                            @{
                                var allSelected = reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id].HasValue) == true;
                                var allPassed = reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id] == true) == true;
                                if (allSelected && allPassed)
                                {
                                    <text>Đã đạt</text>
                                }
                                else if (allSelected)
                                {
                                    <text>Chưa đạt</text>
                                }
                                else
                                {
                                    <text>Đang kiểm tra</text>
                                }
                            }
                        </span>
                        <span class="ms-2">Kiểm tra giai đoạn</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseReviewModal"></button>
                </div>
                <div class="modal-body">
                    @if (reviewData.Criteria != null)
                    {
                        <div class="mb-3">
                            <h6>Tiêu chí kiểm tra:</h6>
                            <div class="list-group">
                                @foreach (var criteria in reviewData.Criteria.OrderBy(c => c.OrderIndex).ThenBy(c => c.Id))
                                {
                                    var isPassed = criteriaResults.ContainsKey(criteria.Id) ? criteriaResults[criteria.Id] : null;
                                    var isExpanded = isPassed == false;
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">@criteria.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(criteria.Description))
                                                {
                                                    <small class="text-muted">@criteria.Description</small>
                                                }
                                            </div>
                                            <div class="ms-3">
                                                <select class="form-select" 
                                                        style="min-width: 150px; @(isPassed == null ? "border: 2px solid #ffc107; background-color: #fff9e6;" : isPassed == true ? "border: 2px solid #28a745; background-color: #d4edda;" : "border: 2px solid #dc3545; background-color: #f8d7da;")"
                                                        value="@(isPassed.HasValue ? isPassed.Value.ToString().ToLower() : "")"
                                                        @onchange='@((ChangeEventArgs e) => { 
                                                            var value = e.Value?.ToString();
                                                            if (string.IsNullOrEmpty(value))
                                                            {
                                                                criteriaResults[criteria.Id] = null;
                                                                // Clear severity and content when unselected
                                                                criteriaSeverity.Remove(criteria.Id);
                                                                criteriaContent.Remove(criteria.Id);
                                                            }
                                                            else if (bool.TryParse(value, out var boolValue))
                                                            {
                                                                criteriaResults[criteria.Id] = boolValue;
                                                                // Initialize severity and content if not exists
                                                                if (boolValue == false && !criteriaSeverity.ContainsKey(criteria.Id))
                                                                {
                                                                    criteriaSeverity[criteria.Id] = null;
                                                                    criteriaContent[criteria.Id] = null;
                                                                }
                                                            }
                                                            StateHasChanged();
                                                        })'>
                                                    <option value="">Chọn...</option>
                                                    <option value="true">Đạt</option>
                                                    <option value="false">Không đạt</option>
                                                </select>
                                            </div>
                                        </div>
                                        @if (isExpanded)
                                        {
                                            <div class="mt-3 p-3 border rounded bg-light">
                                                <div class="mb-3">
                                                    <label class="form-label">Mức độ nghiêm trọng <span class="text-danger">*</span></label>
                                                    <select class="form-select" @bind="criteriaSeverity[criteria.Id]" @bind:after="StateHasChanged">
                                                        <option value="">-- Chọn mức độ --</option>
                                                        <option value="low">Thấp</option>
                                                        <option value="medium">Trung bình</option>
                                                        <option value="high">Cao</option>
                                                        <option value="critical">Nghiêm trọng</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Nội dung <span class="text-danger">*</span></label>
                                                    <textarea class="form-control" rows="3" 
                                                              placeholder="Mô tả chi tiết vấn đề..."
                                                              @bind="criteriaContent[criteria.Id]" 
                                                              @bind:after="StateHasChanged"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Đính kèm ảnh/video</label>
                                                    <InputFile class="form-control" 
                                                               accept="image/*,video/*" 
                                                               multiple
                                                               OnChange="@(e => HandleCriteriaFileUpload(e, criteria.Id))" />
                                                    @if (!string.IsNullOrEmpty(errorMessage) && errorMessage.Contains("upload"))
                                                    {
                                                        <div class="alert alert-danger mt-2">@errorMessage</div>
                                                    }
                                                    @if (criteriaAttachments.ContainsKey(criteria.Id) && criteriaAttachments[criteria.Id].Any())
                                                    {
                                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                                            @foreach (var attachment in criteriaAttachments[criteria.Id])
                                                            {
                                                                <div class="position-relative" style="width: 120px; height: 120px;">
                                                                    @if (attachment.IsImage)
                                                                    {
                                                                        <img src="@attachment.Url" alt="@attachment.FileName" 
                                                                             class="img-thumbnail w-100 h-100" 
                                                                             style="object-fit: cover; cursor: pointer;"
                                                                             @onclick='@(() => OpenMediaModal(attachment.Url, true))'
                                                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\'%3E%3Crect width=\'120\' height=\'120\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ELỗi tải ảnh%3C/text%3E%3C/svg%3E';" />
                                                                    }
                                                                    else
                                                                    {
                                                                        <video src="@attachment.Url" 
                                                                               class="img-thumbnail w-100 h-100" 
                                                                               style="object-fit: cover; cursor: pointer;"
                                                                               @onclick='@(() => OpenMediaModal(attachment.Url, false))'
                                                                               onerror="this.onerror=null; this.style.display='none';"></video>
                                                                    }
                                                                    <button type="button" 
                                                                            class="btn-close position-absolute top-0 end-0 bg-white rounded-circle p-1" 
                                                                            style="opacity: 0.8;"
                                                                            @onclick='@(() => { criteriaAttachments[criteria.Id].Remove(attachment); StateHasChanged(); })'></button>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" rows="4" placeholder="Nhập ghi chú..." @bind="reviewNotes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseReviewModal">Hủy</button>
                    @{
                        var canSubmit = CanSubmitReview();
                        var submitTooltip = canSubmit ? "" : "Vẫn còn tiêu chí chưa hoàn thành đánh giá";
                    }
                    <span title="@submitTooltip">
                        <button type="button" 
                                class="btn btn-primary" 
                                @onclick="SubmitReview" 
                                disabled="@(!canSubmit)"
                                style="@(!canSubmit ? "cursor: not-allowed;" : "")">
                            Xác nhận
                        </button>
                    </span>
                </div>
            </div>
        </div>
    </div>
}

@* View Review Modal *@
@if (showViewReviewModal && viewReviewData != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="badge @(viewReviewData.Review?.Status == "passed" ? "bg-success" : "bg-danger")">
                            @(viewReviewData.Review?.Status == "passed" ? "Đã đạt" : "Chưa đạt")
                        </span>
                        <span class="ms-2">Kết quả kiểm tra</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseViewReviewModal"></button>
                </div>
                <div class="modal-body">
                    @if (viewReviewData.Review != null)
                    {
                        <div class="mb-3">
                            <small class="text-muted">
                                Yêu cầu lúc: @FormatDate(viewReviewData.Review.RequestedAt) | 
                                @if (viewReviewData.Review.ReviewedAt.HasValue)
                                {
                                    <span>Kiểm tra lúc: @FormatDate(viewReviewData.Review.ReviewedAt)</span>
                                }
                            </small>
                        </div>
                    }
                    @if (viewReviewData.Criteria != null)
                    {
                        <div class="mb-3">
                            <h6>Kết quả kiểm tra:</h6>
                            <div class="list-group">
                                @foreach (var criteria in viewReviewData.Criteria.OrderBy(c => c.OrderIndex).ThenBy(c => c.Id))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">@criteria.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(criteria.Description))
                                                {
                                                    <small class="text-muted">@criteria.Description</small>
                                                }
                                            </div>
                                            <div class="ms-3">
                                                @if (criteria.Result != null)
                                                {
                                                    <span class="badge @(criteria.Result.IsPassed == true ? "bg-success" : "bg-danger")">
                                                        @(criteria.Result.IsPassed == true ? "Đạt" : "Không đạt")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Chưa kiểm tra</span>
                                                }
                                            </div>
                                        </div>
                                        @if (criteria.Result != null && criteria.Result.IsPassed == false)
                                        {
                                            <div class="mt-3 p-3 border rounded bg-light">
                                                @if (!string.IsNullOrWhiteSpace(criteria.Result.Severity))
                                                {
                                                    <div class="mb-2">
                                                        <strong>Mức độ nghiêm trọng:</strong>
                                                        <span class="badge @(criteria.Result.Severity == "critical" ? "bg-danger" : criteria.Result.Severity == "high" ? "bg-warning" : criteria.Result.Severity == "medium" ? "bg-info" : "bg-secondary")">
                                                            @(criteria.Result.Severity == "critical" ? "Nghiêm trọng" : 
                                                              criteria.Result.Severity == "high" ? "Cao" : 
                                                              criteria.Result.Severity == "medium" ? "Trung bình" : "Thấp")
                                                        </span>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(criteria.Result.Content))
                                                {
                                                    <div class="mb-2">
                                                        <strong>Nội dung:</strong>
                                                        <div class="mt-1">@criteria.Result.Content</div>
                                                    </div>
                                                }
                                                @{
                                                    var hasAttachments = criteria.Result?.Attachments != null && criteria.Result.Attachments.Any();
                                                }
                                                @if (hasAttachments)
                                                {
                                                    <div class="mb-2">
                                                        <strong>Đính kèm (@criteria.Result!.Attachments!.Count):</strong>
                                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                                            @foreach (var attachmentUrl in criteria.Result.Attachments!)
                                                            {
                                                                if (!string.IsNullOrEmpty(attachmentUrl))
                                                                {
                                                                    var urlLower = attachmentUrl.ToLower();
                                                                    var isImage = urlLower.EndsWith(".jpg") || urlLower.EndsWith(".jpeg") || 
                                                                                  urlLower.EndsWith(".png") || urlLower.EndsWith(".gif") || 
                                                                                  urlLower.EndsWith(".webp") || urlLower.EndsWith(".bmp");
                                                                    var isVideo = urlLower.EndsWith(".mp4") || urlLower.EndsWith(".mov") || 
                                                                                  urlLower.EndsWith(".avi") || urlLower.EndsWith(".mkv") ||
                                                                                  urlLower.EndsWith(".webm");
                                                                    <div class="position-relative" style="width: 200px; height: 200px; border: 1px solid #dee2e6; border-radius: 0.25rem; overflow: hidden;">
                                                                        @if (isImage)
                                                                        {
                                                                            <img src="@attachmentUrl" alt="Attachment" 
                                                                                 class="w-100 h-100" 
                                                                                 style="object-fit: cover; cursor: pointer; display: block;"
                                                                                 @onclick='@(() => OpenMediaModal(attachmentUrl, true))' 
                                                                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EKhông thể tải ảnh%3C/text%3E%3C/svg%3E';" />
                                                                        }
                                                                        else if (isVideo)
                                                                        {
                                                                            <video src="@attachmentUrl" 
                                                                                   class="w-100 h-100" 
                                                                                   style="object-fit: cover; cursor: pointer; display: block;"
                                                                                   @onclick='@(() => OpenMediaModal(attachmentUrl, false))'
                                                                                   preload="metadata"
                                                                                   muted
                                                                                   onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center h-100 bg-light text-muted\'><small>Không thể tải video</small></div>';"></video>
                                                                            <div class="position-absolute top-50 start-50 translate-middle" style="pointer-events: none;">
                                                                                <i class="bi bi-play-circle-fill text-white" style="font-size: 3rem; text-shadow: 0 0 10px rgba(0,0,0,0.5);"></i>
                                                                            </div>
                                                                        }
                                                                        else
                                                                        {
                                                                            <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                                                                                <small>File: @Path.GetFileName(attachmentUrl)</small>
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                else if (criteria.Result != null)
                                                {
                                                    <div class="mb-2 text-muted">
                                                        <small>Không có đính kèm</small>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(viewReviewData.Review?.Notes))
                    {
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <div class="form-control" style="min-height: 80px;">@viewReviewData.Review.Notes</div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewReviewModal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}

@* Media Modal (Image/Video) *@
@if (showImageModal && !string.IsNullOrEmpty(imageModalUrl))
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.9); z-index: 9999;" @onclick="CloseImageModal">
        <div class="modal-dialog modal-xl modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseImageModal"></button>
                </div>
                <div class="modal-body p-0 text-center">
                    @if (isImageInModal)
                    {
                        <img src="@imageModalUrl" alt="Preview" class="img-fluid" style="max-height: 85vh; max-width: 100%;" />
                    }
                    else
                    {
                        <video src="@imageModalUrl" controls class="w-100" style="max-height: 85vh;" autoplay></video>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int OrderId { get; set; }
    [Parameter] public int ItemId { get; set; }

    private ItemDetailsResponse? model;
    private string? userRole;
    private string? errorMessage;
    private bool showQaModal = false;
    private string? qrImageUrl;
    private int? selectedStageIdForQa;
    private List<QaUser>? qaUsers;
    private string? qaSearch;
    private bool showBulkQaModal = false;
    
    // Review states
    private bool showReviewModal = false;
    private int? reviewStageId;
    private ReviewData? reviewData;
    private Dictionary<int, bool?> criteriaResults = new();
    private Dictionary<int, string?> criteriaSeverity = new();
    private Dictionary<int, string?> criteriaContent = new();
    private Dictionary<int, List<AttachmentInfo>> criteriaAttachments = new();
    private string reviewNotes = string.Empty;
    private bool showViewReviewModal = false;
    private int? viewReviewStageId;
    private ReviewData? viewReviewData;
    private Dictionary<int, bool> stageHasPendingReview = new();
    private Dictionary<int, bool> stageHasLatestReview = new();
    private Dictionary<int, string> stageReviewStatus = new(); // Store review status: "passed", "failed", or empty
    
    // Inline editing states
    private int? editingPlanStageId;
    private decimal? editingPlannedTimeHours;
    private int? editingActualStageId;
    private decimal? editingActualTimeHours;

    protected override async Task OnParametersSetAsync()
    {
        await LoadUserRole();
        await LoadCurrentUserId();
        await Load();
        LoadQrImage();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userRole = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
    }

    private async Task Load()
    {
        errorMessage = null;
        try
        {
            var response = await Http.GetAsync($"/api/items/{ItemId}");
            if (response.IsSuccessStatusCode)
            {
                model = await response.Content.ReadFromJsonAsync<ItemDetailsResponse>();
                // Load review status and issues for each stage
                if (model?.stages != null)
                {
                    foreach (var stage in model.stages)
                    {
                        await CheckReviewStatus(stage.Id);
                    }
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Lỗi khi tải item: {response.StatusCode}. {errorContent}";
                model = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải item: {ex.Message}";
            model = null;
        }
    }

    private async Task CheckReviewStatus(int stageId)
    {
        try
        {
            // Check for pending review first
            var pendingResponse = await Http.GetAsync($"/api/stages/{stageId}/review");
            if (pendingResponse.IsSuccessStatusCode)
            {
                var pendingReview = await pendingResponse.Content.ReadFromJsonAsync<ReviewData>();
                if (pendingReview?.Review != null && pendingReview.Review.Status == "pending")
                {
                    // There's a pending review, don't show "ViewReview" button
                    stageHasPendingReview[stageId] = true;
                    stageHasLatestReview[stageId] = false;
                    stageReviewStatus[stageId] = ""; // No status for pending
                    return;
                }
            }
            
            // Check latest review (completed reviews)
            var response = await Http.GetAsync($"/api/stages/{stageId}/latest-review");
            if (response.IsSuccessStatusCode)
            {
                var review = await response.Content.ReadFromJsonAsync<ReviewData>();
                if (review?.Review != null)
                {
                    // Only show "ViewReview" if review is completed (passed or failed), not pending
                    var status = review.Review.Status;
                    stageHasLatestReview[stageId] = (status == "passed" || status == "failed");
                    stageHasPendingReview[stageId] = (status == "pending");
                    stageReviewStatus[stageId] = (status == "passed" || status == "failed") ? status : "";
                }
                else
                {
                    stageHasLatestReview[stageId] = false;
                    stageHasPendingReview[stageId] = false;
                    stageReviewStatus[stageId] = "";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // No review at all
                stageHasLatestReview[stageId] = false;
                stageHasPendingReview[stageId] = false;
                stageReviewStatus[stageId] = "";
            }
        }
        catch
        {
            stageHasLatestReview[stageId] = false;
            stageHasPendingReview[stageId] = false;
            stageReviewStatus[stageId] = "";
        }
    }

    private string GetReviewStatus(int stageId)
    {
        return stageReviewStatus.ContainsKey(stageId) ? stageReviewStatus[stageId] : "";
    }

    private string GetReviewStatusText(int stageId)
    {
        var status = GetReviewStatus(stageId);
        return status == "passed" ? "đạt" : (status == "failed" ? "không đạt" : "");
    }

    private void LoadQrImage()
    {
        if (model?.item?.QRCode == null) return;
        qrImageUrl = $"/api/items/{ItemId}/qr";
        StateHasChanged();
    }

    private async Task OpenQaSelector(int stageId)
    {
        selectedStageIdForQa = stageId;
        showQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
        StateHasChanged();
    }

    private void CloseQaModal()
    {
        showQaModal = false;
        selectedStageIdForQa = null;
        qaSearch = null;
    }

    private async Task LoadQaUsers()
    {
        try
        {
            var url = "/api/lookup/qa-users" + (string.IsNullOrWhiteSpace(qaSearch) ? string.Empty : $"?q={Uri.EscapeDataString(qaSearch!)}");
            qaUsers = await Http.GetFromJsonAsync<List<QaUser>>(url) ?? new();
        }
        catch
        {
            qaUsers = new();
        }
        StateHasChanged();
    }

    private async Task SelectQa(int qaUserId)
    {
        if (selectedStageIdForQa.HasValue)
        {
            await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{selectedStageIdForQa.Value}/assign-qa", new { QaUserId = qaUserId }));
        }
        CloseQaModal();
    }

    private async Task OpenBulkQaModal()
    {
        showBulkQaModal = true;
        qaSearch = null;
        qaUsers = null;
        await LoadQaUsers();
    }

    private void CloseBulkQaModal()
    {
        showBulkQaModal = false;
        qaSearch = null;
    }

    private async Task SelectBulkQa(int qaUserId)
    {
        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/items/{ItemId}/assign-qa-bulk", new { QaUserId = qaUserId }));
        CloseBulkQaModal();
    }

    private bool ShouldShowStage(StageDto stage)
    {
        // Hide stages with planned_time_hours = 0 or NULL unless order is Draft
        if (model?.order?.Status != ProductionOrderStatus.Draft)
        {
            if (!stage.PlannedTimeHours.HasValue || stage.PlannedTimeHours == 0)
            {
                return false;
            }
        }
        return true;
    }

    private bool ShouldShowButton(string buttonName, StageDto stage)
    {
        switch (buttonName)
        {
            case "AssignQa":
                return IsProductionManager() && !stage.IsCompleted && (model?.order?.Status == ProductionOrderStatus.Draft || model?.order?.Status == ProductionOrderStatus.InProduction);
            case "RequestReview":
                return IsProductionManager() && !stage.IsCompleted && model?.order?.Status == ProductionOrderStatus.InProduction && !HasPendingReview(stage.Id);
            case "Review":
                // Need to check async, so we'll handle this differently
                return false; // Will be set via async check
            case "ViewReview":
                // Only show if there's a completed review (passed or failed) and no pending review
                return HasLatestReview(stage.Id) && !HasPendingReview(stage.Id);
            default:
                return false;
        }
    }

    private bool HasRole(string role) => string.Equals(userRole, role, StringComparison.OrdinalIgnoreCase);
    private bool IsProductionManager() => HasRole("ProductionManager") || HasRole("Production Manager");
    private bool IsQa() => HasRole("QA") || HasRole("Qa");
    private bool IsDirector() => HasRole("Admin") || HasRole("Director");

    private bool CanEditStagePlan() => IsProductionManager() && (model?.order?.Status == ProductionOrderStatus.Draft);
    private bool CanEditStageActual() => IsProductionManager() && (model?.order?.Status == ProductionOrderStatus.InProduction);
    private bool CanEditItemCompletion() => IsProductionManager() && model?.order?.Status == ProductionOrderStatus.InProduction;

    private bool CanCompleteItem()
    {
        if (!CanEditItemCompletion() || model?.item == null || model?.stages == null)
            return false;

        // Check if all stages are completed
        var visibleStages = model.stages.Where(st => ShouldShowStage(st)).ToList();
        if (!visibleStages.All(s => s.IsCompleted))
            return false;

        return true;
    }

    private string GetStageStatus(StageDto stage)
    {
        if (HasPendingReview(stage.Id))
        {
            return "Chờ kiểm tra QA";
        }
        // Calculate status dynamically from actual_time_hours
        if (stage.IsCompleted)
        {
            return "Đã hoàn thành";
        }
        if (stage.ActualTimeHours.HasValue && stage.ActualTimeHours > 0)
        {
            return "Đang thực hiện";
        }
        return "Chưa bắt đầu";
    }

    private string FormatDate(DateTime? value) => value.HasValue ? value.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm") : "-";

    private async Task ExecuteStageAction(Func<Task<HttpResponseMessage>> action)
    {
        try
        {
            var response = await action();
            if (response.IsSuccessStatusCode)
            {
                errorMessage = null;
                await Load();
            }
            else
            {
                var detail = await response.Content.ReadAsStringAsync();
                errorMessage = $"Thao tác thất bại: {response.StatusCode} - {detail}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi: {ex.Message}";
        }
        await InvokeAsync(StateHasChanged);
    }

    private void StartEditStagePlan(StageDto stage)
    {
        editingPlanStageId = stage.Id;
        editingPlannedTimeHours = stage.PlannedTimeHours;
        StateHasChanged();
    }

    private void CancelStagePlanEdit()
    {
        editingPlanStageId = null;
        StateHasChanged();
    }

    private async Task SaveStagePlan(int stageId)
    {
        var dto = new UpdateStagePlanDto
        {
            PlannedTimeHours = editingPlannedTimeHours
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/plan", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingPlanStageId = null;
        }
    }

    private void StartEditStageActual(StageDto stage)
    {
        editingActualStageId = stage.Id;
        editingActualTimeHours = stage.ActualTimeHours;
        StateHasChanged();
    }

    private void CancelStageActualEdit()
    {
        editingActualStageId = null;
        StateHasChanged();
    }

    private async Task SaveStageActual(int stageId)
    {
        var dto = new UpdateStageDatesDto
        {
            ActualTimeHours = editingActualTimeHours
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/stages/{stageId}/dates", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            editingActualStageId = null;
        }
    }

    private string FormatStageHours(decimal? hours)
    {
        if (!hours.HasValue)
        {
            return "-";
        }
        return $"{hours.Value:F1}h";
    }

    private async Task ToggleItemCompletion()
    {
        if (model?.item == null) return;
        var dto = new UpdateItemCompletionDto
        {
            IsCompleted = !model.item.IsCompleted
        };
        await ExecuteStageAction(() => Http.PutAsJsonAsync($"/api/items/{ItemId}/completion", dto));
    }

    private string GetOrderStatusDisplay()
    {
        if (model?.order is null) return string.Empty;
        return GetStatusLabel(model.order.Status);
    }

    private string GetStatusLabel(ProductionOrderStatus status) => status switch
    {
        ProductionOrderStatus.Draft => "Nháp",
        ProductionOrderStatus.PendingDirectorApproval => "Chờ giám đốc duyệt",
        ProductionOrderStatus.DirectorRejected => "Bị từ chối",
        ProductionOrderStatus.PendingQACheckMachines => "Chờ QA kiểm tra máy",
        ProductionOrderStatus.PendingQACheckMaterial => "Chờ QA kiểm tra vật tư",
        ProductionOrderStatus.InProduction => "Đang sản xuất",
        ProductionOrderStatus.Finished => "Hoàn thành",
        ProductionOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    private string GetLateTooltip()
    {
        if (model?.item == null || !model.item.IsLate) return string.Empty;
        if (model.item.IsOverdue && model.item.DaysLate > 0)
        {
            return $"Đã quá hạn kế hoạch {model.item.DaysLate} ngày";
        }
        if (model.item.IsOverdue)
        {
            return "Đã quá hạn kế hoạch";
        }
        if (model.item.DaysLate > 0)
        {
            return $"Hoàn thành trễ {model.item.DaysLate} ngày";
        }
        return "Trễ kế hoạch";
    }

    private class ItemDetailsResponse
    {
        public ItemDto? item { get; set; }
        public OrderDto? order { get; set; }
        public List<StageDto>? stages { get; set; }
    }

    private class ItemDto
    {
        public int Id { get; set; }
        public int CavityId { get; set; }
        public string? CavityCode { get; set; }
        public string? CavityName { get; set; }
        public string Code { get; set; } = string.Empty;
        public int LineNo { get; set; }
        public string? QRCode { get; set; }
        public bool IsCompleted { get; set; }
        public DateTime? PlannedStartDate { get; set; }
        public DateTime? PlannedFinishDate { get; set; }
        public DateTime? ActualStartDate { get; set; }
        public DateTime? ActualFinishDate { get; set; }
        public decimal? PlannedTimeHours { get; set; }
        public decimal? ActualTimeHours { get; set; }
        public bool IsLate { get; set; }
        public bool IsOverdue { get; set; }
        public int DaysLate { get; set; }
        public int CompletedStages { get; set; }
        public int TotalStages { get; set; }
    }

    private class OrderDto
    {
        public int Id { get; set; }
        public string? Code { get; set; }
        public ProductionOrderStatus Status { get; set; }
        public int ProjectId { get; set; }
    }

    private class StageDto
    {
        public int Id { get; set; }
        public int StageTypeId { get; set; }
        public string StageName { get; set; } = string.Empty;
        public decimal? PlannedTimeHours { get; set; }
        public decimal? ActualTimeHours { get; set; }
        public int? AssignedQaUserId { get; set; }
        public string? AssignedQaUserName { get; set; }
        public bool IsCompleted { get; set; }
    }

    private class QaUser
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? Phone { get; set; }
    }

    private async Task RequestReview(int stageId)
    {
        await ExecuteStageAction(() => Http.PostAsync($"/api/stages/{stageId}/request-review", null));
    }

    private async Task OpenReviewModal(int stageId)
    {
        reviewStageId = stageId;
        reviewNotes = string.Empty;
        criteriaResults.Clear();
        criteriaSeverity.Clear();
        criteriaContent.Clear();
        criteriaAttachments.Clear();
        showReviewModal = true;
        await LoadReviewData(stageId);
        StateHasChanged();
    }

    private void CloseReviewModal()
    {
        showReviewModal = false;
        reviewStageId = null;
        reviewData = null;
        criteriaResults.Clear();
        criteriaSeverity.Clear();
        criteriaContent.Clear();
        criteriaAttachments.Clear();
        reviewNotes = string.Empty;
        StateHasChanged();
    }

    private async Task LoadReviewData(int stageId)
    {
        try
        {
            // Clear existing data first
            criteriaResults.Clear();
            criteriaSeverity.Clear();
            criteriaContent.Clear();
            criteriaAttachments.Clear();
            
            var response = await Http.GetAsync($"/api/stages/{stageId}/review");
            if (response.IsSuccessStatusCode)
            {
                reviewData = await response.Content.ReadFromJsonAsync<ReviewData>();
                if (reviewData?.Criteria != null)
                {
                    foreach (var criteria in reviewData.Criteria)
                    {
                        if (criteria.Result != null)
                        {
                            criteriaResults[criteria.Id] = criteria.Result.IsPassed;
                            criteriaSeverity[criteria.Id] = criteria.Result.Severity;
                            criteriaContent[criteria.Id] = criteria.Result.Content;
                            
                            // Load attachments from API
                            if (criteria.Result.Attachments != null && criteria.Result.Attachments.Any())
                            {
                                criteriaAttachments[criteria.Id] = criteria.Result.Attachments
                                    .Select(url => new AttachmentInfo 
                                    { 
                                        Url = url, 
                                        FileName = Path.GetFileName(url),
                                        IsImage = url.ToLower().EndsWith(".jpg") || url.ToLower().EndsWith(".jpeg") || 
                                                  url.ToLower().EndsWith(".png") || url.ToLower().EndsWith(".gif") || 
                                                  url.ToLower().EndsWith(".webp")
                                    }).ToList();
                            }
                            else
                            {
                                criteriaAttachments[criteria.Id] = new List<AttachmentInfo>();
                            }
                        }
                        else
                        {
                            criteriaResults[criteria.Id] = null; // No default value
                            criteriaAttachments[criteria.Id] = new List<AttachmentInfo>();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải dữ liệu đánh giá: {ex.Message}";
            reviewData = null;
        }
        StateHasChanged();
    }

    private async Task HandleCriteriaFileUpload(InputFileChangeEventArgs e, int criteriaId)
    {
        try
        {
            if (!criteriaAttachments.ContainsKey(criteriaId))
            {
                criteriaAttachments[criteriaId] = new List<AttachmentInfo>();
            }

            foreach (var file in e.GetMultipleFiles())
            {
                // Create FormData to upload file
                using var content = new MultipartFormDataContent();
                var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
                var streamContent = new StreamContent(stream);
                content.Add(streamContent, "file", file.Name);

                var response = await Http.PostAsync("/api/stages/upload-attachment", content);
                
                // Dispose stream after upload
                streamContent.Dispose();
                stream.Dispose();
                
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<UploadResult>();
                    if (result != null && !string.IsNullOrEmpty(result.url))
                    {
                        var isImage = file.ContentType.StartsWith("image/") || 
                                     file.Name.ToLower().EndsWith(".jpg") || 
                                     file.Name.ToLower().EndsWith(".jpeg") || 
                                     file.Name.ToLower().EndsWith(".png") || 
                                     file.Name.ToLower().EndsWith(".gif") || 
                                     file.Name.ToLower().EndsWith(".webp");
                        criteriaAttachments[criteriaId].Add(new AttachmentInfo
                        {
                            Url = result.url,
                            FileName = result.fileName ?? file.Name,
                            IsImage = isImage
                        });
                    }
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    errorMessage = $"Lỗi khi upload file {file.Name}: {error}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi upload file: {ex.Message}";
        }
        StateHasChanged();
    }


    private bool CanSubmitReview()
    {
        if (reviewData?.Criteria == null) return false;
        
        // Check if all criteria have been selected (not null)
        var allSelected = reviewData.Criteria.All(c => 
            criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id].HasValue);
        
        if (!allSelected) return false;
        
        // Check if failed criteria have severity and content
        foreach (var criteria in reviewData.Criteria)
        {
            if (criteriaResults.ContainsKey(criteria.Id) && criteriaResults[criteria.Id] == false)
            {
                if (string.IsNullOrWhiteSpace(criteriaSeverity.GetValueOrDefault(criteria.Id)))
                    return false;
                if (string.IsNullOrWhiteSpace(criteriaContent.GetValueOrDefault(criteria.Id)))
                    return false;
            }
        }
        
        return true;
    }

    private async Task SubmitReview()
    {
        if (reviewStageId == null || reviewData == null) return;
        
        // Validate that all criteria have been selected
        var allSelected = reviewData.Criteria?.All(c => criteriaResults.ContainsKey(c.Id) && criteriaResults[c.Id].HasValue) ?? false;
        if (!allSelected)
        {
            errorMessage = "Vui lòng đánh giá tất cả các tiêu chí";
            StateHasChanged();
            return;
        }

        // Validate that failed criteria have severity and content
        foreach (var criteria in reviewData.Criteria ?? Enumerable.Empty<CriteriaInfo>())
        {
            if (criteriaResults.ContainsKey(criteria.Id) && criteriaResults[criteria.Id] == false)
            {
                if (string.IsNullOrWhiteSpace(criteriaSeverity.GetValueOrDefault(criteria.Id)))
                {
                    errorMessage = $"Vui lòng chọn mức độ nghiêm trọng cho tiêu chí: {criteria.Name}";
                    StateHasChanged();
                    return;
                }
                if (string.IsNullOrWhiteSpace(criteriaContent.GetValueOrDefault(criteria.Id)))
                {
                    errorMessage = $"Vui lòng nhập nội dung cho tiêu chí: {criteria.Name}";
                    StateHasChanged();
                    return;
                }
            }
        }
        
        var criteriaResultsDto = reviewData.Criteria.Select(c => new AGDPMS.Shared.Models.DTOs.StageReviewCriteriaResultDto
        {
            CriteriaId = c.Id,
            IsPassed = criteriaResults.ContainsKey(c.Id) ? criteriaResults[c.Id] : null,
            Value = null,
            Notes = null,
            Severity = criteriaSeverity.GetValueOrDefault(c.Id),
            Content = criteriaContent.GetValueOrDefault(c.Id),
            Attachments = criteriaAttachments.GetValueOrDefault(c.Id)?.Select(a => a.Url).ToList()
        }).ToList();

        var dto = new AGDPMS.Shared.Models.DTOs.SubmitStageReviewDto
        {
            Notes = reviewNotes,
            CriteriaResults = criteriaResultsDto
        };

        await ExecuteStageAction(() => Http.PostAsJsonAsync($"/api/stages/{reviewStageId.Value}/submit-review", dto));
        if (string.IsNullOrWhiteSpace(errorMessage))
        {
            CloseReviewModal();
            await Load(); // Reload to refresh stages
            // Reload review status for all stages to update buttons
            if (model?.stages != null)
            {
                foreach (var stage in model.stages)
                {
                    await CheckReviewStatus(stage.Id);
                }
            }
            StateHasChanged();
        }
    }

    private async Task ViewReview(int stageId)
    {
        System.Diagnostics.Debug.WriteLine($"ViewReview called for stage {stageId}");
        viewReviewStageId = stageId;
        showViewReviewModal = true;
        await LoadViewReviewData(stageId);
        StateHasChanged();
    }

    private void CloseViewReviewModal()
    {
        showViewReviewModal = false;
        viewReviewStageId = null;
        viewReviewData = null;
        StateHasChanged();
    }

    private async Task LoadViewReviewData(int stageId)
    {
        try
        {
            var response = await Http.GetAsync($"/api/stages/{stageId}/latest-review");
            if (response.IsSuccessStatusCode)
            {
                var jsonContent = await response.Content.ReadAsStringAsync();
                System.Diagnostics.Debug.WriteLine($"API Response for stage {stageId}: {jsonContent}");
                
                viewReviewData = await response.Content.ReadFromJsonAsync<ReviewData>();
                
                // Debug: Log attachments data
                if (viewReviewData?.Criteria != null)
                {
                    foreach (var criteria in viewReviewData.Criteria)
                    {
                        if (criteria.Result != null)
                        {
                            var attCount = criteria.Result.Attachments?.Count ?? 0;
                            var attIsNull = criteria.Result.Attachments == null;
                            System.Diagnostics.Debug.WriteLine($"Criteria {criteria.Id} ({criteria.Name}): IsPassed={criteria.Result.IsPassed}, Attachments null={attIsNull}, Count={attCount}");
                            if (criteria.Result.Attachments != null && criteria.Result.Attachments.Any())
                            {
                                foreach (var att in criteria.Result.Attachments)
                                {
                                    System.Diagnostics.Debug.WriteLine($"  - Attachment: {att}");
                                }
                            }
                            else
                            {
                                System.Diagnostics.Debug.WriteLine($"  - No attachments or empty list");
                            }
                        }
                    }
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                System.Diagnostics.Debug.WriteLine($"API Error for stage {stageId}: {response.StatusCode} - {errorContent}");
                viewReviewData = null;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Exception loading review data: {ex.Message}\n{ex.StackTrace}");
            errorMessage = $"Lỗi khi tải dữ liệu đánh giá: {ex.Message}";
            viewReviewData = null;
        }
        StateHasChanged();
    }

    private bool HasPendingReview(int stageId)
    {
        return stageHasPendingReview.ContainsKey(stageId) && stageHasPendingReview[stageId];
    }

    private bool HasLatestReview(int stageId)
    {
        return stageHasLatestReview.ContainsKey(stageId) && stageHasLatestReview[stageId];
    }

    private int? currentUserId;

    private async Task LoadCurrentUserId()
    {
        if (!currentUserId.HasValue)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out var userId))
            {
                currentUserId = userId;
            }
        }
    }

    private bool IsAssignedQa(StageDto stage)
    {
        if (!IsQa() || !currentUserId.HasValue) return false;
        return stage.AssignedQaUserId == currentUserId.Value;
    }

    private class ReviewData
    {
        public ReviewInfo? Review { get; set; }
        public List<CriteriaInfo>? Criteria { get; set; }
    }

    private class ReviewInfo
    {
        public int Id { get; set; }
        public int ProductionItemStageId { get; set; }
        public int RequestedByUserId { get; set; }
        public int? ReviewedByUserId { get; set; }
        public string Status { get; set; } = string.Empty;
        public string? Notes { get; set; }
        public DateTime? RequestedAt { get; set; }
        public DateTime? ReviewedAt { get; set; }
    }

    private class CriteriaInfo
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string CheckType { get; set; } = "boolean";
        public bool Required { get; set; }
        public int OrderIndex { get; set; }
        public CriteriaResult? Result { get; set; }
    }

    private class CriteriaResult
    {
        public bool? IsPassed { get; set; }
        public string? Value { get; set; }
        public string? Notes { get; set; }
        public string? Severity { get; set; }
        public string? Content { get; set; }
        public List<string>? Attachments { get; set; }
    }

    private class AttachmentInfo
    {
        public string Url { get; set; } = string.Empty;
        public string FileName { get; set; } = string.Empty;
        public bool IsImage { get; set; }
    }

    private class UploadResult
    {
        public string? url { get; set; }
        public string? fileName { get; set; }
    }

    private string? imageModalUrl;
    private bool showImageModal = false;
    private bool isImageInModal = true;

    private void OpenMediaModal(string mediaUrl, bool isImage)
    {
        imageModalUrl = mediaUrl;
        isImageInModal = isImage;
        showImageModal = true;
        StateHasChanged();
    }

    private void CloseImageModal()
    {
        showImageModal = false;
        imageModalUrl = null;
        isImageInModal = true;
        StateHasChanged();
    }
}