@page "/projects/{ProjectId:int}"
@implements IDisposable

@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Services
@using System.ComponentModel.DataAnnotations

@inject WStarService WStarService
@inject IProductService ProductService

<div class="mb-3">
    <a href="/projects" class="text-decoration-none d-inline-flex align-items-center text-primary">
        <i class="bi bi-arrow-left me-2 fs-5"></i>
        <span class="fw-semibold">Quay lại</span>
    </a>
</div>
<ul class="nav nav-tabs" id="dtlTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active"
                id="tab-cavity"
                data-bs-toggle="tab"
                data-bs-target="#pane-cavity"
                type="button"
                role="tab"
                aria-controls="pane-cavity"
                aria-selected="true">
            Thông tin cửa
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="tab-materials"
                data-bs-toggle="tab"
                data-bs-target="#pane-materials"
                type="button"
                role="tab"
                aria-controls="pane-materials"
                aria-selected="false">
            Tổng hợp vật liệu
        </button>
    </li>
</ul>
<div class="tab-content" id="dtlTabsContent">
    <div class="tab-pane fade show active" id="pane-cavity" role="tabpanel" aria-labelledby="tab-cavity">
        <div class="mt-3">
            <StatusMessageAlert Message="@StatusMessage" AdditionalClasses="mb-2" />
            <div class="mb-3 d-flex align-items-center">
                <div class="input-group w-auto me-2">
                    <label class="input-group-text fw-semibold">Nhập thiết kế Wstar</label>
                    <InputFile OnChange="OnInputFileChange" accept=".mdb" class="form-control" />
                    @if (UploadedFilePath is not null)
                    {
                        <button type="button" @onclick="LoadWStarProjects" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projModal">
                            Chọn dự án
                        </button>
                    }
                </div>
                <button type="button" class="btn btn-primary">Báo giá</button>
            </div>
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Mã cửa</th>
                        <th>Mô tả</th>
                        <th>Rộng</th>
                        <th>Cao</th>
                        <th>Số lượng</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Cavities.Any())
                    {
                        @foreach (var cav in Cavities)
                        {
                            <tr>
                                <td>@cav.Code</td>
                                <td>@cav.Description</td>
                                <td>@cav.Width</td>
                                <td>@cav.Height</td>
                                <td>@cav.Quantity bộ</td>
                                <td>
                                    <a href="/cavities/@cav.Id" class="btn btn-primary">Chi tiết</a>
                                    <button @onclick="() => CavityToDelete = cav" type="button" class="btn btn-danger"
                                            data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                                        Xóa cửa
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="tab-pane fade" id="pane-materials" role="tabpanel" aria-labelledby="tab-materials">
        <div class="mt-3">
            <StatusMessageAlert Message="@StatusMessage" AdditionalClasses="mb-2" />
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingProfile">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProfile"
                            aria-expanded="true" aria-controls="collapseProfile">
                        Profile
                    </button>
                </h2>
                <div id="collapseProfile" class="accordion-collapse collapse show" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Mã profile</th>
                                    <th>Tên profile</th>
                                    <th>Chiều dài cây (mm)</th>
                                    <th>Số cây dùng</th>
                                    <th>Số cây tồn</th>
                                    <th>Cần thêm</th>
                                    <th>Trọng lượng (kg)</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var profile in Profiles)
                                {
                                    var barGroups = profile.BarsUsedByStockLength.Keys.ToList();
                                    var rowSpan = barGroups.Count;
                                    for (var i = 0; i < rowSpan; i++)
                                    {
                                        var stockLength = barGroups[i];
                                        profile.BarsUsedByStockLength.TryGetValue(stockLength, out var used);
                                        profile.BarsInStockByStockLength.TryGetValue(stockLength, out var stock);
                                        profile.BarsNeedByStockLength.TryGetValue(stockLength, out var need);
                                        profile.UnitPriceByStockLength.TryGetValue(stockLength, out var price);
                                        <tr>
                                            @if (i == 0)
                                            {
                                                <td rowspan="@rowSpan">@profile.Code</td>
                                                <td rowspan="@rowSpan">@profile.Name</td>
                                            }
                                            <td>@stockLength</td>
                                            <td>@used</td>
                                            <td>@stock</td>
                                            <td>@need</td>
                                            @if (i == 0)
                                            {
                                                <td rowspan="@rowSpan">@profile.TotalWeight.ToString("N2")</td>
                                                <td rowspan="@rowSpan">@price.ToString("C")</td>
                                                <td rowspan="@rowSpan">@profile.TotalPrice.ToString("C")</td>
                                                <td rowspan="@rowSpan">
                                                    <button @onclick="() => ShowCuts(profile)" type="button"
                                                            class="btn btn-sm btn-outline-primary me-1"
                                                            data-bs-toggle="modal" data-bs-target="#profileCutsModal">
                                                        Kích thước cắt
                                                    </button>
                                                    <button @onclick="() => ShowSolutions(profile)" type="button"
                                                            class="btn btn-sm btn-outline-success"
                                                            data-bs-toggle="modal" data-bs-target="#profileCutSolutionsModal">
                                                        Tối ưu cắt
                                                    </button>
                                                </td>
                                            }
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<SelectWStarCavitiesModal @ref="SelectModal" ModalId="projModal" Projects="WStarProjects" OnConfirm="AddSelectedCavities" />
<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa cửa <strong>@CavityToDelete?.Code</strong> không?<br />
                Hành động này không thể hoàn tác.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteAsync" data-bs-dismiss="modal">Xóa</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="profileCutsModal" tabindex="-1" aria-labelledby="profileCutsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Kích thước cắt - @SelectedProfile?.Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CloseModals"></button>
            </div>
            <div class="modal-body">
                @if (SelectedCuts is not null)
                {
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Chiều dài (mm)</th>
                                <th>Số lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cut in SelectedCuts)
                            {
                                <tr>
                                    <td>@cut.CutLength</td>
                                    <td>@cut.Quantity</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">Không có dữ liệu.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModals">Đóng</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="profileCutSolutionsModal" tabindex="-1" aria-labelledby="profileCutSolutionsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Tối ưu cắt - @SelectedProfile?.Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CloseModals"></button>
            </div>
            <div class="modal-body">
                @if (SelectedSolutions is not null)
                {
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Chiều dài cây (mm)</th>
                                <th>Số cây</th>
                                <th>Giải pháp</th>
                                <th>Đoạn thừa (mm)</th>
                                <th>Hiệu suất (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sol in SelectedSolutions)
                            {
                                <tr>
                                    <td>@sol.StockLength</td>
                                    <td>@sol.Quantity</td>
                                    <td>
                                        @foreach (var p in sol.Pattern)
                                        {
                                            <span class="badge bg-light text-dark border me-1">
                                                @p.CutLength × @p.Quantity
                                            </span>
                                        }
                                    </td>
                                    <td>@sol.Waste</td>
                                    <td>@sol.Efficiency</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">Không có dữ liệu.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModals">Đóng</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int ProjectId { get; set; }

    [SupplyParameterFromForm]
    private SummarizeAluminumModel Input { get; set; } = new();

    private StatusMessage? StatusMessage { get; set; }
    private string? UploadedFilePath;
    private IEnumerable<WStarProject> WStarProjects = [];
    private IEnumerable<Cavity> Cavities = [];
    // private IEnumerable<AluminumSummary> Aluminums = [];
    private IEnumerable<CavityProfileSummary> Profiles = [];
    private CavityProfileSummary? SelectedProfile;
    private List<CavityProfileSummary.ProfileCut>? SelectedCuts;
    private List<CavityProfileSummary.CutSolution>? SelectedSolutions;

    private SelectWStarCavitiesModal? SelectModal;
    private Cavity? CavityToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectCavities();
    }

    private async Task LoadProjectCavities()
    {
        var result = await ProductService.GetProjectCavitiesAsync(ProjectId);
        if (result.Success)
        {
            Cavities = result.Cavities;
            await LoadProfileSummaries();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task LoadProfileSummaries()
    {
        var result = await ProductService.GetCavityProfileSummariesAsync(ProjectId);
        if (result.Success) Profiles = result.Summaries;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null || !file.Name.EndsWith(".mdb", StringComparison.OrdinalIgnoreCase))
        {
            UploadedFilePath = null;
            StatusMessage = StatusMessage.Error("File không tồn tại hoặc không đúng định dạng");
            return;
        }
        var tempFile = Path.Combine(Path.GetTempPath(), file.Name);
        using var stream = File.Create(tempFile);
        await file.OpenReadStream(200 * 1024 * 1024).CopyToAsync(stream);
        UploadedFilePath = tempFile;
    }

    private async Task LoadWStarProjects()
    {
        if (SelectModal is not null) SelectModal.SetLoading(true);
        var result = await WStarService.GetAllProjectAsync(UploadedFilePath);
        if (result.Success) WStarProjects = result.Projects;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
        if (SelectModal is not null) SelectModal.SetLoading(false);
    }

    private async Task AddSelectedCavities(IEnumerable<WStarCavity> selectedCavities)
    {
        var result = await ProductService.AddCavitiesFromWStarDesignAsync(ProjectId, selectedCavities);
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success("Thêm cửa thành công");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task ConfirmDeleteAsync()
    {
        if (CavityToDelete is null) return;
        var result = await ProductService.DeleteCavityAsync(CavityToDelete.Id);
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success($"Đã xóa cửa {CavityToDelete.Code}");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
        CavityToDelete = null;
    }

    private void ShowCuts(CavityProfileSummary profile)
    {
        SelectedProfile = profile;
        SelectedCuts = profile.Cuts;
        SelectedSolutions = null;
    }

    private void ShowSolutions(CavityProfileSummary profile)
    {
        SelectedProfile = profile;
        SelectedSolutions = profile.CutSolutions;
        SelectedCuts = null;
    }

    private void CloseModals()
    {
        SelectedCuts = null;
        SelectedSolutions = null;
        SelectedProfile = null;
    }

    public void Dispose()
    {
        try
        {
            if (!string.IsNullOrEmpty(UploadedFilePath) && File.Exists(UploadedFilePath))
            {
                File.Delete(UploadedFilePath);
                UploadedFilePath = null;
            }
        }
        catch {}
    }

    private sealed class SummarizeAluminumModel
    {
        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Độ dài lõi thép phải lớn hơn 0")]
        public int StockLength { get; set; } = 5800;
    }
}
