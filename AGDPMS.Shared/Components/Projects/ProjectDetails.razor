@page "/projects/{ProjectId:int}"
@implements IDisposable

@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Services
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@attribute [Authorize(Roles = "Director,Technician")]

@inject WStarService WStarService
@inject IProductService ProductService
@inject AuthenticationStateProvider AuthStateProvider

<div class="mb-3">
    <a href="/projects" class="text-decoration-none d-inline-flex align-items-center text-primary">
        <i class="bi bi-arrow-left me-2 fs-5"></i>
        <span class="fw-semibold">Quay lại</span>
    </a>
</div>
<ul class="nav nav-tabs" id="dtlTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active"
                id="tab-cavity"
                data-bs-toggle="tab"
                data-bs-target="#pane-cavity"
                type="button"
                role="tab"
                aria-controls="pane-cavity"
                aria-selected="true">
            Thông tin cửa
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="tab-materials"
                data-bs-toggle="tab"
                data-bs-target="#pane-materials"
                type="button"
                role="tab"
                aria-controls="pane-materials"
                aria-selected="false">
            Tổng hợp vật liệu
        </button>
    </li>
</ul>
<div class="tab-content" id="dtlTabsContent">
    <div class="tab-pane fade show active" id="pane-cavity" role="tabpanel" aria-labelledby="tab-cavity">
        <div class="mt-3">
            <StatusMessageAlert Message="@StatusMessage" AdditionalClasses="mb-2" />
            <div class="mb-3 d-flex align-items-center">
                <div class="input-group w-auto me-2">
                    <label class="input-group-text fw-semibold">Nhập thiết kế Wstar</label>
                    <InputFile OnChange="OnInputFileChange" accept=".mdb" class="form-control" />
                    @if (!IsWStarFileLoading && !IsAddingCavitiesFromWStar && UploadedFilePath is not null)
                    {
                        <button type="button" @onclick="LoadWStarProjects" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projModal">
                            Chọn dự án
                        </button>
                    }
                </div>
                @if (IsWStarFileLoading)
                {
                    <div class="progress mx-2 w-25">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar"
                                style="width:@(WStarFileUploadProgress)%;"
                                aria-valuenow="@WStarFileUploadProgress"
                                aria-valuemin="0"
                                aria-valuemax="100">@WStarFileUploadProgress%</div>
                    </div>
                }
                @if (IsAddingCavitiesFromWStar)
                {
                    <div class="d-flex align-items-center mx-2 text-primary">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Đang thêm cửa...</span>
                    </div>
                }
            </div>
            <DataTable TItem="Cavity" TEdit="UpdateCavityModel" Items="Cavities" SearchBy="@(c => c.Description)"
                       EnableEditing="true"
                       EditModelFactory="@(c => new UpdateCavityModel { Code = c.Code, Description = c.Description, Location = c.Location })"
                       OnItemSaved="SaveCavityChange">
                <DataTemplate>
                    <Column Header="Mã cửa">
                        <CellTemplate><td>@context.Code</td></CellTemplate>
                        <EditTemplate>
                            <td>
                                <InputText class="form-control" @bind-Value="context.Code" />
                                <ValidationMessage For="() => context.Code" />
                            </td>
                        </EditTemplate>
                    </Column>
                    <Column Header="Mô tả">
                        <CellTemplate><td>@context.Description</td></CellTemplate>
                        <EditTemplate>
                            <td>
                                <InputText class="form-control" @bind-Value="context.Description" />
                                <ValidationMessage For="() => context.Description" />
                            </td>
                        </EditTemplate>
                    </Column>
                    <Column Header="Vị trí">
                        <CellTemplate><td>@context.Location</td></CellTemplate>
                        <EditTemplate>
                            <td>
                                <InputText class="form-control" @bind-Value="context.Location" />
                                <ValidationMessage For="() => context.Location" />
                            </td>
                        </EditTemplate>
                    </Column>
                    <Column Header="Rộng x Cao (mm)">
                        <CellTemplate><td>@context.Width x @context.Height</td></CellTemplate>
                    </Column>
                    <Column Header="Kiểu cách">
                        <CellTemplate><td>@context.WindowType</td></CellTemplate>
                    </Column>
                    <Column Header="Số lượng">
                        <CellTemplate><td>@context.Quantity bộ</td></CellTemplate>
                    </Column>
                </DataTemplate>
                <ActionTemplate>
                    <a href="/cavities/@context.Id" class="btn btn-primary">Chi tiết</a>
                    <button @onclick="() => CavityToDelete = context" type="button" class="btn btn-danger"
                            data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                        Xóa cửa
                    </button>
                </ActionTemplate>
            </DataTable>
        </div>
    </div>
    <div class="tab-pane fade" id="pane-materials" role="tabpanel" aria-labelledby="tab-materials">
        <div class="mt-3">
            <StatusMessageAlert Message="@StatusMessage" AdditionalClasses="mb-2" />
            <div class="mb-3 d-flex align-items-center">
                <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#materialRequestModal">Tạo yêu cầu nhập vật tư</button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#quotationModal">Báo giá</button>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingProfile">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProfile"
                            aria-expanded="true" aria-controls="collapseProfile">
                        Profile
                    </button>
                </h2>
                <div id="collapseProfile" class="accordion-collapse collapse show" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <div class="mb-3 d-flex align-items-center">
                            <EditForm Model="Input" OnValidSubmit="LoadProfileSummaries" FormName="summarize-profile-form">
                                <DataAnnotationsValidator />
                                <div class="input-group w-auto me-2">
                                    <label class="input-group-text fw-semibold">Chiều dài cây (mm)</label>
                                    <InputNumber @bind-Value="Input.StockLength" class="form-control" />
                                    <button type="submit" class="btn btn-primary" disabled="@IsLoadingProfileSummaries">Tổng hợp nhôm</button>
                                </div>
                            </EditForm>
                            @if (IsLoadingProfileSummaries)
                            {
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            }
                            <button type="button" class="btn btn-success" disabled="@(!Profiles.Any())">Xuất Excel</button>
                        </div>
                        <div class="fixed-table-wrapper">
                            <table class="table table-bordered table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã profile</th>
                                        <th>Tên profile</th>
                                        <th>Chiều dài cây (mm)</th>
                                        <th>Số cây dùng</th>
                                        <th>Số cây tồn</th>
                                        <th>Cần thêm</th>
                                        <th>Tỷ trọng (kg/m)</th>
                                        <th>Tổng trọng lượng (kg)</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var profile in Profiles)
                                    {
                                        var rows = profile.StockUsages;
                                        var rowSpan = rows.Count;
                                        for (var i = 0; i < rowSpan; i++)
                                        {
                                            var row = rows[i];
                                            <tr>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">@profile.Id</td>
                                                    <td rowspan="@rowSpan">@profile.Name</td>
                                                }
                                                <td>@row.StockLength</td>
                                                <td>@row.Used</td>
                                                <td>@row.InStock</td>
                                                <td>@row.Need</td>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">
                                                        @if (EditingWeightProfileCode == profile.Id)
                                                        {
                                                            <InputNumber @bind-Value="profile.Weight"
                                                                         step="0.001"
                                                                         @onblur="() => HandleMaterialWeightChange(profile.Id, profile.Weight)"
                                                                         class="form-control" />
                                                        }
                                                        else
                                                        {
                                                            <span @onclick="() => EditingWeightProfileCode = profile.Id">
                                                                @profile.Weight.ToString("N2")
                                                            </span>
                                                        }
                                                    </td>
                                                    <td rowspan="@rowSpan">@profile.TotalWeight.ToString("N2")</td>
                                                }
                                                <td>
                                                    @if (EditingProfileStockPriceRow == (profile.Id, row.StockLength))
                                                    {
                                                        <div class="input-group">
                                                            <InputNumber @bind-Value="EditingProfileStockPrice"
                                                                         @onblur="() => HandleUpdateProfileStockPrice(row, EditingProfileStockPrice)"
                                                                         class="form-control" />
                                                            <span class="input-group-text">₫</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span @onclick="() => BeginEditProfileStockPrice(profile.Id, row.StockLength, row.UnitPrice)">
                                                            @row.UnitPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))
                                                        </span>
                                                    }
                                                </td>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">@profile.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                                    <td rowspan="@rowSpan">
                                                        <button @onclick="() => ShowCuts(profile)" type="button"
                                                                class="btn btn-sm btn-outline-primary me-1"
                                                                data-bs-toggle="modal" data-bs-target="#profileCutsModal">
                                                            KT cắt
                                                        </button>
                                                        <button @onclick="() => ShowSolutions(profile)" type="button"
                                                                class="btn btn-sm btn-outline-success"
                                                                data-bs-toggle="modal" data-bs-target="#profileCutSolutionsModal">
                                                            Tối ưu cắt
                                                        </button>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="7">Tổng cộng</td>
                                        <td>@Profiles.Sum(p => p.TotalWeight).ToString("N2") kg</td>
                                        <td></td>
                                        <td>@Profiles.Sum(p => p.TotalPrice).ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingGlass">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGlass"
                            aria-expanded="true" aria-controls="collapseGlass">
                        Kính
                    </button>
                </h2>
                <div id="collapseGlass" class="accordion-collapse collapse" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <div class="fixed-table-wrapper">
                            <table class="table table-bordered table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã kính</th>
                                        <th>Tên kính</th>
                                        <th>Kích thước</th>
                                        <th>Số tấm</th>
                                        <th>Số tấm tồn</th>
                                        <th>Cần thêm</th>
                                        <th>Tổng chu vi (m)</th>
                                        <th>Tổng diện tích (m2)</th>
                                        <th>Màu sắc</th>
                                        <th>Cửa</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var glass in Glasses)
                                    {
                                        var rowSpan = glass.Cuts.Count;
                                        for (var i = 0; i < rowSpan; i++)
                                        {
                                            var cut = glass.Cuts[i];
                                            <tr>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan" class="align-top">@glass.Id</td>
                                                    <td rowspan="@rowSpan" class="align-top">@glass.Name</td>
                                                }
                                                <td>@cut.Width x @cut.Length</td>
                                                <td>@cut.Quantity</td>
                                                <td>@cut.Stock</td>
                                                <td>@cut.Need</td>
                                                <td>@((cut.TotalPerimeter / 1000).ToString("N3"))</td>
                                                <td>@((cut.TotalSize / 1_000_000).ToString("N3"))</td>
                                                <td>@cut.Color</td>
                                                <td>@string.Join(",", cut.CavityCodes)</td>
                                                <td>
                                                    @if (EditingGlassStockPriceRow == (glass.Id, cut.Width, cut.Length))
                                                    {
                                                        <div class="input-group">
                                                            <InputNumber @bind-Value="EditingGlassStockPrice"
                                                                         @onblur="() => HandleUpdateGlassStockPrice(cut, EditingGlassStockPrice)"
                                                                         class="form-control" />
                                                            <span class="input-group-text">₫</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span @onclick="() => BeginEditGlassStockPrice(glass.Id, cut.Width, cut.Length, cut.UnitPrice)">
                                                            @cut.UnitPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))
                                                        </span>
                                                    }
                                                </td>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan" class="align-top">@glass.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                                    <td></td>
                                                }
                                            </tr>
                                        }
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="6">Tổng cộng</td>
                                        <td>@((Glasses.Sum(g => g.TotalPerimeter) / 1000).ToString("N3"))</td>
                                        <td>@((Glasses.Sum(g => g.TotalSize) / 1_000_000).ToString("N3"))</td>
                                        <td colspan="3"></td>
                                        <td>@Glasses.Sum(p => p.TotalPrice).ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingGasket">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGasket"
                            aria-expanded="true" aria-controls="collapseGasket">
                        Vật tư khác
                    </button>
                </h2>
                <div id="collapseGasket" class="accordion-collapse collapse" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <div class="fixed-table-wrapper">
                            <table class="table table-bordered table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã vật liệu</th>
                                        <th>Tên vật liệu</th>
                                        <th>Kích thước</th>
                                        <th>Số lượng</th>
                                        <th>Đơn vị</th>
                                        <th>Tồn</th>
                                        <th>Cần thêm</th>
                                        <th>Màu sắc</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var mat in OtherMaterials)
                                    {
                                        <tr>
                                            <td>@mat.Id</td>
                                            <td>@mat.Name</td>
                                            <td>@mat.GasketLength</td>
                                            <td>@mat.Quantity</td>
                                            <td>@mat.Unit</td>
                                            <td>@(mat.GasketLength is null ? mat.Stock.Stock : mat.Stock.Length)</td>
                                            <td>@(mat.GasketLength is null ? mat.Need : mat.NeedGasketLength)</td>
                                            <td>@mat.Color</td>
                                            <td>
                                                @if (EditingOtherMaterialStockPriceRow == mat.Id)
                                                {
                                                    <div class="input-group">
                                                        <InputNumber @bind-Value="EditingGlassStockPrice"
                                                                     @onblur="() => HandleUpdateOtherMaterialStockPrice(mat, EditingGlassStockPrice)"
                                                                     class="form-control" />
                                                        <span class="input-group-text">₫</span>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span @onclick="() => BeginEditOtherMaterialStockPrice(mat.Id, mat.UnitPrice)">
                                                        @mat.UnitPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))
                                                    </span>
                                                }
                                            </td>
                                            <td>@mat.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                            <td></td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="9">Tổng cộng</td>
                                        <td>@OtherMaterials.Sum(p => p.TotalPrice).ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<SelectWStarCavitiesModal @ref="SelectModal" ModalId="projModal" Projects="WStarProjects" OnConfirm="AddSelectedCavities" />
<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa cửa <strong>@CavityToDelete?.Code</strong> không?<br />
                Hành động này không thể hoàn tác.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteAsync" data-bs-dismiss="modal">Xóa</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="profileCutsModal" tabindex="-1" aria-labelledby="profileCutsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Kích thước cắt - @SelectedProfile?.Id</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CloseModals"></button>
            </div>
            <div class="modal-body">
                @if (SelectedCuts is not null)
                {
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Chiều dài (mm)</th>
                                <th>Số lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cut in SelectedCuts)
                            {
                                <tr>
                                    <td>@cut.CutLength</td>
                                    <td>@cut.Quantity</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">Không có dữ liệu.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModals">Đóng</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="profileCutSolutionsModal" tabindex="-1" aria-labelledby="profileCutSolutionsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Tối ưu cắt - @SelectedProfile?.Id</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CloseModals"></button>
            </div>
            <div class="modal-body">
                @if (SelectedSolutions is not null)
                {
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Chiều dài cây (mm)</th>
                                <th>Số cây</th>
                                <th>Giải pháp</th>
                                <th>Đoạn thừa (mm)</th>
                                <th>Hiệu suất (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sol in SelectedSolutions)
                            {
                                <tr>
                                    <td>@sol.StockLength</td>
                                    <td>@sol.Quantity</td>
                                    <td>
                                        @foreach (var p in sol.Pattern)
                                        {
                                            <span class="badge bg-light text-dark border me-1">
                                                @p.CutLength × @p.Quantity
                                            </span>
                                        }
                                    </td>
                                    <td>@sol.Waste</td>
                                    <td>@sol.Efficiency</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">Không có dữ liệu.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModals">Đóng</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="materialRequestModal" tabindex="-1" aria-labelledby="materialRequestModal" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="missingMaterialsLabel">Danh sách vật tư thiếu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <h5 class="mt-3">Profile</h5>
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Mã</th>
                            <th>Tên vật tư</th>
                            <th>Số lượng thiếu</th>
                            <th>Chiều dài yêu cầu (mm)</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in Profiles)
                        {
                            foreach (var (su, i) in p.StockUsages.Select((v, i) => (v, i)))
                            {
                                <tr>
                                    @if (i == 0)
                                    {
                                        <td rowspan="@p.StockUsages.Count">@p.Id</td>
                                        <td rowspan="@p.StockUsages.Count">@p.Name</td>
                                    }
                                    <td>@su.Need</td>
                                    <td>@su.StockLength</td>
                                    <td></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                <h5 class="mt-4">Kính</h5>
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Mã</th>
                            <th>Tên kính</th>
                            <th>Kích thước</th>
                            <th>Số lượng</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var g in Glasses)
                        {
                            for (var i = 0; i < g.Cuts.Count; i++)
                            {
                                <tr>
                                    <td>@g.Id</td>
                                    <td>@g.Name</td>
                                    <td>@g.Cuts[i].Width x @g.Cuts[i].Length</td>
                                    <td>@g.Cuts[i].Quantity</td>
                                    <td></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                <h5 class="mt-4">Vật tư khác</h5>
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Id</th>
                            <th>Tên vật tư</th>
                            <th>Số lượng thiếu</th>
                            <th>Đơn vị</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in OtherMaterials)
                        {
                            <tr>
                                <td>@m.Id</td>
                                <td>@m.Name</td>
                                <td>@(m.GasketLength is null ? m.Need : m.NeedGasketLength)</td>
                                <td>@m.Unit</td>
                                <td></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" @onclick="HandleSendMaterialRequest" class="btn btn-primary" data-bs-dismiss="modal">Gửi</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="quotationModal" tabindex="-1" aria-labelledby="quotationModal" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quotationModalLabel">Tạo báo giá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                @if (Quotation is not null)
                {
                   <table class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Ký hiệu</th>
                                <th>Nội dung</th>
                                <th>Rộng x Cao (mm)</th>
                                <th>Số lượng</th>
                                <th>Khối lượng (kg)</th>
                                <th>Đơn giá (VND)</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Quotation.Details)
                            {
                                <tr>
                                    <td>@item.Code</td>
                                    <td>@item.Description</td>
                                    <td>@item.Width x @item.Height</td>
                                    <td>@item.Quantity</td>
                                    <td>@((item.Weight * item.Quantity).ToString("N3"))</td>
                                    <td>@item.UnitPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                    <td>@item.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td colspan="4"></td>
                                <td>@Quotation.TotalWeight.ToString("N3")</td>
                                <td></td>
                                <td>@Quotation.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                            </tr>
                        </tfoot>
                   </table>
                }
                else
                {
                    <div class="mb-3">
                        <label class="form-label">Phí nhân công/cửa</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="LaborCost" />
                            <span class="input-group-text">VND</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">% lợi nhuận/cửa</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="ProfitPercentage" />
                            <span class="input-group-text">VND</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">% thuế/cửa</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="TaxPercentage" />
                            <span class="input-group-text">VND</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phí vận chuyển/cửa</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="TransportCost" />
                            <span class="input-group-text">VND</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dự trù</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="Contingency" />
                            <span class="input-group-text">VND</span>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                @if (Quotation is not null)
                {
                    <button type="button" @onclick="() => Quotation = null" class="btn btn-primary">Xóa</button>
                    <button type="button" class="btn btn-success">Xuất Excel</button>
                }
                else
                {
                    <button type="button" @onclick="HandleCalculateQuotation" class="btn btn-primary">Tính báo giá</button>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int ProjectId { get; set; }

    [SupplyParameterFromForm]
    private SummarizeAluminumModel Input { get; set; } = new();

    private StatusMessage? StatusMessage { get; set; }
    private string? UploadedFilePath;
    private IEnumerable<WStarProject> WStarProjects = [];
    private IEnumerable<Cavity> Cavities = [];
    private IEnumerable<CavityProfileSummary> Profiles = [];
    private IEnumerable<CavityGlassSummary> Glasses = [];
    private IEnumerable<CavityOtherMaterialSummary> OtherMaterials = [];
    private CavityProfileSummary? SelectedProfile;
    private List<CavityProfileSummary.ProfileCut>? SelectedCuts;
    private List<CavityProfileSummary.CutSolution>? SelectedSolutions;

    private SelectWStarCavitiesModal? SelectModal;
    private Cavity? CavityToDelete;

    private bool IsWStarFileLoading { get; set; } = false;
    private int WStarFileUploadProgress { get; set; } = 0;
    private bool IsAddingCavitiesFromWStar { get; set; } = false;
    private bool IsLoadingProfileSummaries { get; set; } = false;

    private string? EditingWeightProfileCode { get; set; }
    private (string ProfileId, double StockLength)? EditingProfileStockPriceRow { get; set; }
    private decimal EditingProfileStockPrice { get; set; }

    private (string GlassId, double StockWidth, double StockLength)? EditingGlassStockPriceRow { get; set; }
    private decimal EditingGlassStockPrice { get; set; }

    private string? EditingOtherMaterialStockPriceRow { get; set; }
    private decimal EditingOtherMaterialStockPrice { get; set; }

    private decimal LaborCost { get; set; }
    private decimal ProfitPercentage { get; set; }
    private decimal TaxPercentage { get; set; }
    private decimal TransportCost { get; set; }
    private decimal Contingency { get; set; }

    private Quotation? Quotation { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectCavities();
    }

    private async Task LoadProjectCavities()
    {
        var result = await ProductService.GetProjectCavitiesAsync(ProjectId);
        if (result.Success)
        {
            Cavities = result.Cavities;
            // await LoadProfileSummaries();
            await LoadGlassAndOtherMaterialSummaries();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task LoadProfileSummaries()
    {
        IsLoadingProfileSummaries = true;
        var result = await ProductService.GetCavityProfileSummariesAsync(ProjectId, Input.StockLength);
        IsLoadingProfileSummaries = false;
        if (result.Success) Profiles = result.Summaries;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task LoadGlassAndOtherMaterialSummaries()
    {
        var result = await ProductService.GetCavityGlassAndOtherMaterialSummariesAsync(ProjectId);
        if (result.Success)
        {
            Glasses = result.Glasses;
            OtherMaterials = result.Others;
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        IsWStarFileLoading = true;
        WStarFileUploadProgress = 0;
        var file = e.File;
        if (file is null || !file.Name.EndsWith(".mdb", StringComparison.OrdinalIgnoreCase))
        {
            UploadedFilePath = null;
            StatusMessage = StatusMessage.Error("File không tồn tại hoặc không đúng định dạng");
            IsWStarFileLoading = false;
            return;
        }
        var tempFile = Path.Combine(Path.GetTempPath(), file.Name);
        await using var input = file.OpenReadStream(1024L * 1024 * 1024);
        await using var output = File.Create(tempFile);
        var buffer = new byte[81920];
        long totalRead = 0;
        int read;
        while ((read = await input.ReadAsync(buffer)) > 0)
        {
            await output.WriteAsync(buffer.AsMemory(0, read));
            totalRead += read;
            WStarFileUploadProgress = (int)(totalRead * 100 / file.Size);
            await InvokeAsync(StateHasChanged);
        }
        UploadedFilePath = tempFile;
        IsWStarFileLoading = false;
    }

    private async Task LoadWStarProjects()
    {
        if (SelectModal is not null) SelectModal.SetLoading(true);
        var result = await WStarService.GetAllProjectAsync(UploadedFilePath);
        if (result.Success) WStarProjects = result.Projects;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
        if (SelectModal is not null) SelectModal.SetLoading(false);
    }

    private async Task AddSelectedCavities(IEnumerable<WStarCavity> selectedCavities)
    {
        IsAddingCavitiesFromWStar = true;
        var result = await ProductService.AddCavitiesFromWStarDesignAsync(ProjectId, selectedCavities);
        IsAddingCavitiesFromWStar = false;
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success("Thêm cửa thành công");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task ConfirmDeleteAsync()
    {
        if (CavityToDelete is null) return;
        var result = await ProductService.DeleteCavityAsync(CavityToDelete.Id);
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success($"Đã xóa cửa {CavityToDelete.Code}");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
        CavityToDelete = null;
    }

    private void ShowCuts(CavityProfileSummary profile)
    {
        SelectedProfile = profile;
        SelectedCuts = profile.Cuts;
        SelectedSolutions = null;
    }

    private void ShowSolutions(CavityProfileSummary profile)
    {
        SelectedProfile = profile;
        SelectedSolutions = profile.CutSolutions;
        SelectedCuts = null;
    }

    private void CloseModals()
    {
        SelectedCuts = null;
        SelectedSolutions = null;
        SelectedProfile = null;
    }

    public void Dispose()
    {
        try
        {
            if (!string.IsNullOrEmpty(UploadedFilePath) && File.Exists(UploadedFilePath))
            {
                File.Delete(UploadedFilePath);
                UploadedFilePath = null;
            }
        }
        catch {}
    }

    private async Task SaveCavityChange(UpdateCavityModel input, Cavity cavity)
    {
        cavity.Code = input.Code;
        cavity.Description = input.Description;
        cavity.Location = input.Location;
        var result = await ProductService.UpdateCavityAsync(cavity);
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success($"Cập nhật cửa {cavity.Code} thành công");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task HandleMaterialWeightChange(string materialId, double newWeight)
    {
        var result = await ProductService.UpdateProfileMaterialWeightAsync(materialId, newWeight);
        if (result.Success)
        {
            EditingWeightProfileCode = null;
        }
        else
        {
            StatusMessage = StatusMessage.Error(result.ErrorMessage);
        }
    }

    private void BeginEditProfileStockPrice(string profileId, double stockLength, decimal price)
    {
        EditingProfileStockPriceRow = (profileId, stockLength);
        EditingProfileStockPrice = price;
    }

    private async Task HandleUpdateProfileStockPrice(CavityProfileSummary.StockUsage stock, decimal newPrice)
    {
        if (EditingProfileStockPriceRow is null) return;
        var result = await ProductService.AddOrUpdateProfileMaterialBasePriceAsync(
            EditingProfileStockPriceRow.Value.ProfileId,
            EditingProfileStockPriceRow.Value.StockLength,
            stock.StockId, newPrice);
        if (result.Success)
        {
            stock.UnitPrice = newPrice;
            EditingProfileStockPriceRow = null;
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private void BeginEditGlassStockPrice(string glassId, double stockWidth, double stockLength, decimal price)
    {
        EditingGlassStockPriceRow = (glassId, stockWidth, stockLength);
        EditingGlassStockPrice = price;
    }

    private async Task HandleUpdateGlassStockPrice(CavityGlassSummary.GlassCut cut, decimal newPrice)
    {
        if (EditingGlassStockPriceRow is null) return;
        var result = await ProductService.AddOrUpdateGlassMaterialBasePriceAsync(
            EditingGlassStockPriceRow.Value.GlassId,
            EditingGlassStockPriceRow.Value.StockWidth,
            EditingGlassStockPriceRow.Value.StockLength,
            cut.StockId, newPrice);
        if (result.Success)
        {
            cut.UnitPrice = newPrice;
            EditingGlassStockPriceRow = null;
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private void BeginEditOtherMaterialStockPrice(string matId, decimal price)
    {
        EditingOtherMaterialStockPriceRow = matId;
        EditingOtherMaterialStockPrice = price;
    }

    private async Task HandleUpdateOtherMaterialStockPrice(CavityOtherMaterialSummary mat, decimal newPrice)
    {
        if (EditingOtherMaterialStockPriceRow is null) return;
        var result = await ProductService.AddOrUpdateOtherMaterialBasePriceAsync(
            EditingOtherMaterialStockPriceRow,
            mat.Stock.Id,
            newPrice);
        if (result.Success)
        {
            mat.UnitPrice = newPrice;
            EditingOtherMaterialStockPriceRow = null;
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task HandleSendMaterialRequest()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (!int.TryParse(authState.User.FindFirst(ClaimTypes.NameIdentifier)!.Value, out var userId)) return;
        var planning = new MaterialPlanning { UserId = userId, ProjectId = ProjectId };
        foreach (var p in Profiles)
        {
            foreach (var su in p.StockUsages)
            {
                if (su.Need <= 0) continue;
                planning.Details.Add(new()
                {
                    Material = p,
                    Length = su.StockLength,
                    Quantity = su.Need,
                    Unit = "mm"
                });
            }
        }
        foreach (var g in Glasses)
        {
            foreach (var cut in g.Cuts)
            {
                if (cut.Need <= 0) continue;
                planning.Details.Add(new()
                {
                    Material = g,
                    Length = cut.Length,
                    Width = cut.Width,
                    Quantity = cut.Need,
                    Unit = "mm"
                });
            }
        }
        foreach (var m in OtherMaterials)
        {
            var missing = m.GasketLength is null ? m.Need : m.NeedGasketLength;
            if (missing <= 0) continue;
            planning.Details.Add(new MaterialPlanningDetails
            {
                Material = m,
                Length = m.GasketLength is null ? 0 : m.NeedGasketLength,
                Width = 0,
                Quantity = m.GasketLength is null ? m.Need : 1,
                Unit = m.Unit ?? ""
            });
        }
        var result = await ProductService.CreateMaterialPlanningAsync(planning);
        if (result.Success) StatusMessage = StatusMessage.Success("Tạo yêu cầu thành công");
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task HandleCalculateQuotation()
    {
        var result = await ProductService.CalculateQuotationAsync(ProjectId, LaborCost, ProfitPercentage, TaxPercentage, TransportCost, Contingency);
        if (result.Success) Quotation = result.Quotation;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private sealed class SummarizeAluminumModel
    {
        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Độ dài lõi thép phải lớn hơn 0")]
        public int StockLength { get; set; } = 6000;
    }

    private sealed class UpdateCavityModel
    {
        [Required(ErrorMessage = "Mã cửa là bắt buộc")]
        public string Code { get; set; } = string.Empty;

        public string? Description { get; set; }

        public string? Location { get; set; }
    }
}
