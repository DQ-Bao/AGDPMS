@page "/projects/{ProjectId:int}"
@implements IDisposable

@using AGDPMS.Shared.Models
@using AGDPMS.Shared.Services
@using System.ComponentModel.DataAnnotations
@using System.Globalization

@inject WStarService WStarService
@inject IProductService ProductService

<div class="mb-3">
    <a href="/projects" class="text-decoration-none d-inline-flex align-items-center text-primary">
        <i class="bi bi-arrow-left me-2 fs-5"></i>
        <span class="fw-semibold">Quay lại</span>
    </a>
</div>
<ul class="nav nav-tabs" id="dtlTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active"
                id="tab-cavity"
                data-bs-toggle="tab"
                data-bs-target="#pane-cavity"
                type="button"
                role="tab"
                aria-controls="pane-cavity"
                aria-selected="true">
            Thông tin cửa
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="tab-materials"
                data-bs-toggle="tab"
                data-bs-target="#pane-materials"
                type="button"
                role="tab"
                aria-controls="pane-materials"
                aria-selected="false">
            Tổng hợp vật liệu
        </button>
    </li>
</ul>
<div class="tab-content" id="dtlTabsContent">
    <div class="tab-pane fade show active" id="pane-cavity" role="tabpanel" aria-labelledby="tab-cavity">
        <div class="mt-3">
            <StatusMessageAlert Message="@StatusMessage" AdditionalClasses="mb-2" />
            <div class="mb-3 d-flex align-items-center">
                <div class="input-group w-auto me-2">
                    <label class="input-group-text fw-semibold">Nhập thiết kế Wstar</label>
                    <InputFile OnChange="OnInputFileChange" accept=".mdb" class="form-control" />
                    @if (!IsWStarFileLoading && !IsAddingCavitiesFromWStar && UploadedFilePath is not null)
                    {
                        <button type="button" @onclick="LoadWStarProjects" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projModal">
                            Chọn dự án
                        </button>
                    }
                </div>
                @if (IsWStarFileLoading)
                {
                    <div class="spinner-border spinner-border-sm text-primary mx-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                }
                @if (IsAddingCavitiesFromWStar)
                {
                    <div class="d-flex align-items-center mx-2 text-primary">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Đang thêm cửa...</span>
                    </div>
                }
                <button type="button" class="btn btn-primary">Báo giá</button>
            </div>
            <DataTable TItem="Cavity" TEdit="UpdateCavityModel" Items="Cavities" SearchBy="@(c => c.Description)"
                       EnableEditing="true"
                       EditModelFactory="@(c => new UpdateCavityModel { Code = c.Code, Description = c.Description, Location = c.Location })"
                       OnItemSaved="SaveCavityChange">
                <DataTemplate>
                    <Column Header="Mã cửa">
                        <CellTemplate><td>@context.Code</td></CellTemplate>
                        <EditTemplate>
                            <td>
                                <InputText class="form-control" @bind-Value="context.Code" />
                                <ValidationMessage For="() => context.Code" />
                            </td>
                        </EditTemplate>
                    </Column>
                    <Column Header="Mô tả">
                        <CellTemplate><td>@context.Description</td></CellTemplate>
                        <EditTemplate>
                            <td>
                                <InputText class="form-control" @bind-Value="context.Description" />
                                <ValidationMessage For="() => context.Description" />
                            </td>
                        </EditTemplate>
                    </Column>
                    <Column Header="Vị trí">
                        <CellTemplate><td>@context.Location</td></CellTemplate>
                        <EditTemplate>
                            <td>
                                <InputText class="form-control" @bind-Value="context.Location" />
                                <ValidationMessage For="() => context.Location" />
                            </td>
                        </EditTemplate>
                    </Column>
                    <Column Header="Rộng x Cao (mm)">
                        <CellTemplate><td>@context.Width x @context.Height</td></CellTemplate>
                    </Column>
                    <Column Header="Kiểu cách">
                        <CellTemplate><td>@context.WindowType</td></CellTemplate>
                    </Column>
                    <Column Header="Số lượng">
                        <CellTemplate><td>@context.Quantity bộ</td></CellTemplate>
                    </Column>
                </DataTemplate>
                <ActionTemplate>
                    <a href="/cavities/@context.Id" class="btn btn-primary">Chi tiết</a>
                    <button @onclick="() => CavityToDelete = context" type="button" class="btn btn-danger"
                            data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                        Xóa cửa
                    </button>
                </ActionTemplate>
            </DataTable>
        </div>
    </div>
    <div class="tab-pane fade" id="pane-materials" role="tabpanel" aria-labelledby="tab-materials">
        <div class="mt-3">
            <StatusMessageAlert Message="@StatusMessage" AdditionalClasses="mb-2" />
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingProfile">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProfile"
                            aria-expanded="true" aria-controls="collapseProfile">
                        Profile
                    </button>
                </h2>
                <div id="collapseProfile" class="accordion-collapse collapse show" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <div class="mb-3 d-flex align-items-center">
                            <EditForm Model="Input" OnValidSubmit="LoadProfileSummaries" FormName="summarize-profile-form">
                                <DataAnnotationsValidator />
                                <div class="input-group w-auto me-2">
                                    <label class="input-group-text fw-semibold">Chiều dài cây (mm)</label>
                                    <InputNumber @bind-Value="Input.StockLength" class="form-control" />
                                    <button type="submit" class="btn btn-primary" disabled="@IsLoadingProfileSummaries">Tổng hợp nhôm</button>
                                </div>
                            </EditForm>
                            @if (IsLoadingProfileSummaries)
                            {
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            }
                            <button type="button" class="btn btn-success" disabled="@(!Profiles.Any())">Xuất Excel</button>
                        </div>
                        <div class="fixed-table-wrapper">
                            <table class="table table-bordered table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã profile</th>
                                        <th>Tên profile</th>
                                        <th>Chiều dài cây (mm)</th>
                                        <th>Số cây dùng</th>
                                        <th>Số cây tồn</th>
                                        <th>Cần thêm</th>
                                        <th>Tỷ trọng (kg/m)</th>
                                        <th>Tổng trọng lượng (kg)</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var profile in Profiles)
                                    {
                                        var rows = profile.StockUsages;
                                        var rowSpan = rows.Count;
                                        for (var i = 0; i < rowSpan; i++)
                                        {
                                            var row = rows[i];
                                            <tr>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">@profile.Id</td>
                                                    <td rowspan="@rowSpan">@profile.Name</td>
                                                }
                                                <td>@row.StockLength</td>
                                                <td>@row.Used</td>
                                                <td>@row.InStock</td>
                                                <td>@row.Need</td>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">
                                                        @if (EditingWeightProfileCode == profile.Id)
                                                        {
                                                            <InputNumber @bind-Value="profile.Weight"
                                                                         step="0.001"
                                                                         @onblur="() => HandleMaterialWeightChange(profile.Id, profile.Weight)"
                                                                         class="form-control" />
                                                        }
                                                        else
                                                        {
                                                            <span @onclick="() => EditingWeightProfileCode = profile.Id">
                                                                @profile.Weight.ToString("N2")
                                                            </span>
                                                        }
                                                    </td>
                                                    <td rowspan="@rowSpan">@profile.TotalWeight.ToString("N2")</td>
                                                }
                                                <td>
                                                    @if (EditingProfileStockPriceRow == (profile.Id, row.StockLength))
                                                    {
                                                        <div class="input-group">
                                                            <InputNumber @bind-Value="EditingProfileStockPrice"
                                                                         @onblur="() => HandleUpdateProfileStockPrice(row, EditingProfileStockPrice)"
                                                                         class="form-control" />
                                                            <span class="input-group-text">₫</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span @onclick="() => BeginEditPrice(profile.Id, row.StockLength, row.UnitPrice)">
                                                            @row.UnitPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))
                                                        </span>
                                                    }
                                                </td>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">@profile.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                                    <td rowspan="@rowSpan">
                                                        <button @onclick="() => ShowCuts(profile)" type="button"
                                                                class="btn btn-sm btn-outline-primary me-1"
                                                                data-bs-toggle="modal" data-bs-target="#profileCutsModal">
                                                            KT cắt
                                                        </button>
                                                        <button @onclick="() => ShowSolutions(profile)" type="button"
                                                                class="btn btn-sm btn-outline-success"
                                                                data-bs-toggle="modal" data-bs-target="#profileCutSolutionsModal">
                                                            Tối ưu cắt
                                                        </button>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="7">Tổng cộng</td>
                                        <td>@Profiles.Sum(p => p.TotalWeight).ToString("N2") kg</td>
                                        <td></td>
                                        <td>@Profiles.Sum(p => p.TotalPrice).ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingGlass">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGlass"
                            aria-expanded="true" aria-controls="collapseGlass">
                        Kính
                    </button>
                </h2>
                <div id="collapseGlass" class="accordion-collapse collapse" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <div class="fixed-table-wrapper">
                            <table class="table table-bordered table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã kính</th>
                                        <th>Tên kính</th>
                                        <th>Kích thước</th>
                                        <th>Số tấm</th>
                                        <th>Số tấm tồn</th>
                                        <th>Cần thêm</th>
                                        <th>Tổng chu vi (m)</th>
                                        <th>Tổng diện tích (m2)</th>
                                        <th>Màu sắc</th>
                                        <th>Cửa</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var glass in Glasses)
                                    {
                                        var rowSpan = glass.Cuts.Count;
                                        for (var i = 0; i < rowSpan; i++)
                                        {
                                            <tr>
                                                @if (i == 0)
                                                {
                                                    <td rowspan="@rowSpan">@glass.Code</td>
                                                    <td rowspan="@rowSpan">@glass.Name</td>
                                                }
                                                <td>@glass.Cuts[i].Width x @glass.Cuts[i].Length</td>
                                                <td>@glass.Cuts[i].Quantity</td>
                                                <td>@glass.Cuts[i].Stock</td>
                                                <td>@glass.Cuts[i].Need</td>
                                                <td>@glass.Cuts[i].TotalPerimeter</td>
                                                <td>@glass.Cuts[i].TotalSize</td>
                                                <td>@glass.Cuts[i].Color</td>
                                                <td>@string.Join(",", glass.Cuts[i].CavityCodes)</td>
                                                @if (i == 0)
                                                {
                                                    <td>@glass.UnitPrice</td>
                                                    <td>@glass.TotalPrice</td>
                                                    <td></td>
                                                }
                                            </tr>
                                        }
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="6">Tổng cộng</td>
                                        <td>@Glasses.Sum(g => g.TotalPerimeter)</td>
                                        <td>@Glasses.Sum(g => g.TotalSize)</td>
                                        <td colspan="3"></td>
                                        <td>@Glasses.Sum(p => p.TotalPrice).ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingGasket">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGasket"
                            aria-expanded="true" aria-controls="collapseGasket">
                        Vật tư khác
                    </button>
                </h2>
                <div id="collapseGasket" class="accordion-collapse collapse" data-bs-parent="#materialsAccordion">
                    <div class="accordion-body">
                        <div class="fixed-table-wrapper">
                            <table class="table table-bordered table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã vật liệu</th>
                                        <th>Tên vật liệu</th>
                                        <th>Kích thước</th>
                                        <th>Số lượng</th>
                                        <th>Đơn vị</th>
                                        <th>Tồn</th>
                                        <th>Cần thêm</th>
                                        <th>Màu sắc</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var mat in OtherMaterials)
                                    {
                                        <tr>
                                            <td>@mat.Code</td>
                                            <td>@mat.Name</td>
                                            @if (mat.Gasket is not null)
                                            {
                                                <td>@mat.Gasket.Length</td>
                                                <td>@mat.Quantity</td>
                                                <td>@mat.Unit</td>
                                                <td>@mat.Gasket.StockLength</td>
                                                <td>@mat.Gasket.NeedLength</td>
                                            }
                                            else
                                            {
                                                <td></td>
                                                <td>@mat.Quantity</td>
                                                <td>@mat.Unit</td>
                                                <td>@mat.Stock</td>
                                                <td>@mat.Need</td>
                                            }
                                            <td>@mat.Color</td>
                                            @if (mat.Gasket is not null)
                                            {
                                                <td>@mat.Gasket.PricePerMeter.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn")) / @mat.Unit</td>
                                                <td>@mat.Gasket.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                            }
                                            else
                                            {
                                                <td>@mat.UnitPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                                <td>@mat.TotalPrice.ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                            }
                                            <td></td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr>
                                        <td colspan="9">Tổng cộng</td>
                                        <td>@OtherMaterials.Sum(p => p.TotalPrice).ToString("C", CultureInfo.CreateSpecificCulture("vi-vn"))</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<SelectWStarCavitiesModal @ref="SelectModal" ModalId="projModal" Projects="WStarProjects" OnConfirm="AddSelectedCavities" />
<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa cửa <strong>@CavityToDelete?.Code</strong> không?<br />
                Hành động này không thể hoàn tác.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteAsync" data-bs-dismiss="modal">Xóa</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="profileCutsModal" tabindex="-1" aria-labelledby="profileCutsModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Kích thước cắt - @SelectedProfile?.Id</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CloseModals"></button>
            </div>
            <div class="modal-body">
                @if (SelectedCuts is not null)
                {
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Chiều dài (mm)</th>
                                <th>Số lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cut in SelectedCuts)
                            {
                                <tr>
                                    <td>@cut.CutLength</td>
                                    <td>@cut.Quantity</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">Không có dữ liệu.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModals">Đóng</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="profileCutSolutionsModal" tabindex="-1" aria-labelledby="profileCutSolutionsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Tối ưu cắt - @SelectedProfile?.Id</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" @onclick="CloseModals"></button>
            </div>
            <div class="modal-body">
                @if (SelectedSolutions is not null)
                {
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Chiều dài cây (mm)</th>
                                <th>Số cây</th>
                                <th>Giải pháp</th>
                                <th>Đoạn thừa (mm)</th>
                                <th>Hiệu suất (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var sol in SelectedSolutions)
                            {
                                <tr>
                                    <td>@sol.StockLength</td>
                                    <td>@sol.Quantity</td>
                                    <td>
                                        @foreach (var p in sol.Pattern)
                                        {
                                            <span class="badge bg-light text-dark border me-1">
                                                @p.CutLength × @p.Quantity
                                            </span>
                                        }
                                    </td>
                                    <td>@sol.Waste</td>
                                    <td>@sol.Efficiency</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center">Không có dữ liệu.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" @onclick="CloseModals">Đóng</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int ProjectId { get; set; }

    [SupplyParameterFromForm]
    private SummarizeAluminumModel Input { get; set; } = new();

    private StatusMessage? StatusMessage { get; set; }
    private string? UploadedFilePath;
    private IEnumerable<WStarProject> WStarProjects = [];
    private IEnumerable<Cavity> Cavities = [];
    private IEnumerable<CavityProfileSummary> Profiles = [];
    private IEnumerable<CavityGlassSummary> Glasses = [];
    private IEnumerable<CavityOtherMaterialSummary> OtherMaterials = [];
    private CavityProfileSummary? SelectedProfile;
    private List<CavityProfileSummary.ProfileCut>? SelectedCuts;
    private List<CavityProfileSummary.CutSolution>? SelectedSolutions;

    private SelectWStarCavitiesModal? SelectModal;
    private Cavity? CavityToDelete;

    private bool IsWStarFileLoading { get; set; } = false;
    private bool IsAddingCavitiesFromWStar { get; set; } = false;
    private bool IsLoadingProfileSummaries { get; set; } = false;

    private string? EditingWeightProfileCode { get; set; }
    private (string ProfileId, double StockLength)? EditingProfileStockPriceRow { get; set; }
    private decimal EditingProfileStockPrice { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectCavities();
    }

    private async Task LoadProjectCavities()
    {
        var result = await ProductService.GetProjectCavitiesAsync(ProjectId);
        if (result.Success)
        {
            Cavities = result.Cavities;
            // await LoadProfileSummaries();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task LoadProfileSummaries()
    {
        IsLoadingProfileSummaries = true;
        var result = await ProductService.GetCavityProfileSummariesAsync(ProjectId, Input.StockLength);
        IsLoadingProfileSummaries = false;
        if (result.Success) Profiles = result.Summaries;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        IsWStarFileLoading = true;
        var file = e.File;
        if (file is null || !file.Name.EndsWith(".mdb", StringComparison.OrdinalIgnoreCase))
        {
            UploadedFilePath = null;
            StatusMessage = StatusMessage.Error("File không tồn tại hoặc không đúng định dạng");
            return;
        }
        var tempFile = Path.Combine(Path.GetTempPath(), file.Name);
        using var stream = File.Create(tempFile);
        await file.OpenReadStream(1024 * 1024 * 1024).CopyToAsync(stream);
        UploadedFilePath = tempFile;
        IsWStarFileLoading = false;
    }

    private async Task LoadWStarProjects()
    {
        if (SelectModal is not null) SelectModal.SetLoading(true);
        var result = await WStarService.GetAllProjectAsync(UploadedFilePath);
        if (result.Success) WStarProjects = result.Projects;
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
        if (SelectModal is not null) SelectModal.SetLoading(false);
    }

    private async Task AddSelectedCavities(IEnumerable<WStarCavity> selectedCavities)
    {
        IsAddingCavitiesFromWStar = true;
        var result = await ProductService.AddCavitiesFromWStarDesignAsync(ProjectId, selectedCavities);
        IsAddingCavitiesFromWStar = false;
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success("Thêm cửa thành công");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task ConfirmDeleteAsync()
    {
        if (CavityToDelete is null) return;
        var result = await ProductService.DeleteCavityAsync(CavityToDelete.Id);
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success($"Đã xóa cửa {CavityToDelete.Code}");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
        CavityToDelete = null;
    }

    private void ShowCuts(CavityProfileSummary profile)
    {
        SelectedProfile = profile;
        SelectedCuts = profile.Cuts;
        SelectedSolutions = null;
    }

    private void ShowSolutions(CavityProfileSummary profile)
    {
        SelectedProfile = profile;
        SelectedSolutions = profile.CutSolutions;
        SelectedCuts = null;
    }

    private void CloseModals()
    {
        SelectedCuts = null;
        SelectedSolutions = null;
        SelectedProfile = null;
    }

    public void Dispose()
    {
        try
        {
            if (!string.IsNullOrEmpty(UploadedFilePath) && File.Exists(UploadedFilePath))
            {
                File.Delete(UploadedFilePath);
                UploadedFilePath = null;
            }
        }
        catch {}
    }

    private async Task SaveCavityChange(UpdateCavityModel input, Cavity cavity)
    {
        cavity.Code = input.Code;
        cavity.Description = input.Description;
        cavity.Location = input.Location;
        var result = await ProductService.UpdateCavityAsync(cavity);
        if (result.Success)
        {
            StatusMessage = StatusMessage.Success($"Cập nhật cửa {cavity.Code} thành công");
            await LoadProjectCavities();
        }
        else StatusMessage = StatusMessage.Error(result.ErrorMessage);
    }

    private async Task HandleMaterialWeightChange(string materialId, double newWeight)
    {
        var result = await ProductService.UpdateProfileMaterialWeightAsync(materialId, newWeight);
        if (result.Success)
        {
            EditingWeightProfileCode = null;
        }
        else
        {
            StatusMessage = StatusMessage.Error(result.ErrorMessage);
        }
    }

    private void BeginEditPrice(string profileId, double stockLength, decimal price)
    {
        EditingProfileStockPriceRow = (profileId, stockLength);
        EditingProfileStockPrice = price;
    }

    private async Task HandleUpdateProfileStockPrice(CavityProfileSummary.StockUsage stock, decimal newPrice)
    {
        if (EditingProfileStockPriceRow is null) return;
        var result = await ProductService.AddOrUpdateProfileMaterialBasePriceAsync(
            EditingProfileStockPriceRow.Value.ProfileId,
            EditingProfileStockPriceRow.Value.StockLength,
            stock.StockId, newPrice);
        if (result.Success)
        {
            stock.UnitPrice = newPrice;
            EditingProfileStockPriceRow = null;
        }
        else
        {
            StatusMessage = StatusMessage.Error(result.ErrorMessage);
        }
    }

    private sealed class SummarizeAluminumModel
    {
        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Độ dài lõi thép phải lớn hơn 0")]
        public int StockLength { get; set; } = 5800;
    }

    private sealed class UpdateCavityModel
    {
        [Required(ErrorMessage = "Mã cửa là bắt buộc")]
        public string Code { get; set; } = string.Empty;

        public string? Description { get; set; }

        public string? Location { get; set; }
    }
}
